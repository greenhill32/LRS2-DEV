<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FLT Job Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    :root {
        --bg:#0d0d0d;
        --card:#1c1c1c;
        --text:#e6e6e6;
        --accent:#0ea5e9;
        --success:#22c55e;
        --danger:#ef4444;
        --border:#333;
    }

    body {
        margin:0;
        background:var(--bg);
        font-family:Arial, sans-serif;
        color:var(--text);
        padding:20px;
    }

    h1 {
        text-align:center;
        margin-bottom:20px;
        color:var(--accent);
        font-size:26px;
    }

    .login-bar {
        text-align:center;
        margin-bottom:16px;
        font-size:15px;
        color:#ccc;
    }

    .job {
        background:var(--card);
        border:1px solid var(--border);
        padding:16px;
        border-radius:12px;
        margin-bottom:14px;
        display:flex;
        flex-direction:column;
        gap:8px;
    }

    .reg {
        font-size:22px;
        font-weight:bold;
    }

    .meta {
        font-size:14px;
        color:#aaa;
    }

    .btn-row {
        display:flex;
        gap:10px;
    }

    button {
        flex:1;
        padding:12px;
        border:none;
        border-radius:8px;
        font-size:16px;
        font-weight:bold;
        cursor:pointer;
        color:white;
    }

    .btn-take { background:var(--accent); }
    .btn-finish { background:var(--success); }
    .btn-disabled { background:#444 !important; opacity:0.5; }

</style>
</head>

<body>

<div class="login-bar">
    Logged in as: <span id="fltName">Loading...</span>
</div>

<h1>FLT Job Board</h1>

<div id="jobList">Loading...</div>

<script>
// SUPABASE
const db = supabase.createClient(
    "https://gtixdparpjdpyhhubsfz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
);

// AUTH CHECK
const opId = localStorage.getItem("operator_id");
const opName = localStorage.getItem("operator_name");

if (!opId) {
    window.location.href = "login.html";
}

document.getElementById("fltName").textContent = opName || "Unknown";

// LOAD JOBS
async function loadJobs() {
    const { data } = await db
        .from("vehicles")
        .select("*")
        .in("status", ["parked", "notified"])
        .order("check_in_time", { ascending:true });

    renderJobs(data || []);
}

// RENDER JOBS
function renderJobs(list) {
    const box = document.getElementById("jobList");
    if (!list.length) {
        box.innerHTML = `
            <div style="text-align:center;color:#777;margin-top:40px;">
                No active jobs
            </div>`;
        return;
    }

    box.innerHTML = list.map(v => {
        const taken = v.loader_id && v.loader_id !== "null";

        return `
            <div class="job">
                <div class="reg">${v.registration || "-"}</div>
                <div class="meta">PO: ${v.po_ref || "-"}</div>
                <div class="meta">Status: ${v.status}</div>
                <div class="meta">Notes: ${v.notes || "-"}</div>

                <div class="btn-row">
                    <button 
                        class="btn-take ${taken ? "btn-disabled" : ""}"
                        onclick="takeJob('${v.id}')"
                        ${taken ? "disabled" : ""}>
                        Take Job
                    </button>

                    <button 
                        class="btn-finish ${!taken ? "btn-disabled" : ""}"
                        onclick="finishJob('${v.id}')"
                        ${!taken ? "disabled" : ""}>
                        Finish
                    </button>
                </div>
            </div>
        `;
    }).join("");
}

// TAKE JOB
async function takeJob(id) {
    const opId = localStorage.getItem("operator_id");
    const opName = localStorage.getItem("operator_name") || "FLT";

    await db.from("vehicles").update({
        loader_id: opId
    }).eq("id", id);

    await db.from("actions_log").insert({
        vehicle_id:id,
        operator_id:opId,
        action:"flt_take",
        details: opName + " took job",
        timestamp:new Date().toISOString()
    });

    loadJobs();
}

// FINISH JOB
async function finishJob(id) {
    const opId = localStorage.getItem("operator_id");
    const opName = localStorage.getItem("operator_name") || "FLT";

    await db.from("vehicles").update({
        status:"released",
        release_time:new Date().toISOString()
    }).eq("id", id);

    await db.from("actions_log").insert({
        vehicle_id:id,
        operator_id:opId,
        action:"flt_finish",
        details: opName + " completed job",
        timestamp:new Date().toISOString()
    });

    loadJobs();
}

// INITIAL + AUTO REFRESH
loadJobs();
setInterval(loadJobs, 5000);

</script>

</body>
</html>
