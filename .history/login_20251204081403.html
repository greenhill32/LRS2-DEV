<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WAIT99 Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    :root {
        --bg: #0d0d0d;
        --card: #1c1c1c;
        --accent: #1b8cff;
        --text: #e6e6e6;
        --muted: #999;
        --danger: #ef4444;
    }

    body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .box {
        background: var(--card);
        padding: 40px;
        width: 380px;
        border-radius: 14px;
        border: 1px solid #303030;
        text-align: center;
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    h2 {
        font-size: 28px;
        margin-bottom: 20px;
        color: var(--accent);
    }

    select, input {
        width: 100%;
        padding: 14px;
        font-size: 18px;
        border-radius: 10px;
        border: 1px solid #444;
        background: #2a2a2a;
        color: var(--text);
        margin-top: 10px;
        box-sizing: border-box;
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--accent);
    }

    button {
        width: 100%;
        padding: 16px;
        margin-top: 30px;
        font-size: 20px;
        border: none;
        background: var(--accent);
        color: white;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
    }

    button:hover:not(:disabled) {
        opacity: 0.85;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .footer {
        margin-top: 20px;
        font-size: 14px;
        color: var(--muted);
    }

    .error {
        color: var(--danger);
        font-size: 14px;
        margin-top: 10px;
        display: none;
    }

    .error.show {
        display: block;
    }

    .version {
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 12px;
        color: var(--muted);
    }
</style>
</head>

<body>

<div class="box">
    <h2>Lorry Park Login</h2>

    <select id="operatorSelect">
        <option value="">-- Select Operator --</option>
    </select>

    <input 
        type="password" 
        id="pinInput" 
        placeholder="Enter PIN" 
        maxlength="6"
        autocomplete="off"
    >

    <div class="error" id="errorMsg"></div>

    <button onclick="login()" id="loginBtn">Enter Dashboard</button>

    <div class="footer">All actions are logged and audited.</div>
</div>

<div class="version">v4.0.0</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient(
  "https://gtixdparpjdpyhhubsfz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
);

// Load operators on page load
async function loadOperators() {
    try {
        const { data, error } = await db
            .from("operators")
            .select("id, name, role")
            .eq("active", true)
            .order("name");

        if (error) throw error;

        const sel = document.getElementById("operatorSelect");
        sel.innerHTML = "<option value=''>-- Select Operator --</option>";

        data.forEach(op => {
            sel.innerHTML += `<option value="${op.id}" data-role="${op.role}">${op.name}</option>`;
        });
    } catch (err) {
        showError("Failed to load operators: " + err.message);
    }
}

// Login function
async function login() {
    const operatorId = document.getElementById("operatorSelect").value;
    const pin = document.getElementById("pinInput").value.trim();
    const errorMsg = document.getElementById("errorMsg");
    const loginBtn = document.getElementById("loginBtn");

    // Clear previous error
    errorMsg.classList.remove("show");

    // Validate inputs
    if (!operatorId) {
        showError("Please select an operator");
        return;
    }

    if (!pin) {
        showError("Please enter your PIN");
        return;
    }

    // Disable button during login
    loginBtn.disabled = true;
    loginBtn.textContent = "Logging in...";

    try {
        // Call login RPC function
        const { data, error } = await db.rpc('login_operator', {
            p_operator_id: operatorId,
            p_pin_code: pin
        });

        if (error) throw error;

        // Check if login was successful
        if (!data.success) {
            showError(data.error || "Login failed");
            loginBtn.disabled = false;
            loginBtn.textContent = "Enter Dashboard";
            return;
        }

        // Store session info in localStorage
        localStorage.setItem('session_token', data.token);
        localStorage.setItem('operator_id', data.operator_id);
        localStorage.setItem('operator_name', data.name);
        localStorage.setItem('operator_role', data.role);

        // Redirect based on role
        if (data.role === 'supervisor') {
            window.location.href = 'supervisor.html';
        } else {
            window.location.href = 'index.html';
        }

    } catch (err) {
        showError("Login error: " + err.message);
        loginBtn.disabled = false;
        loginBtn.textContent = "Enter Dashboard";
    }
}

// Show error message
function showError(message) {
    const errorMsg = document.getElementById("errorMsg");
    errorMsg.textContent = message;
    errorMsg.classList.add("show");
}

// Allow Enter key to submit
document.getElementById("pinInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        login();
    }
});

// Auto-focus PIN input when operator is selected
document.getElementById("operatorSelect").addEventListener("change", function() {
    if (this.value) {
        document.getElementById("pinInput").focus();
    }
});

// Load operators on page load
loadOperators();
</script>

</body>
</html>