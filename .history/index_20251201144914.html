<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gatehouse Dashboard</title>
<div id="versionBanner"></div>

<script>
document.getElementById("versionBanner").innerText = "v4.0.0 - THEMED";
</script>

<style>
    /* 1. SHARED TOKENS (Colors that work on both modes) */
    :root {
        --accent: #0ea5e9;
        --success: #22c55e;
        --warn: #fbbf24;
        --danger: #ef4444;
        --purple: #8b5cf6;
    }

    /* 2. LIGHT MODE CONFIG */
    [data-theme="light"] {
        --bg: #f1f5f9;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #cbd5e1;
    }

    /* 3. DARK MODE CONFIG */
    [data-theme="dark"] {
        --bg: #0e1420;
        --card: #1f2937;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --border: #334155;
    }

    /* 4. ANIMATIONS */
    body, .tile, .queue, .details, header, input, select, textarea, .slide-panel, #editModal {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    /* Export load styling */
    .queue-export {
        background: linear-gradient(
            90deg,
            rgba(14,165,233,0.25),
            rgba(14,165,233,0.08)
        ) !important;
        box-shadow: 0 0 16px rgba(14,165,233,0.5);
        animation: exportPulse 2.4s infinite ease-in-out;
    }

    @keyframes exportPulse {
        0%, 100% { box-shadow: 0 0 16px rgba(14,165,233,0.5); }
        50% { box-shadow: 0 0 24px rgba(14,165,233,0.8); }
    }
    
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
    }
    
    header {
        background: var(--card);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--border);
    }

    .header-left {
        flex: 1;
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
    }
    
    .header-clock {
        flex: 1;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        color: var(--text);
    }
    
    .header-right {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    #avatarBtn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: var(--bg);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--accent);
        cursor: pointer;
        user-select: none;
    }
    
    #avatarMenu {
        position: absolute;
        top: 48px;
        right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        min-width: 150px;
        padding: 4px 0;
        display: none;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    #avatarMenu > div {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
    }
    
    #avatarMenu > div:hover {
        background: var(--accent);
        color: #000;
    }

    .entry {
        cursor: pointer;
    }

    /* Modal Styling */
    #editModalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        z-index: 10000;
    }
    
    #editModal {
        background: var(--card);
        color: var(--text);
        width: 420px;
        margin: 80px auto;
        padding: 24px;
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    
    #editModal label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-size: 14px;
    }
    
    #editModal input,
    #editModal textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg);
        color: var(--text);
        font-size: 14px;
    }
    
    #editModal textarea {
        resize: vertical;
        height: 80px;
    }
    
    #editModal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 16px;
    }
    
    #editModal .modal-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
    }
    
    #editModal .modal-actions .cancel-btn {
        background: #475569;
        color: #fff;
    }
    
    #editModal .modal-actions .save-btn {
        background: var(--accent);
        color: #000;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        padding: 24px;
    }
    
    .tile {
        background: var(--card);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    
    .tile .value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 4px;
        color: var(--accent);
    }
    
    .grid {
        display: flex;
        flex-direction: row;
        gap: 24px;
        padding: 0 24px 24px;
    }
    
    .queue, .details {
        flex: 1;
        background: var(--card);
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 16px;
        min-height: 420px;
        overflow-y: auto;
    }
    
    .queue h2, .details h2 {
        margin-top: 0;
        color: var(--accent);
        font-size: 20px;
    }
    
    .entry {
        background: rgba(14,165,233,0.05); /* Slight tint for default entries */
        border: 1px solid var(--border);
        border-left: 22px solid var(--success);
        padding: 24px;
        margin-bottom: 12px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .entry.overdue {
        border-left-color: var(--warn);
    }
    
    .entry.critical {
        border-left-color: var(--danger);
    }
    
    .entry .info {
        flex: 1;
    }
    
    .entry .actions button {
        margin-left: 6px;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .entry .actions .notify { background: var(--warn); color: #000; }
    .entry .actions .release { background: var(--success); color: #000; }
    .entry .actions .undo { background: var(--danger); color: #fff; }
    
    .activity-item {
        margin-bottom: 8px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 4px;
        font-size: 14px;
    }
    
    .add-btn {
        background: var(--accent);
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        margin-right: 8px;
    }
    
    /* Slide Panel CSS */
    .slide-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        min-height: 320px;
        background: var(--card);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        padding: 20px 24px;
        transform: translateY(calc(-100% - 40px));
        transition: transform 0.4s ease;
        z-index: 1000;
        color: var(--text);
        border-bottom: 1px solid var(--border);
    }
    
    .panel-visible {
        transform: translateY(0);
    }
    
    .panel-title {
        font-size: 20px;
        color: var(--accent);
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .form-row {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }
    
    .slide-panel input,
    .slide-panel textarea,
    .slide-panel select {
        padding: 10px;
        flex: 1;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        background: var(--bg);
        color: var(--text);
    }
    
    .submit-btn {
        padding: 10px 16px;
        background: var(--accent);
        color: #fff;
        border-radius: 6px;
        margin-top: 12px;
        cursor: pointer;
        text-align: center;
        font-weight: bold;
    }
    
    .connection-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        margin-right: 8px;
    }
    
    .connection-status.disconnected {
        background: var(--danger);
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Navigation */
    .main-nav {
        background: #1e3a5f;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid var(--border);
    }
    
    .main-nav a {
        color: #e2e8f0;
        text-decoration: none;
        padding: 14px 24px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.2s;
    }
    
    .main-nav a:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .main-nav a.active {
        background: rgba(255,255,255,0.15);
        color: #fff;
    }
    
    .nav-divider {
        color: #64748b;
        font-size: 18px;
        user-select: none;
    }
</style>
</head>

<body>
    <div id="addPanel" class="slide-panel">
        <div class="panel-title">Add New Lorry</div>
        <div class="form-row">
            <input type="text" id="haulierInput" placeholder="Haulier / Lorry Company" style="width:100%;">
        </div>
        <div class="form-row">
            <select id="prebookSelect" onchange="applyPrebook()" style="width:100%;">
                <option value="">-- Select Expected Load --</option>
            </select>
        </div>
        <div class="form-row">
            <input type="text" id="regInput" placeholder="Registration">
            <input type="text" id="poInput" placeholder="PO / Reference">
        </div>
        <div class="form-row">
            <input type="text" id="mobileInput" placeholder="Mobile Number">
            <select id="quotedInput">
                <option value="30">30 mins</option>
                <option value="45">45 mins</option>
                <option value="60" selected>60 mins</option>
                <option value="90">90 mins</option>
                <option value="120">120 mins</option>
            </select>
        </div>
        <div class="form-row">
            <textarea id="notesInput" placeholder="Notes" style="width:100%;height:80px;"></textarea>
        </div>
        <div class="form-row">
            <label style="color:var(--text);">
                <input type="checkbox" id="addExport" style="margin-right:6px;">
                Export Load
            </label>
        </div>
        <div class="submit-btn" onclick="submitVehicle()">Submit</div>
    </div>
    
    <header>
        <div class="header-left">
            <span class="connection-status" id="connectionStatus" title="Realtime connection"></span>
            Gatehouse Dashboard
        </div>
        <div id="clock" class="header-clock">--:--</div>
        <div class="header-right">
            <button class="add-btn" onclick="togglePanel()">Add Lorry</button>
            <button id="refreshBtn" style="padding:8px 16px;font-size:14px;background:var(--accent);color:#fff;border:none;border-radius:4px;" onclick="manualRefresh()">Refresh</button>
            <div style="position: relative;">
                <div id="avatarBtn">??</div>
                
                <!-- THEME SWITCHER MENU -->
                <div id="avatarMenu">
                    <div id="menuName" style="border-bottom:1px solid var(--border); margin-bottom:5px;">Loading</div>
                    
                    <div style="font-size:12px; color:var(--muted); padding: 4px 12px;">Appearance</div>
                    <div onclick="setTheme('light')" style="display:flex; justify-content:space-between;">
                        <span>&#9728; Light</span>
                        <span id="check-light" style="display:none;">&#10003;</span>
                    </div>
                    <div onclick="setTheme('dark')" style="display:flex; justify-content:space-between;">
                        <span>&#9790; Dark</span>
                        <span id="check-dark" style="display:none;">&#10003;</span>
                    </div>
                    <hr style="border:0; border-top:1px solid var(--border); margin:4px 0;">
                    
                    <div onclick="logoutUser()">Logout</div>
                </div>
            </div>
        </div>
    </header>
    
    <nav class="main-nav">
        <a href="arrivals.html">ARRIVALS</a>
        <span class="nav-divider">|</span>
        <a href="index.html" class="active">QUEUE</a>
        <span class="nav-divider">|</span>
        <a href="supervisor.html">SUPERVISOR</a>
    </nav>
    
    <div class="stats">
        <div class="tile">
            <div class="value" id="kpiTotalIn">0</div>
            Checked In
        </div>
        <div class="tile">
            <div class="value" id="kpiTotalOut">0</div>
            Released Today
        </div>
        <div class="tile">
            <div class="value" id="kpiAvgWait">0</div>
            Avg Wait (m)
        </div>
        <div class="tile">
            <div class="value" id="kpiOverdue">0</div>
            Overdue >30m
        </div>
    </div>
    
    <div class="grid">
        <div class="queue">
            <h2>Active Queue</h2>
            <div id="queueList">Loading...</div>
        </div>
        <div class="details">
            <h2>Recent Activity</h2>
            <div id="activityList">Loading...</div>
        </div>
    </div>
    
    <canvas id="chartTrend" style="max-width:600px;height:240px;max-height:240px;margin:0 auto 24px;display:block;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    const db = supabase.createClient(
        "https://gtixdparpjdpyhhubsfz.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
    );

    let vehicles = [];
    let operators = [];
    let logs = [];
    let chart;
    let refreshTimeout = null;
    let prebookCache = [];
    let prebookExportFlag = false;
    let vehicleCache = {};

    (function loadCachedOperators() {
        try {
            const cached = localStorage.getItem('operators_cache');
            if (cached) operators = JSON.parse(cached);
        } catch (e) {}
    })();

    // PARALLEL FETCH - ALL DATA LOADS SIMULTANEOUSLY
    async function fetchAllData() {
        const performanceStart = performance.now();
        
        // Execute all fetches in parallel using Promise.all
        const [statsResult, vehiclesResult, logsResult, operatorsResult] = await Promise.all([
            // 1. RPC for stats (single query)
            db.rpc('get_dashboard_stats'),
            
            // 2. Vehicles with logs prefetched
            db.from('vehicles')
                .select('*')
                .in('status', ['parked', 'notified'])
                .order('check_in_time', { ascending: true }),
            
            // 3. Recent logs (24hr)
            db.from('actions_log')
                .select('*')
                .gte('timestamp', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
                .order('timestamp', { ascending: false })
                .limit(20),
            
            // 4. Operators (only if cache empty)
            operators.length === 0 
                ? db.from('operators').select('id, name').eq('active', true)
                : Promise.resolve({ data: operators, error: null })
        ]);

        const performanceEnd = performance.now();
        console.log(`Data fetch completed in ${Math.round(performanceEnd - performanceStart)}ms`);

        // Handle results
        if (statsResult.data) {
            updateKPIsFromRPC(statsResult.data);
        }

        if (vehiclesResult.data) {
            vehicles = vehiclesResult.data;
            renderQueue();
            loadChart();
        }

        if (logsResult.data) {
            logs = logsResult.data;
            
            // Prefetch missing vehicle details
            const missingIds = logs
                .map(l => l.vehicle_id)
                .filter(id => id && !vehicles.find(v => v.id === id) && !vehicleCache[id]);
            
            if (missingIds.length > 0) {
                const { data: missingVehicles } = await db
                    .from('vehicles')
                    .select('id, registration, po_ref')
                    .in('id', [...new Set(missingIds)]);
                
                if (missingVehicles) {
                    missingVehicles.forEach(v => {
                        vehicleCache[v.id] = v;
                    });
                }
            }
            
            renderActivity();
        }

        if (operatorsResult.data && operators.length === 0) {
            operators = operatorsResult.data;
            try {
                localStorage.setItem('operators_cache', JSON.stringify(operators));
            } catch (e) {}
        }
    }

    // Update KPIs from RPC response
    function updateKPIsFromRPC(stats) {
        document.getElementById('kpiTotalIn').textContent = stats.in_yard || 0;
        document.getElementById('kpiTotalOut').textContent = stats.released_today || 0;
        document.getElementById('kpiAvgWait').textContent = stats.avg_wait_mins || 0;
        document.getElementById('kpiOverdue').textContent = stats.overdue_count || 0;
    }

    function setupRealtime() {
        const statusEl = document.getElementById('connectionStatus');
        
        db.channel('vehicles-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'vehicles' },
                (payload) => {
                    console.log('Vehicle change:', payload.eventType);
                    debouncedRefresh();
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    statusEl.classList.remove('disconnected');
                    statusEl.title = 'Connected - Live updates';
                } else {
                    statusEl.classList.add('disconnected');
                    statusEl.title = 'Disconnected - Reconnecting';
                }
            });

        db.channel('logs-changes')
            .on('postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'actions_log' },
                (payload) => {
                    console.log('New log entry');
                    debouncedRefresh();
                }
            )
            .subscribe();
    }

    function debouncedRefresh() {
        if (refreshTimeout) clearTimeout(refreshTimeout);
        refreshTimeout = setTimeout(() => {
            fetchAllData();
        }, 500);
    }

    function renderQueue() {
        const container = document.getElementById('queueList');
        container.innerHTML = '';
        
        if (vehicles.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px;">No vehicles in queue</div>';
            return;
        }
        
        vehicles.forEach(v => {
            const li = document.createElement('div');
            const now = Date.now();
            const dueTime = new Date(v.due_time).getTime();
            const minsLate = Math.floor((now - dueTime) / 60000);
            
            let cls = '';
            if (minsLate > 0) cls = minsLate > 90 ? 'critical' : 'overdue';
            
            const isExport = v.classification === 'export';
            li.className = `entry ${cls} ${isExport ? 'queue-export' : ''}`;
            li.onclick = () => openEditModal(v.id);
            
            li.innerHTML = `
                <div class="info">
                    <strong>${v.registration || '-'}</strong> - ${v.status}<br>
                    PO: ${v.po_ref || '-'} | Mobile: ${v.mobile_number || v.pager_number || '-'}<br>
                    In: ${new Date(v.check_in_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})} | Due: ${v.due_time ? new Date(v.due_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : '-'}
                </div>
                <div class="actions">
                    <button class="notify" onclick="event.stopPropagation(); notify('${v.id}')">Notify</button>
                    <button class="release" onclick="event.stopPropagation(); release('${v.id}')">Release</button>
                    <button class="undo" onclick="event.stopPropagation(); undo('${v.id}')">Undo</button>
                </div>
            `;
            container.appendChild(li);
        });
    }

    function renderActivity() {
        const container = document.getElementById('activityList');
        container.innerHTML = '';
        
        if (logs.length === 0) {
            container.innerHTML = '<div style="color:var(--muted);">No recent activity</div>';
            return;
        }
        
        logs.forEach(l => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            const veh = vehicles.find(v => v.id === l.vehicle_id) || vehicleCache[l.vehicle_id] || {};
            const reg = veh.registration || '';
            const po = veh.po_ref || '';
            
            const op = operators.find(o => o.id === l.operator_id) || {};
            const name = op.name || 'Unknown';
            
            let actionVerb = '';
            switch(l.action) {
                case 'check_in': actionVerb = 'checked in'; break;
                case 'notified': actionVerb = 'notified'; break;
                case 'released': actionVerb = 'completed'; break;
                case 'undo': actionVerb = 'reverted'; break;
                case 'edit': actionVerb = 'edited'; break;
                default: actionVerb = l.action; break;
            }
            
            const dt = new Date(l.timestamp);
            const timeStr = dt.toLocaleString('en-GB', { 
                day:'2-digit', month:'2-digit', 
                hour:'2-digit', minute:'2-digit', second:'2-digit' 
            });
            
            item.textContent = `${reg} ${po} ${actionVerb} by ${name} - ${timeStr}`.trim();
            container.appendChild(item);
        });
    }

    function loadChart() {
        const ctx = document.getElementById('chartTrend').getContext('2d');
        const hours = [];
        const counts = [];
        const now = new Date();
        
        for (let i = 0; i < 12; i++) {
            const h = new Date(now.getTime() - (11 - i) * 60 * 60 * 1000);
            const label = h.getHours().toString().padStart(2, '0') + ':00';
            hours.push(label);
            
            const count = vehicles.filter(v => {
                const ci = new Date(v.check_in_time);
                return ci.getHours() === h.getHours() && 
                       ci.toDateString() === h.toDateString();
            }).length;
            counts.push(count);
        }
        
        if (chart) chart.destroy();
        
        const computedStyles = getComputedStyle(document.documentElement);
        const accent = computedStyles.getPropertyValue('--accent').trim() || '#0ea5e9';
        
        chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: hours, 
                datasets: [{ 
                    label: 'Active vehicles by check-in hour', 
                    data: counts, 
                    borderColor: accent, 
                    backgroundColor: accent + '33', 
                    borderWidth: 2, 
                    tension: 0.3 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { y: { beginAtZero: true } } 
            }
        });
    }

    async function notify(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        
        const { error } = await db.from('vehicles')
            .update({ status: 'notified', notify_time: now })
            .eq('id', id);
        
        if (!error) {
            await db.from('actions_log').insert({ 
                vehicle_id: id, 
                action: 'notified', 
                timestamp: now, 
                operator_id: operator 
            });

            const { data: vehicle } = await db.from('vehicles').select('po_ref, mobile_number').eq('id', id).single();
            const phone = vehicle?.mobile_number || 'N/A';
            const po = vehicle?.po_ref || 'N/A';

            if (phone && phone !== 'N/A') {
                window.open(`sms_simulator.html?type=notified&phone=${encodeURIComponent(phone)}&po=${encodeURIComponent(po)}`,
                    "_blank",
                    "width=400,height=700");
            }

            fetchAllData();
        }
    }

    async function release(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        
        const { data: vehicle } = await db.from('vehicles').select('*').eq('id', id).single();
        
        const { error } = await db.from('vehicles')
            .update({ status: 'released', release_time: now })
            .eq('id', id);
        
        if (!error) {
            await db.from('actions_log').insert({ 
                vehicle_id: id, 
                action: 'released', 
                timestamp: now, 
                operator_id: operator 
            });

            const checkIn = new Date(vehicle.check_in_time);
            const duration = Math.floor((new Date(now) - checkIn) / 60000);
            const phone = vehicle?.mobile_number || 'N/A';
            const po = vehicle?.po_ref || 'N/A';

            if (phone && phone !== 'N/A') {
                window.open(`sms_simulator.html?type=released&phone=${encodeURIComponent(phone)}&po=${encodeURIComponent(po)}&duration=${duration} mins`,
                    "_blank",
                    "width=400,height=700");
            }

            fetchAllData();
        }
    }

    async function undo(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        
        const { error } = await db.from('vehicles')
            .update({ status: 'parked', notify_time: null })
            .eq('id', id);
        
        if (!error) {
            await db.from('actions_log').insert({ 
                vehicle_id: id, 
                action: 'undo', 
                timestamp: now, 
                operator_id: operator 
            });
            fetchAllData();
        }
    }

    function togglePanel() {
        const panel = document.getElementById('addPanel');
        if (!panel) return;
        panel.classList.toggle('panel-visible');
        if (panel.classList.contains('panel-visible')) {
            loadPrebooks();
        }
    }

    async function submitVehicle() {
        const btn = document.querySelector('#addPanel .submit-btn');
        if (!btn) return;
        
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.6';

        let reg = document.getElementById('regInput').value.trim().replace(/\s+/g, '').toUpperCase();
        let po = document.getElementById('poInput').value.trim();
        let haulier = document.getElementById('haulierInput').value.trim();
        let mobileInput = document.getElementById('mobileInput').value.trim();
        let mobile = mobileInput === '' ? null : mobileInput;
        let notes = document.getElementById('notesInput').value.trim();
        let quoted = parseInt(document.getElementById('quotedInput').value, 10);

        if (!reg) {
            alert('Registration required');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            return;
        }

        const operatorId = localStorage.getItem('operator_id') || null;
        const nowIso = new Date().toISOString();
        const dueIso = new Date(Date.now() + quoted * 60000).toISOString();
        const isExport = document.getElementById('addExport').checked;

        try {
            const { data, error } = await db.from('vehicles').insert({
                registration: reg,
                po_ref: po || null,
                haulier: haulier || null,
                mobile_number: mobile,
                notes: notes || null,
                quoted_minutes: quoted,
                check_in_time: nowIso,
                due_time: dueIso,
                status: 'parked',
                operator_id: operatorId,
                classification: isExport ? 'export' : 'normal'
            }).select();
            
            if (error) {
                alert('Error: ' + error.message);
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                return;
            }
            
            const vehicleId = data && data[0] && data[0].id;
            window.open(`qr-screen.html?uid=${vehicleId}`, "_blank");
            
            if (mobile) {
                window.open(
                    `sms_simulator.html?type=check_in&phone=${encodeURIComponent(mobile)}&po=${encodeURIComponent(po || 'N/A')}&quoted=${quoted}`,
                    "_blank",
                    "width=400,height=700"
                );
            }
            
            await db.from('actions_log').insert({
                vehicle_id: vehicleId,
                action: 'check_in',
                timestamp: nowIso,
                operator_id: operatorId
            });

            const selectedPrebookId = document.getElementById('prebookSelect').value;
            if (selectedPrebookId) {
                await db.from('prebookings').update({ consumed: true }).eq('id', selectedPrebookId);
            }
            
            await fetchAllData();
            
            togglePanel();
            document.getElementById('regInput').value = '';
            document.getElementById('poInput').value = '';
            const hInp = document.getElementById('haulierInput');
            if (hInp) hInp.value = '';
            const mInp = document.getElementById('mobileInput');
            if (mInp) mInp.value = '';
            document.getElementById('notesInput').value = '';
            document.getElementById('quotedInput').value = '60';
            document.getElementById('addExport').checked = false;
            const pbSel = document.getElementById('prebookSelect');
            if (pbSel) pbSel.value = '';
            prebookExportFlag = false;
        } finally {
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        }
    }

    async function loadPrebooks() {
        const sel = document.getElementById('prebookSelect');
        if (!sel) return;
        sel.innerHTML = `<option value="">-- Select Expected Load --</option>`;
        try {
            const { data } = await db
                .from('prebookings')
                .select('*')
                .eq('consumed', false)
                .order('expected_date', { ascending: true })
                .order('expected_time', { ascending: true });
            if (!data) return;
            prebookCache = data;
            data.forEach(p => {
                const label = `${p.po_ref || 'No PO'} - ${p.registration || 'No Reg'} - ${p.expected_date || ''} ${p.expected_time?.slice(0,5) || ''}${p.is_export ? ' - EXPORT' : ''}`;
                sel.innerHTML += `<option value="${p.id}">${label}</option>`;
            });
        } catch (err) {
            console.error('Failed to load prebooks', err);
        }
    }

    function applyPrebook() {
        const sel = document.getElementById('prebookSelect');
        if (!sel) return;
        const id = sel.value;
        if (!id) return;
        const pb = prebookCache.find(x => String(x.id) === String(id));
        if (!pb) return;
        const poInput = document.getElementById('poInput');
        const regInput = document.getElementById('regInput');
        const notesInput = document.getElementById('notesInput');
        const haulierInput = document.getElementById('haulierInput');
        if (poInput) poInput.value = pb.po_ref || '';
        if (regInput) regInput.value = pb.registration || '';
        if (notesInput) notesInput.value = pb.notes || '';
        if (haulierInput) haulierInput.value = pb.haulier || '';
        prebookExportFlag = pb.is_export === true;
        const exportChk = document.getElementById('addExport');
        if (exportChk) exportChk.checked = prebookExportFlag;
    }

    function manualRefresh() {
        fetchAllData();
    }

    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', minute: '2-digit', second: '2-digit' 
        });
        const clk = document.getElementById('clock');
        if (clk) clk.textContent = timeStr;
    }

    function logoutUser() {
        localStorage.removeItem('operator_id');
        window.location.href = 'login.html';
    }

    document.addEventListener('click', (e) => {
        const btn = document.getElementById('avatarBtn');
        const menu = document.getElementById('avatarMenu');
        if (!btn || !menu) return;
        if (btn.contains(e.target)) {
            menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
        } else if (!menu.contains(e.target)) {
            menu.style.display = 'none';
        }
    });

    (async () => {
        const opId = localStorage.getItem('operator_id');
        if (!opId) return;
        try {
            const { data: op } = await db.from('operators').select('name').eq('id', opId).single();
            const opName = op?.name || 'Unknown';
            const menuName = document.getElementById('menuName');
            const avatarBtn = document.getElementById('avatarBtn');
            if (menuName) menuName.textContent = opName;
            if (avatarBtn) {
                const initials = opName.split(' ').map(x => (x[0] || '').toUpperCase()).join('').slice(0, 2);
                avatarBtn.textContent = initials || '??';
            }
        } catch (err) {
            console.error('Failed to load operator:', err);
        }
    })();

    let currentEditId = null;
    
    function openEditModal(id) {
        const veh = vehicles.find(v => v.id === id);
        if (!veh) return;
        currentEditId = id;
        
        document.getElementById('editReg').value = veh.registration || '';
        document.getElementById('editPO').value = veh.po_ref || '';
        const editMobile = document.getElementById('editMobile');
        if (editMobile) editMobile.value = veh.mobile_number || veh.pager_number || '';
        document.getElementById('editNotes').value = veh.notes || '';
        document.getElementById('editModalOverlay').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModalOverlay').style.display = 'none';
        currentEditId = null;
    }

    async function saveEditModal() {
        if (!currentEditId) { closeEditModal(); return; }
        
        const regVal = document.getElementById('editReg').value.trim().toUpperCase();
        const poVal = document.getElementById('editPO').value.trim();
        const mobileVal = document.getElementById('editMobile').value.trim();
        const notesVal = document.getElementById('editNotes').value.trim();
        const operatorId = localStorage.getItem('operator_id') || null;
        
        const updates = {
            registration: regVal,
            po_ref: poVal || null,
            mobile_number: mobileVal === '' ? null : mobileVal,
            notes: notesVal || null,
            operator_id: operatorId
        };
        
        try {
            const { error } = await db.from('vehicles').update(updates).eq('id', currentEditId);
            if (error) {
                alert('Error updating record: ' + error.message);
                return;
            }
            
            const nowIso = new Date().toISOString();
            await db.from('actions_log').insert({
                vehicle_id: currentEditId,
                action: 'edit',
                timestamp: nowIso,
                operator_id: operatorId
            });
            
            await fetchAllData();
            closeEditModal();
        } catch (err) {
            console.error('Edit save failed:', err);
            alert('Failed to save changes');
        }
    }
    
    function checkIncomingBooking() {
        const params = new URLSearchParams(window.location.search);
        
        if (params.has('ref')) {
            const panel = document.getElementById('addPanel');
            panel.classList.add('panel-visible');
            
            document.getElementById('poInput').value = params.get('ref');
            
            const haulierBox = document.getElementById('haulierInput');
            if (haulierBox) haulierBox.value = params.get('customer') || '';
            
            let notes = `Booking: #${params.get('ref')}`;
            if (params.get('orders')) notes += `\nOrders: ${params.get('orders')}`;
            if (params.get('pallets')) notes += `\nExpected Pallets: ${params.get('pallets')}`;
            if (params.get('meds') === 'true') notes += `\n*** CONTAINS MEDS ***`;
            
            document.getElementById('notesInput').value = notes;
            
            setTimeout(() => {
                document.getElementById('regInput').focus();
            }, 500);
            
            window.history.replaceState({}, document.title, "index.html");
        }
    }

    // ============================================
    // THEME SWITCHER LOGIC
    // ============================================
    function setTheme(themeName) {
        // 1. Update the HTML tag
        document.documentElement.setAttribute('data-theme', themeName);
        
        // 2. Save to LocalStorage (So it remembers next time)
        localStorage.setItem('theme', themeName);
        
        // 3. Update the Menu Checks (Visual feedback)
        const lightCheck = document.getElementById('check-light');
        const darkCheck = document.getElementById('check-dark');
        
        if(lightCheck) lightCheck.style.display = (themeName === 'light') ? 'block' : 'none';
        if(darkCheck) darkCheck.style.display = (themeName === 'dark') ? 'block' : 'none';
    }

    // 4. Run on Load (Apply saved theme instantly)
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark if nothing saved
        setTheme(savedTheme);
    })();

    (async function init() {
        updateClock();
        setInterval(updateClock, 1000);
        
        await fetchAllData();
        
        checkIncomingBooking();
        
        setupRealtime();
        
        setInterval(() => {
            fetchAllData();
        }, 60000);
    })();
    </script>

    <div id="editModalOverlay">
        <div id="editModal">
            <h3 style="margin-top:0; margin-bottom:8px; font-size:20px; color: var(--accent);">Edit Vehicle</h3>
            <label for="editReg">Registration</label>
            <input type="text" id="editReg">
            <label for="editPO">PO / Reference</label>
            <input type="text" id="editPO">
            <label for="editMobile">Mobile Number</label>
            <input type="text" id="editMobile">
            <label for="editNotes">Notes</label>
            <textarea id="editNotes"></textarea>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveEditModal()">Save</button>
            </div>
        </div>
    </div>
</body>
</html>