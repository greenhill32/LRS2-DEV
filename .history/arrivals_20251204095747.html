<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gatehouse - Expected Arrivals</title>
<div id="versionBanner" style="
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    background: #8b5cf6; color: white; padding: 4px 12px;
    border-radius: 4px; font-size: 11px; font-weight: 600; z-index: 9999;
">v4.0.0 - THEMED</div>

<style>
    /* 1. SHARED COLORS (Colors that look good on both modes) */
    :root {
        --accent: #0ea5e9;
        --success: #22c55e;
        --warn: #fbbf24;
        --danger: #ef4444;
        --purple: #8b5cf6;
    }

    /* 2. LIGHT MODE */
    [data-theme="light"] {
        --bg: #f1f5f9;         /* Light Grey Background */
        --card: #ffffff;       /* Pure White Cards */
        --text: #0f172a;       /* Very Dark Blue/Grey Text */
        --muted: #64748b;      /* Muted Text */
        --border: #cbd5e1;     /* Light Grey Borders */
    }

    /* 3. DARK MODE */
    [data-theme="dark"] {
        --bg: #0e1420;
        --card: #1f2937;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --border: #334155;
    }

    /* 4. ANIMATION (Smooth transition) */
    body, .arrivals-panel, .booking-card, header, .stat-item {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
    }

    /* HEADER LAYOUT */
    header {
        background: var(--card);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--border);
    }

    .header-left {
        flex: 1;
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .header-clock {
        flex: 1;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        color: var(--text);
    }

    .header-right {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    /* Connection Status */
    .connection-status {
        width: 10px; height: 10px; background: var(--success);
        border-radius: 50%; display: inline-block;
    }
    .connection-status.disconnected { background: var(--danger); animation: pulse 1s infinite; }

    /* Avatar */
    #avatarBtn {
        width: 38px; height: 38px; border-radius: 50%;
        background: var(--bg); border: 1px solid var(--border);
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; color: var(--accent);
        cursor: pointer; user-select: none;
    }
    #avatarMenu {
        position: absolute; top: 48px; right: 0;
        background: var(--card); border: 1px solid var(--border);
        border-radius: 6px; min-width: 150px;
        padding: 4px 0; display: none; z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #avatarMenu > div { padding: 8px 12px; cursor: pointer; font-size: 14px; color: var(--text); }
    #avatarMenu > div:hover { background: var(--accent); color: #000; }

    /* NAV */
    .main-nav {
        background: #1e3a5f; padding: 0;
        display: flex; align-items: center; justify-content: center;
        border-bottom: 1px solid var(--border);
    }
    .main-nav a {
        color: #e2e8f0; text-decoration: none;
        padding: 14px 24px; font-size: 14px; font-weight: 600;
        letter-spacing: 0.5px; transition: all 0.2s;
    }
    .main-nav a:hover { background: rgba(255,255,255,0.1); }
    .main-nav a.active { background: rgba(255,255,255,0.15); color: #fff; }
    .nav-divider { color: #64748b; font-size: 18px; user-select: none; }

    /* STATS BAR */
    .stats-bar {
        display: flex; gap: 16px; padding: 20px 24px;
        background: var(--card); margin: 20px 24px;
        border-radius: 12px; border: 1px solid var(--border);
    }
    .stat-item { flex: 1; text-align: center; padding: 12px; border-right: 1px solid var(--border); }
    .stat-item:last-child { border-right: none; }
    .stat-value { font-size: 36px; font-weight: 700; color: var(--accent); }
    .stat-value.purple { color: var(--purple); }
    .stat-value.success { color: var(--success); }
    .stat-label { font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

    /* LAYOUT - UPDATED for Task 1 */
    .main-grid {
        display: block; /* Removed Grid */
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px 24px;
    }

    /* ARRIVALS LIST */
    .arrivals-panel {
        background: var(--card); border-radius: 12px;
        border: 1px solid var(--border); overflow: hidden;
    }
    .panel-header {
        padding: 16px 20px; border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .panel-title { font-size: 18px; font-weight: 600; color: var(--accent); }
    .arrivals-list { max-height: 600px; overflow-y: auto; }
    
    .time-slot { border-bottom: 1px solid var(--border); }
    .time-slot:last-child { border-bottom: none; }
    .slot-header {
        padding: 10px 20px; background: rgba(125,125,125,0.05);
        font-size: 13px; font-weight: 600; color: var(--muted);
        display: flex; justify-content: space-between;
    }
    .slot-header.now { background: rgba(14, 165, 233, 0.1); color: var(--accent); }

    /* BOOKING CARD */
    .booking-card {
        padding: 16px 20px; border-bottom: 1px solid var(--border);
        display: flex; align-items: center; gap: 16px;
        cursor: pointer; transition: all 0.2s; position: relative;
    }
    .booking-card:hover { background: rgba(125,125,125,0.05); }
    .booking-card:last-child { border-bottom: none; }
    
    /* Status Bars */
    .booking-status { width: 6px; height: 60px; border-radius: 4px; flex-shrink: 0; }
    
    /* Status Colors */
    .status-booked { background: var(--accent); } /* Blue */
    .status-waiting { background: var(--purple); box-shadow: 0 0 10px rgba(139, 92, 246, 0.3); } /* Purple */
    .status-complete { background: var(--success); } /* Green */
    .status-late { background: var(--danger); animation: pulse 1s infinite; }

    .booking-main { flex: 1; }
    
    /* Ref & Registration Layout */
    .booking-header { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
    .booking-ref { font-size: 18px; font-weight: 700; color: var(--text); }
    .reg-badge { 
        font-size: 14px; font-weight: 700; color: #fff; 
        background: #334155; padding: 2px 8px; border-radius: 4px; 
        letter-spacing: 0.5px; border: 1px solid #475569;
    }

    .booking-details { font-size: 13px; color: var(--muted); display: flex; gap: 16px; flex-wrap: wrap; }
    .booking-orders {
        font-size: 12px; color: var(--text); margin-top: 6px;
        font-family: monospace; background: rgba(125,125,125,0.1);
        padding: 4px 8px; border-radius: 4px; display: inline-block;
    }
    .booking-notes {
        margin-top: 8px; font-size: 12px; color: var(--warn);
        background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.4);
        padding: 6px 8px; border-radius: 6px; line-height: 1.4;
    }

    .booking-meta { text-align: right; flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .booking-pallets { font-size: 24px; font-weight: 700; color: var(--text); }
    .booking-pallets small { font-size: 12px; font-weight: 400; color: var(--muted); }

    /* Badges */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .badge-meds { background: var(--danger); color: white; margin-left: 8px; }
    
    /* Status Badges */
    .state-badge { font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 2px 6px; border-radius: 3px; }
    .badge-queue { background: rgba(139, 92, 246, 0.2); color: var(--purple); border: 1px solid var(--purple); }
    .badge-notified { background: var(--purple); color: white; }
    .badge-released { background: rgba(34, 197, 94, 0.2); color: var(--success); border: 1px solid var(--success); }

    /* Booking Modal */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.55);
        display: none; align-items: center; justify-content: center; z-index: 10000;
        padding: 20px;
    }
    .modal-card {
        background: var(--card); border: 1px solid var(--border);
        border-radius: 12px; padding: 20px; max-width: 540px; width: 100%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.35); position: relative;
    }
    .modal-close {
        position: absolute; top: 12px; right: 12px; background: none; border: none;
        color: var(--muted); font-size: 18px; cursor: pointer;
    }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .modal-subtitle { font-size: 12px; color: var(--muted); margin-bottom: 14px; }
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
    .modal-label { font-size: 11px; text-transform: uppercase; color: var(--muted); letter-spacing: 0.5px; }
    .modal-value { font-size: 14px; color: var(--text); margin-top: 2px; }
    .modal-note {
        margin-top: 6px; font-size: 13px; color: var(--text); line-height: 1.5;
        background: rgba(251,191,36,0.08); border: 1px dashed rgba(251,191,36,0.5);
        padding: 10px 12px; border-radius: 8px;
    }
    .modal-note.empty { color: var(--muted); background: rgba(125,125,125,0.05); border-color: var(--border); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px; }
    .modal-btn {
        padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border);
        background: var(--card); color: var(--text); cursor: pointer; font-weight: 600;
    }
    .modal-btn.primary { background: var(--accent); color: #000; border-color: var(--accent); }
    .modal-btn:hover { opacity: 0.9; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>
</head>
<body>

<header>
    <div class="header-left">
        <span class="connection-status" id="connectionDot" title="Live Connection"></span>
        <span style="margin-left: 10px;">Expected Arrivals</span>
    </div>
    <div class="header-clock" id="clock">--:--</div>
    <div class="header-right">
        <div id="avatarBtn">??</div>
        
        <!-- THEME SWITCHER MENU -->
        <div id="avatarMenu">
            <div id="menuName" style="border-bottom:1px solid var(--border); margin-bottom:5px;">Loading</div>
            
            <!-- Theme Switcher -->
            <div style="font-size:12px; color:var(--muted); padding: 4px 12px;">Appearance</div>
            <div onclick="setTheme('light')" style="display:flex; justify-content:space-between;">
                <span>&#9728; Light</span>
                <span id="check-light" style="display:none;">&#10003;</span>
            </div>
            <div onclick="setTheme('dark')" style="display:flex; justify-content:space-between;">
                <span>&#9790; Dark</span>
                <span id="check-dark" style="display:none;">&#10003;</span>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:4px 0;">
            
            <div onclick="logoutUser()">Logout</div>
        </div>
    </div>
</header>


<!-- ARRIVALS.HTML NAV (ARRIVALS is active) -->
<nav class="main-nav">
    <a href="arrivals.html" class="active">ARRIVALS</a>
    <span class="nav-divider">|</span>
    <a href="index.html">QUEUE</a>
    <span class="nav-divider">|</span>
    <a href="supervisor.html">SUPERVISOR</a>
    <span class="nav-divider">|</span>
    <a href="report.html">REPORTS</a>
</nav>


<!-- STATS -->
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-value" id="statExpected">0</div>
        <div class="stat-label">Expected</div>
    </div>
    <div class="stat-item">
        <div class="stat-value purple" id="statInQueue">0</div>
        <div class="stat-label">In Queue</div>
    </div>
    <div class="stat-item">
        <div class="stat-value success" id="statComplete">0</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statPallets">0</div>
        <div class="stat-label">Remaining Pallets</div>
    </div>
</div>

<div class="main-grid">
    <!-- ARRIVALS LIST -->
    <div class="arrivals-panel">
        <div class="panel-header">
            <div class="panel-title">Todays Schedule</div>
            <div style="font-size:12px; color:var(--muted);">Select a booking to Check In</div>
        </div>
        <div class="arrivals-list" id="arrivalsList">
            <div style="padding:40px; text-align:center; color:var(--muted);">Loading Schedule...</div>
        </div>
    </div>
</div>

<!-- Booking Detail Modal -->
<div id="bookingModal" class="modal-overlay" onclick="closeBookingModal(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeBookingModal()" aria-label="Close modal">&#10005;</button>
        <div class="modal-title" id="modalRef">#000000</div>
        <div class="modal-subtitle" id="modalState">Booking detail</div>
        <div class="modal-grid">
            <div>
                <div class="modal-label">Customer</div>
                <div class="modal-value" id="modalCustomer">Unknown Customer</div>
            </div>
            <div>
                <div class="modal-label">Account</div>
                <div class="modal-value" id="modalAccount">-</div>
            </div>
            <div>
                <div class="modal-label">Orders</div>
                <div class="modal-value" id="modalOrders">-</div>
            </div>
            <div>
                <div class="modal-label">Pallets</div>
                <div class="modal-value" id="modalPallets">0</div>
            </div>
            <div>
                <div class="modal-label">Registration</div>
                <div class="modal-value" id="modalReg">-</div>
            </div>
            <div>
                <div class="modal-label">Slot</div>
                <div class="modal-value" id="modalSlot">-</div>
            </div>
        </div>
        <div class="modal-label">Notes</div>
        <div class="modal-note empty" id="modalNotes">No notes</div>
        <div class="modal-actions">
            <button class="modal-btn" onclick="closeBookingModal()">Close</button>
            <button class="modal-btn primary" onclick="proceedToCheckin()">Check In</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient(
    "https://gtixdparpjdpyhhubsfz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
);

// State
let bookingsData = []; // From JSON
let liveVehicles = []; // From Supabase
let mergedData = [];   // Combined
let activeBookingRef = null; // For modal actions

function getToken() { return localStorage.getItem('session_token'); }

// 1. Initial Load
async function init() {
    updateClock(); setInterval(updateClock, 1000);
    checkUser();
    
    await Promise.all([ loadBookingsJSON(), loadLiveVehicles() ]);
    syncData();
    setupRealtime();
}

function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function truncateText(str, limit = 120) {
    const clean = (str || '').trim();
    if (clean.length <= limit) return clean;
    return clean.slice(0, limit - 3) + '...';
}

// 2. Load Mock Bookings
async function loadBookingsJSON() {
    try {
        const res = await fetch('mock_bookings.json');
        if (!res.ok) throw new Error("JSON Fetch Failed");
        const data = await res.json();
        bookingsData = data.bookings || [];
    } catch(e) { 
        console.error("JSON Error, using fallback:", e); 
        // Fallback data if JSON fails
        bookingsData = [
            { "ref": "819999", "time": "15:00", "pallets": 29, "customer": "Waitrose", "status": "booked" }
        ];
    }
}

// 3. Load Live Vehicles (Today) - Uses get_vehicles_secure with client-side date filter
async function loadLiveVehicles() {
    const token = getToken();
    if (!token) return;
    
    const { data: result, error } = await db.rpc('get_vehicles_secure', {
        session_token: token
    });

    if (error) {
        console.error("RPC get_vehicles_secure failed", error);
        return;
    }
    if (result && result.success === false) {
        console.error("RPC error", result.error);
        if (result.error === 'Invalid session') logoutUser();
        return;
    }

    const rows = Array.isArray(result?.data) ? result.data : (Array.isArray(result) ? result : []);
    
    // Filter to today's vehicles client-side
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    liveVehicles = rows.filter(v => {
        const checkIn = new Date(v.check_in_time);
        return checkIn >= today && checkIn < tomorrow;
    });
}

// 4. Sync Logic
function syncData() {
    if (!bookingsData || bookingsData.length === 0) {
        document.getElementById('arrivalsList').innerHTML = '<div style="padding:40px; text-align:center;">No Bookings Found</div>';
        return;
    }

    mergedData = bookingsData.map(b => {
        // Safe Copy
        const item = { ...b, syncStatus: 'booked', syncBadge: '', liveReg: null, actualPallets: null };

        // Match logic (use String() to handle number/string type mismatches)
        const match = liveVehicles.find(v => v.po_ref && String(v.po_ref) === String(b.ref));

        if (match) {
            item.liveReg = match.registration;
            item.actualPallets = match.pallet_count;

            const status = (match.status || '').toLowerCase();
            if (status === 'parked') {
                item.syncStatus = 'waiting';
                item.syncBadge = `<span class="state-badge badge-queue">IN QUEUE</span>`;
            } else if (status === 'notified') {
                item.syncStatus = 'waiting';
                item.syncBadge = `<span class="state-badge badge-notified">NOTIFIED</span>`;
            } else if (status === 'released' || status === 'completed' || status === 'complete') {
                item.syncStatus = 'complete';
                item.syncBadge = `<span class="state-badge badge-released">RELEASED</span>`;
            } else if (status === 'booked_in' || status === 'booked-in' || status === 'checked_in' || status === 'check_in') {
                item.syncStatus = 'waiting';
                item.syncBadge = `<span class="state-badge badge-queue">BOOKED IN</span>`;
            } else {
                const label = status ? status.toUpperCase() : 'LIVE';
                item.syncBadge = `<span class="state-badge badge-queue">${label}</span>`;
            }
        }

        return item;
    });

    renderBoard();
    updateStats();
}

// 5. Render
function renderBoard() {
    const container = document.getElementById('arrivalsList');
    container.innerHTML = '';

    // Group by hour
    const groups = {};
    mergedData.forEach(item => {
        // Use slot_start first, fall back to time, then default to 00:00
        const timeStr = item.slot_start || item.time || "00:00";
        const h = timeStr.slice(0,2) + ':00';
        
        if (!groups[h]) groups[h] = [];
        groups[h].push(item);
    });

    // Sort hours
    const sortedHours = Object.keys(groups).sort();

    if (sortedHours.length === 0) {
         container.innerHTML = '<div style="padding:40px; text-align:center;">No Scheduled Arrivals</div>';
         return;
    }

    sortedHours.forEach(hour => {
        const items = groups[hour];
        const nowHour = String(new Date().getHours()).padStart(2,'0') + ':00';
        const isNow = hour === nowHour;

        let html = `<div class="time-slot">
            <div class="slot-header ${isNow ? 'now' : ''}">
                <span>${hour} - ${parseInt(hour)+1}:00 ${isNow ? '(NOW)' : ''}</span>
                <span>${items.length} booking(s)</span>
            </div>`;

        items.forEach(b => {
            const statusClass = `status-${b.syncStatus}`;
            const displayPallets = b.actualPallets || b.pallets || 0;
            const palletLabel = b.actualPallets ? '(Actual)' : '(Est)';
            const noteText = (b.notes || '').trim();
            const noteSnippet = noteText ? `<div class="booking-notes" title="${escapeHtml(noteText)}">${escapeHtml(truncateText(noteText, 120))}</div>` : '';

            html += `
            <div class="booking-card" onclick="openBookingModal('${b.ref}')">
                <div class="booking-status ${statusClass}"></div>
                <div class="booking-main">
                    <div class="booking-header">
                        <span class="booking-ref">#${b.ref}</span>
                        ${b.liveReg ? `<span class="reg-badge">${b.liveReg}</span>` : ''}
                        ${b.syncBadge}
                        ${b.contains_meds ? '<span class="badge badge-meds">MEDS</span>' : ''}
                    </div>
                    <div class="booking-details">
                        <span>${b.customer || 'Unknown Customer'}</span>
                        <span>${b.account || ''}</span>
                    </div>
                    ${noteSnippet}
                </div>
                <div class="booking-meta">
                    <div class="booking-pallets">${displayPallets}</div>
                    <small>${palletLabel}</small>
                </div>
            </div>`;
        });

        html += `</div>`;
        container.innerHTML += html;
    });
}

function updateStats() {
    const total = mergedData.length;
    const inQueue = mergedData.filter(x => x.syncStatus === 'waiting').length;
    const complete = mergedData.filter(x => x.syncStatus === 'complete').length;
    
    // UPDATED LINE: Filter out 'complete' items before summing
    const pallets = mergedData
        .filter(x => x.syncStatus !== 'complete') // This removes the completed ones
        .reduce((sum, x) => sum + (x.actualPallets || x.pallets || 0), 0);

    document.getElementById('statExpected').textContent = total;
    document.getElementById('statInQueue').textContent = inQueue;
    document.getElementById('statComplete').textContent = complete;
    document.getElementById('statPallets').textContent = pallets;
}

function openBookingModal(ref) {
    const booking = mergedData.find(x => x.ref === ref);
    if (!booking) return;

    activeBookingRef = ref;

    document.getElementById('modalRef').textContent = `#${booking.ref}`;
    document.getElementById('modalState').textContent = booking.syncStatus ? booking.syncStatus.toUpperCase() : 'BOOKED';
    document.getElementById('modalCustomer').textContent = booking.customer || 'Unknown Customer';
    document.getElementById('modalAccount').textContent = booking.account || '-';
    document.getElementById('modalOrders').textContent = Array.isArray(booking.orders) ? booking.orders.join(', ') : (booking.orders || '-');
    document.getElementById('modalPallets').textContent = booking.actualPallets || booking.pallets || 0;
    document.getElementById('modalReg').textContent = booking.liveReg || 'Not checked in';
    document.getElementById('modalSlot').textContent = (booking.slot_start && booking.slot_end) ? `${booking.slot_start} - ${booking.slot_end}` : (booking.time || '-');

    const noteBox = document.getElementById('modalNotes');
    const noteText = (booking.notes || '').trim();
    if (noteText) {
        noteBox.textContent = noteText;
        noteBox.classList.remove('empty');
    } else {
        noteBox.textContent = 'No notes';
        noteBox.classList.add('empty');
    }

    document.getElementById('bookingModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeBookingModal(evt) {
    if (evt && evt.target && evt.currentTarget && evt.target !== evt.currentTarget) return;
    document.getElementById('bookingModal').style.display = 'none';
    document.body.style.overflow = '';
    activeBookingRef = null;
}

function proceedToCheckin() {
    const ref = activeBookingRef;
    closeBookingModal();
    if (ref) selectForCheckin(ref);
}

// 6. Realtime
function setupRealtime() {
    const dot = document.getElementById('connectionDot');
    db.channel('arrivals-sync')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'vehicles' }, 
        async () => {
            console.log("Change detected, refreshing arrivals...");
            await loadLiveVehicles();
            syncData();
        })
        .subscribe((status) => {
            if (status === 'SUBSCRIBED') dot.classList.remove('disconnected');
            else dot.classList.add('disconnected');
        });
}

// 7. Check-in Launcher (UPDATED)
function selectForCheckin(ref) {
    // Find the booking details in the existing data
    const b = mergedData.find(x => x.ref === ref);
    if (!b) return;

    // Prepare the data to send to the queue page
    const params = new URLSearchParams({
        ref: b.ref,
        customer: b.customer,
        orders: Array.isArray(b.orders) ? b.orders.join(', ') : (b.orders || ''),
        pallets: b.pallets || '',
        meds: b.contains_meds || false
    });

    // Redirect to index.html with the data in the URL
    window.location.href = `index.html?${params.toString()}`;
}

function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}); }

function checkUser() { 
    const token = getToken();
    if (!token) { window.location.href='login.html'; return; }

    const opName = localStorage.getItem('operator_name');
    if (opName) {
        document.getElementById('menuName').textContent = opName;
        const initials = opName.split(" ").map(x => (x[0] || "")).join("").toUpperCase().slice(0, 2);
        document.getElementById("avatarBtn").textContent = initials || "??";
    }
}

function logoutUser() { 
    localStorage.removeItem('session_token');
    localStorage.removeItem('operator_id');
    localStorage.removeItem('operator_name');
    localStorage.removeItem('operator_role');
    window.location.href='login.html'; 
}

// Avatar Menu Toggle
document.addEventListener('click', (e) => {
    const btn = document.getElementById('avatarBtn');
    const menu = document.getElementById('avatarMenu');
    if (!btn || !menu) return;
    if (btn.contains(e.target)) {
        menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
    } else if (!menu.contains(e.target)) {
        menu.style.display = 'none';
    }
});

// ============================================
// THEME SWITCHER LOGIC
// ============================================
function setTheme(themeName) {
    // 1. Update the HTML tag
    document.documentElement.setAttribute('data-theme', themeName);
    
    // 2. Save to LocalStorage (So it remembers next time)
    localStorage.setItem('theme', themeName);
    
    // 3. Update the Menu Checks (Visual feedback)
    document.getElementById('check-light').style.display = (themeName === 'light') ? 'block' : 'none';
    document.getElementById('check-dark').style.display = (themeName === 'dark') ? 'block' : 'none';
}

// 4. Run on Load (Apply saved theme instantly)
(function() {
    const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark if nothing saved
    setTheme(savedTheme);
})();

// Run App
init();
</script>
</body>
</html>