
This is a great idea. Since LLMs don't have long-term memory between sessions, creating a Context Restore Guide allows you to "save your game."
Here is the exact GUIDE.md you should create. When you start a new conversation, copy and paste the entire block below. It contains the styling rules, database schema, and the latest code state so I can resume immediately without breaking anything.
GUIDE.md
SYSTEM PROMPT / CONTEXT RESTORATION
You are acting as the Lead Developer for the Gatehouse Dashboard Project. We are building a warehouse vehicle management system using Vanilla HTML/JS/CSS (no build tools) and Supabase v2 (via CDN).
1. Global Design System (DO NOT DEVIATE)
All pages must share these exact CSS variables and Header structure to maintain consistency.
Theme Tokens:
code
CSS
:root {
  --bg: #0e1420; --card: #1f2937; --accent: #0ea5e9;
  --text: #e2e8f0; --muted: #94a3b8; --border: #334155;
  --success: #22c55e; --warn: #fbbf24; --danger: #ef4444; --purple: #8b5cf6;
}
Header Structure (Critical for Alignment):
The header must use a 3-column Flex layout so the clock is perfectly centered.
code
Html
<header>
    <div class="header-left"><h1>Page Title</h1></div>
    <div class="header-clock" id="clock">--:--</div>
    <div class="header-right">
        <!-- Status Dot / Buttons -->
        <!-- Avatar + Dropdown -->
    </div>
</header>
CSS Rule: .header { display: flex; align-items: center; }
CSS Rule: .header-left, .header-clock, .header-right { flex: 1; }
CSS Rule: .header-clock { text-align: center; font-size: 32px; font-weight: bold; }
2. Database Schema (Supabase)
Assume this schema exists for all SQL generation:
vehicles: id (uuid), registration, po_ref, haulier, mobile_number, notes, quoted_minutes (int), check_in_time (iso), due_time (iso), status ('parked'|'notified'|'released'), classification ('normal'|'export'), operator_id.
actions_log: id, vehicle_id, action, timestamp, operator_id, details (json).
operators: id, name, role.
prebookings: used for arrivals.html matching.
3. Current Functionality Rules
Realtime: Use supabase.channel for live updates on index.html.
Navigation: All pages have a sub-nav: QUEUE | ARRIVALS | SUPERVISOR.
External Windows: SMS and QR codes open in new windows (window.open).
Auth: Relies on localStorage.getItem('operator_id').
4. Current File State
Here is the latest code for the three main files. Ingest this into your context before answering further requests.
FILE: index.html (Main Dashboard)
<!-- START A1 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gatehouse Dashboard</title>
<div id="versionBanner"></div>

<script>
document.getElementById("versionBanner").innerText = "v3.2.2 - RELEASED TODAY FIX";
</script>

<!--
  Warehouse gatehouse dashboard - OPTIMIZED VERSION
  Changes from v3.1.2:
    - Filtered queries - only fetch active vehicles, not entire history
    - Supabase Realtime - instant updates, no polling
    - Cached operators - load once, not every 15 seconds
    - Debounced refreshes - prevent hammering DB on rapid changes
-->
<style>
    :root {
        --bg: #0e1420;
        --card: #1f2937;
        --accent: #0ea5e9;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --success: #22c55e;
        --warn: #fbbf24;
        --danger: #ef4444;
    }

    /* Export load styling */
    .queue-export {
        background: linear-gradient(
            90deg,
            rgba(14,165,233,0.25),
            rgba(14,165,233,0.08)
        ) !important;
        box-shadow: 0 0 16px rgba(14,165,233,0.5);
        animation: exportPulse 2.4s infinite ease-in-out;
    }

    @keyframes exportPulse {
        0%, 100% { box-shadow: 0 0 16px rgba(14,165,233,0.5); }
        50% { box-shadow: 0 0 24px rgba(14,165,233,0.8); }
    }
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
    }
    header {
        background: var(--card);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #1e293b;
    }

    .header-left {
        flex: 1;
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
    }
    .header-clock {
        flex: 1;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        color: var(--text);
    }
    .header-right {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    #avatarBtn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: var(--bg);
        border: 1px solid #334155;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--accent);
        cursor: pointer;
        user-select: none;
    }
    #avatarMenu {
        position: absolute;
        top: 48px;
        right: 0;
        background: var(--card);
        border: 1px solid #334155;
        border-radius: 6px;
        min-width: 150px;
        padding: 4px 0;
        display: none;
        z-index: 10000;
    }
    #avatarMenu > div {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
    }
    #avatarMenu > div:hover {
        background: var(--accent);
        color: #000;
    }

    .entry {
        cursor: pointer;
    }

    #editModalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        z-index: 10000;
    }
    #editModal {
        background: var(--card);
        color: var(--text);
        width: 420px;
        margin: 80px auto;
        padding: 24px;
        border-radius: 8px;
        border: 1px solid #334155;
    }
    #editModal label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-size: 14px;
    }
    #editModal input,
    #editModal textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #334155;
        border-radius: 6px;
        background: var(--bg);
        color: var(--text);
        font-size: 14px;
    }
    #editModal textarea {
        resize: vertical;
        height: 80px;
    }
    #editModal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 16px;
    }
    #editModal .modal-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
    }
    #editModal .modal-actions .cancel-btn {
        background: #475569;
        color: #fff;
    }
    #editModal .modal-actions .save-btn {
        background: var(--accent);
        color: #000;
    }
    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        padding: 24px;
    }
    .tile {
        background: var(--card);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #334155;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    .tile .value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 4px;
        color: var(--accent);
    }
    .grid {
        display: flex;
        flex-direction: row;
        gap: 24px;
        padding: 0 24px 24px;
    }
    .queue, .details {
        flex: 1;
        background: var(--card);
        border-radius: 8px;
        border: 1px solid #334155;
        padding: 16px;
        min-height: 420px;
        overflow-y: auto;
    }
    .queue h2, .details h2 {
        margin-top: 0;
        color: var(--accent);
        font-size: 20px;
    }
    .entry {
        background: #1f2937;
        border-left: 22px solid var(--success);
        padding: 24px;
        margin-bottom: 12px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .entry.overdue {
        border-left-color: var(--warn);
    }
    .entry.critical {
        border-left-color: var(--danger);
    }
    .entry .info {
        flex: 1;
    }
    .entry .actions button {
        margin-left: 6px;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .entry .actions .notify { background: var(--warn); color: #000; }
    .entry .actions .release { background: var(--success); color: #000; }
    .entry .actions .undo { background: var(--danger); color: #fff; }
    .activity-item {
        margin-bottom: 8px;
        border-bottom: 1px solid #334155;
        padding-bottom: 4px;
        font-size: 14px;
    }
    .add-btn {
        background: var(--accent);
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        margin-right: 8px;
    }
    .slide-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        min-height: 320px;
        background: var(--card);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        padding: 20px 24px;
        transform: translateY(calc(-100% - 40px));
        transition: transform 0.4s ease;
        z-index: 1000;
        color: var(--text);
    }
    .panel-visible {
        transform: translateY(0);
    }
    .panel-title {
        font-size: 20px;
        color: var(--accent);
        font-weight: bold;
        margin-bottom: 10px;
    }
    .form-row {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }
    .slide-panel input,
    .slide-panel textarea,
    .slide-panel select {
        padding: 10px;
        flex: 1;
        border: 1px solid #334155;
        border-radius: 6px;
        font-size: 14px;
        background: var(--bg);
        color: var(--text);
    }
    .submit-btn {
        padding: 10px 16px;
        background: var(--accent);
        color: #fff;
        border-radius: 6px;
        margin-top: 12px;
        cursor: pointer;
        text-align: center;
        font-weight: bold;
    }
    
    /* Connection status indicator */
    .connection-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        margin-right: 8px;
    }
    .connection-status.disconnected {
        background: var(--danger);
        animation: pulse 1s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Navigation bar */
    .main-nav {
        background: #1e3a5f;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid #334155;
    }
    .main-nav a {
        color: #e2e8f0;
        text-decoration: none;
        padding: 14px 24px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.2s;
    }
    .main-nav a:hover {
        background: rgba(255,255,255,0.1);
    }
    .main-nav a.active {
        background: rgba(255,255,255,0.15);
        color: #fff;
    }
    .nav-divider {
        color: #64748b;
        font-size: 18px;
        user-select: none;
    }
</style>
<!-- END A1 -->
 
</head>
<body>
    <!-- START A2 -->
    <!-- Hidden Add Lorry Panel -->
    <div id="addPanel" class="slide-panel">
        <div class="panel-title">Add New Lorry</div>
        <!-- Haulier/Lorry field -->
        <div class="form-row">
            <input type="text" id="haulierInput" placeholder="Haulier / Lorry Company" style="width:100%;">
        </div>
        <!-- Expected Loads Dropdown -->
        <div class="form-row">
            <select id="prebookSelect" onchange="applyPrebook()" style="width:100%;">
                <option value="">-- Select Expected Load --</option>
            </select>
        </div>
        <div class="form-row">
            <input type="text" id="regInput" placeholder="Registration">
            <input type="text" id="poInput" placeholder="PO / Reference">
        </div>
        <div class="form-row">
            <input type="text" id="mobileInput" placeholder="Mobile Number">
            <select id="quotedInput">
                <option value="30">30 mins</option>
                <option value="45">45 mins</option>
                <option value="60" selected>60 mins</option>
                <option value="90">90 mins</option>
                <option value="120">120 mins</option>
            </select>
        </div>
        <div class="form-row">
            <textarea id="notesInput" placeholder="Notes" style="width:100%;height:80px;"></textarea>
        </div>
        <div class="form-row">
            <label style="color:#ccc;">
                <input type="checkbox" id="addExport" style="margin-right:6px;">
                Export Load
            </label>
        </div>
        <div class="submit-btn" onclick="submitVehicle()">Submit</div>
    </div>
    <header>
        <div class="header-left">
            <span class="connection-status" id="connectionStatus" title="Realtime connection"></span>
            Gatehouse Dashboard
        </div>
        <div id="clock" class="header-clock">--:--</div>
        <div class="header-right">
            <button class="add-btn" onclick="togglePanel()">Add Lorry</button>
            <button id="refreshBtn" style="padding:8px 16px;font-size:14px;background:var(--accent);color:#fff;border:none;border-radius:4px;" onclick="manualRefresh()">Refresh</button>
            <div style="position: relative;">
                <div id="avatarBtn">??</div>
                <div id="avatarMenu">
                    <div id="menuName">Loading</div>
                    <div onclick="logoutUser()">Logout</div>
                </div>
            </div>
        </div>
    </header>
    <!-- Navigation -->
    <nav class="main-nav">
        <a href="index.html" class="active">QUEUE</a>
        <span class="nav-divider">|</span>
        <a href="arrivals.html">ARRIVALS</a>
        <span class="nav-divider">|</span>
        <a href="supervisor.html">SUPERVISOR</a>
    </nav>
    <!-- END A2 -->
    
    <!-- KPI Tiles -->
    <!-- START A3 -->
    <div class="stats">
        <div class="tile">
            <div class="value" id="kpiTotalIn">0</div>
            Checked In
        </div>
        <div class="tile">
            <div class="value" id="kpiTotalOut">0</div>
            Released Today
        </div>
        <div class="tile">
            <div class="value" id="kpiAvgWait">0</div>
            Avg Wait (m)
        </div>
        <div class="tile">
            <div class="value" id="kpiOverdue">0</div>
            Overdue >30m
        </div>
    </div>
    <!-- END A3 -->
    
    <!-- START A4 -->
    <div class="grid">
        <div class="queue">
            <h2>Active Queue</h2>
            <div id="queueList">Loading...</div>
        </div>
        <div class="details">
            <h2>Recent Activity</h2>
            <div id="activityList">Loading...</div>
        </div>
    </div>
    <!-- END A4 -->
    
    <!-- START A5 -->
    <canvas id="chartTrend" style="max-width:600px;height:240px;max-height:240px;margin:0 auto 24px;display:block;"></canvas>
    <!-- END A5 -->

    <!-- Supabase & Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // ============================================================
    // SUPABASE CLIENT
    // ============================================================
    const db = supabase.createClient(
        "https://gtixdparpjdpyhhubsfz.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
    );

    // ============================================================
    // STATE
    // ============================================================
    let vehicles = [];          // Only ACTIVE vehicles (parked/notified)
    let releasedCount = 0;      // Total released (all time)
    let operators = [];         // Loaded ONCE, cached
    let logs = [];
    let chart;
    let refreshTimeout = null;  // For debouncing

    // Additional state for prebookings and export flag. These are used by the
    // Add Lorry form to preload expected loads (prebookings) and preserve
    // whether a selected prebooking is marked as an export. Without this,
    // the prebooking selection would not populate the form fields correctly.
    let prebookCache = [];
    let prebookExportFlag = false;

    // ============================================================
    // OPTIMIZED FETCH: OPERATORS (load once, cache in memory)
    // ============================================================
    async function fetchOperators() {
        // Only fetch if we don't have them cached
        if (operators.length > 0) return;
        
        const { data, error } = await db
            .from('operators')
            .select('id, name')
            .eq('active', true);
        
        if (error) { console.error(error); return; }
        operators = data || [];
        
        // Also cache in localStorage for instant load on refresh
        try {
            localStorage.setItem('operators_cache', JSON.stringify(operators));
        } catch (e) { /* quota exceeded, ignore */ }
    }

    // Load cached operators immediately
    (function loadCachedOperators() {
        try {
            const cached = localStorage.getItem('operators_cache');
            if (cached) operators = JSON.parse(cached);
        } catch (e) { /* ignore */ }
    })();

    // ============================================================
    // OPTIMIZED FETCH: VEHICLES (only active, not entire history)
    // ============================================================
    async function fetchVehicles() {
        // Fetch active vehicles for the queue
        const { data, error } = await db
            .from('vehicles')
            .select('*')
            .in('status', ['parked', 'notified'])
            .order('check_in_time', { ascending: true });

        if (error) { console.error(error); return; }
        vehicles = data || [];

        // Fetch released count for TODAY only (matches Supervisor dashboard)
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        
        const { count } = await db
            .from('vehicles')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'released')
            .gte('release_time', todayStart.toISOString());
        
        releasedCount = count || 0;

        renderQueue();
        loadKPIs();
        loadChart();
    }

    // ============================================================
    // OPTIMIZED FETCH: LOGS (with 24hr filter in query)
    // ============================================================
    let vehicleCache = {}; // Cache for vehicle lookups (including released)
    
    async function fetchLogs() {
        const cutoff = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
        
        const { data, error } = await db
            .from('actions_log')
            .select('*')
            .gte('timestamp', cutoff)  // Filter in DB, not JS
            .order('timestamp', { ascending: false })
            .limit(20);

        if (error) { console.error("Error loading logs:", error); return; }
        logs = data || [];
        
        // Fetch vehicle details for any vehicles not in our active list
        const missingIds = logs
            .map(l => l.vehicle_id)
            .filter(id => id && !vehicles.find(v => v.id === id) && !vehicleCache[id]);
        
        if (missingIds.length > 0) {
            const { data: missingVehicles } = await db
                .from('vehicles')
                .select('id, registration, po_ref')
                .in('id', [new Set(missingIds)]);
            
            if (missingVehicles) {
                missingVehicles.forEach(v => {
                    vehicleCache[v.id] = v;
                });
            }
        }
        
        renderActivity();
    }

    // ============================================================
    // REALTIME SUBSCRIPTIONS (replaces polling)
    // ============================================================
    function setupRealtime() {
        const statusEl = document.getElementById('connectionStatus');
        
        // Subscribe to vehicles changes
        const vehicleChannel = db
            .channel('vehicles-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'vehicles' },
                (payload) => {
                    console.log('Vehicle change:', payload.eventType);
                    debouncedRefresh();
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    statusEl.classList.remove('disconnected');
                    statusEl.title = 'Connected - Live updates';
                } else {
                    statusEl.classList.add('disconnected');
                    statusEl.title = 'Disconnected - Reconnecting';
                }
            });

        // Subscribe to actions_log changes
        const logsChannel = db
            .channel('logs-changes')
            .on('postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'actions_log' },
                (payload) => {
                    console.log('New log entry');
                    debouncedRefresh();
                }
            )
            .subscribe();
    }

    // Debounce rapid changes (e.g., if 5 tabs open)
    function debouncedRefresh() {
        if (refreshTimeout) clearTimeout(refreshTimeout);
        refreshTimeout = setTimeout(() => {
            fetchVehicles();
            fetchLogs();
        }, 500); // Wait 500ms for changes to settle
    }

    // ============================================================
    // KPI CALCULATIONS (now simpler - vehicles only has active)
    // ============================================================
    function loadKPIs() {
        const totalIn = vehicles.length;
        
        const waits = vehicles.map(v => 
            Math.floor((Date.now() - new Date(v.check_in_time)) / 60000)
        );
        const avgWait = waits.length 
            ? Math.round(waits.reduce((a,b) => a+b, 0) / waits.length) 
            : 0;
        
        const overdue = vehicles.filter(v => {
            const due = new Date(v.due_time).getTime();
            return Date.now() > due + (30 * 60000);
        }).length;

        document.getElementById('kpiTotalIn').textContent = totalIn;
        document.getElementById('kpiTotalOut').textContent = releasedCount;
        document.getElementById('kpiAvgWait').textContent = avgWait;
        document.getElementById('kpiOverdue').textContent = overdue;
    }

    // ============================================================
    // RENDER QUEUE (unchanged logic, but faster data)
    // ============================================================
    function renderQueue() {
        const container = document.getElementById('queueList');
        container.innerHTML = '';
        
        if (vehicles.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px;">No vehicles in queue</div>';
            return;
        }
        
        vehicles.forEach(v => {
            const li = document.createElement('div');
            const now = Date.now();
            const dueTime = new Date(v.due_time).getTime();
            const minsLate = Math.floor((now - dueTime) / 60000);
            
            let cls = '';
            if (minsLate > 0) cls = minsLate > 90 ? 'critical' : 'overdue';
            
            const isExport = v.classification === 'export';
            li.className = `entry ${cls} ${isExport ? 'queue-export' : ''}`;
            li.onclick = () => openEditModal(v.id);
            
            li.innerHTML = `
                <div class="info">
                    <strong>${v.registration || '-'}</strong> - ${v.status}<br>
                    PO: ${v.po_ref || '-'} | Mobile: ${v.mobile_number || v.pager_number || '-'}<br>
                    In: ${new Date(v.check_in_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})} | Due: ${v.due_time ? new Date(v.due_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : '-'}
                </div>
                <div class="actions">
                    <button class="notify" onclick="event.stopPropagation(); notify('${v.id}')">Notify</button>
                    <button class="release" onclick="event.stopPropagation(); release('${v.id}')">Release</button>
                    <button class="undo" onclick="event.stopPropagation(); undo('${v.id}')">Undo</button>
                </div>
            `;
            container.appendChild(li);
        });
    }

    // ============================================================
    // RENDER ACTIVITY
    // ============================================================
    function renderActivity() {
        const container = document.getElementById('activityList');
        container.innerHTML = '';
        
        if (logs.length === 0) {
            container.innerHTML = '<div style="color:var(--muted);">No recent activity</div>';
            return;
        }
        
        logs.forEach(l => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            // Check active vehicles first, then cache for released ones
            const veh = vehicles.find(v => v.id === l.vehicle_id) || vehicleCache[l.vehicle_id] || {};
            const reg = veh.registration || '';
            const po = veh.po_ref || '';
            
            const op = operators.find(o => o.id === l.operator_id) || {};
            const name = op.name || 'Unknown';
            
            let actionVerb = '';
            switch(l.action) {
                case 'check_in': actionVerb = 'checked in'; break;
                case 'notified': actionVerb = 'notified'; break;
                case 'released': actionVerb = 'completed'; break;
                case 'undo': actionVerb = 'reverted'; break;
                case 'edit': actionVerb = 'edited'; break;
                default: actionVerb = l.action; break;
            }
            
            const dt = new Date(l.timestamp);
            const timeStr = dt.toLocaleString('en-GB', { 
                day:'2-digit', month:'2-digit', 
                hour:'2-digit', minute:'2-digit', second:'2-digit' 
            });
            
            item.textContent = `${reg} ${po} ${actionVerb} by ${name} - ${timeStr}`.trim();
            container.appendChild(item);
        });
    }

    // ============================================================
    // CHART (simplified - only uses active vehicles)
    // ============================================================
    function loadChart() {
        const ctx = document.getElementById('chartTrend').getContext('2d');
        const hours = [];
        const counts = [];
        const now = new Date();
        
        for (let i = 0; i < 12; i++) {
            const h = new Date(now.getTime() - (11 - i) * 60 * 60 * 1000);
            const label = h.getHours().toString().padStart(2, '0') + ':00';
            hours.push(label);
            
            const count = vehicles.filter(v => {
                const ci = new Date(v.check_in_time);
                return ci.getHours() === h.getHours() && 
                       ci.toDateString() === h.toDateString();
            }).length;
            counts.push(count);
        }
        
        if (chart) chart.destroy();
        
        const computedStyles = getComputedStyle(document.documentElement);
        const accent = computedStyles.getPropertyValue('--accent').trim() || '#0ea5e9';
        
        chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: hours, 
                datasets: [{ 
                    label: 'Active vehicles by check-in hour', 
                    data: counts, 
                    borderColor: accent, 
                    backgroundColor: accent + '33', 
                    borderWidth: 2, 
                    tension: 0.3 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { y: { beginAtZero: true } } 
            }
        });
    }

    // ============================================================
    // ACTION HANDLERS
    // ============================================================
    async function notify(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        
        const { error } = await db.from('vehicles')
            .update({ status: 'notified', notify_time: now })
            .eq('id', id);
        
        if (!error) {
            await db.from('actions_log').insert({ 
                vehicle_id: id, 
                action: 'notified', 
                timestamp: now, 
                operator_id: operator 
            });

            // Get vehicle details for SMS notification
            const { data: vehicle } = await db.from('vehicles').select('po_ref, mobile_number').eq('id', id).single();
            const phone = vehicle?.mobile_number || 'N/A';
            const po = vehicle?.po_ref || 'N/A';

            // Open SMS simulator for notification
            if (phone && phone !== 'N/A') {
                window.open(`sms_simulator.html?type=notified&phone=${encodeURIComponent(phone)}&po=${encodeURIComponent(po)}`,
                    "_blank",
                    "width=400,height=700");
            }

            // Realtime will trigger refresh, but do it immediately for responsiveness
            fetchVehicles();
            fetchLogs();
        }
    }

    async function release(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        
        // Get vehicle for duration calculation and contact info BEFORE updating
        const { data: vehicle } = await db.from('vehicles').select('*').eq('id', id).single();
        
        const { error } = await db.from('vehicles')
            .update({ status: 'released', release_time: now })
            .eq('id', id);
        
        if (!error) {
            await db.from('actions_log').insert({ 
                vehicle_id: id, 
                action: 'released', 
                timestamp: now, 
                operator_id: operator 
            });

            // Calculate duration and get contact info
            const checkIn = new Date(vehicle.check_in_time);
            const duration = Math.floor((new Date(now) - checkIn) / 60000);
            const phone = vehicle?.mobile_number || 'N/A';
            const po = vehicle?.po_ref || 'N/A';

            // Open SMS simulator for departure confirmation
            if (phone && phone !== 'N/A') {
                window.open(`sms_simulator.html?type=released&phone=${encodeURIComponent(phone)}&po=${encodeURIComponent(po)}&duration=${duration} mins`,
                    "_blank",
                    "width=400,height=700");
            }

            fetchVehicles();
            fetchLogs();
        }
    }

    async function undo(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        
        const { error } = await db.from('vehicles')
            .update({ status: 'parked', notify_time: null })
            .eq('id', id);
        
        if (!error) {
            await db.from('actions_log').insert({ 
                vehicle_id: id, 
                action: 'undo', 
                timestamp: now, 
                operator_id: operator 
            });
            fetchVehicles();
            fetchLogs();
        }
    }

    // ============================================================
    // ADD VEHICLE
    // ============================================================
function togglePanel() {
    const panel = document.getElementById('addPanel');
    if (!panel) return;
    panel.classList.toggle('panel-visible');
    // When the panel becomes visible, load any expected prebookings
    if (panel.classList.contains('panel-visible')) {
        // Populate the expected loads dropdown
        loadPrebooks();
    }
}

    async function submitVehicle() {
        const btn = document.querySelector('#addPanel .submit-btn');
        if (!btn) return;
        
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.6';

        // Normalise registration and fetch form values. Trim whitespace and
        // uppercase the registration, pull in the PO reference, haulier,
        // mobile number and notes. Mobile number is stored as null when
        // blank so Supabase won't parse an empty string as an integer.
        let reg = document.getElementById('regInput').value.trim().replace(/\s+/g, '').toUpperCase();
        let po = document.getElementById('poInput').value.trim();
        let haulier = document.getElementById('haulierInput').value.trim();
        let mobileInput = document.getElementById('mobileInput').value.trim();
        let mobile = mobileInput === '' ? null : mobileInput;
        let notes = document.getElementById('notesInput').value.trim();
        let quoted = parseInt(document.getElementById('quotedInput').value, 10);

        if (!reg) {
            alert('Registration required');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            return;
        }

        const operatorId = localStorage.getItem('operator_id') || null;
        const nowIso = new Date().toISOString();
        const dueIso = new Date(Date.now() + quoted * 60000).toISOString();
        // Determine if the user has flagged this load as export. When
        // applying a prebooking, prebookExportFlag synchronises the
        // checkbox state; reading it here suffices to set classification.
        const isExport = document.getElementById('addExport').checked;

        try {
            // Insert new vehicle with haulier and mobile details. Use
            // mobile_number column instead of pager_number to align with
            // ref_index implementation. Empty mobile values are passed as
            // null to prevent invalid integer parsing in Supabase.
            const { data, error } = await db.from('vehicles').insert({
                registration: reg,
                po_ref: po || null,
                haulier: haulier || null,
                mobile_number: mobile,
                notes: notes || null,
                quoted_minutes: quoted,
                check_in_time: nowIso,
                due_time: dueIso,
                status: 'parked',
                operator_id: operatorId,
                classification: isExport ? 'export' : 'normal'
            }).select();
            
            if (error) {
                alert('Error: ' + error.message);
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                return;
            }
            
            const vehicleId = data && data[0] && data[0].id;
            // Open QR code in a new window so the gatehouse can scan it
            window.open(`qr-screen.html?uid=${vehicleId}`, "_blank");
            // Open SMS simulator to send the check-in notification if a
            // mobile number was provided. This mirrors the functionality
            // implemented in ref_index.html.
            if (mobile) {
                window.open(
                    `sms_simulator.html?type=check_in&phone=${encodeURIComponent(mobile)}&po=${encodeURIComponent(po || 'N/A')}&quoted=${quoted}`,
                    "_blank",
                    "width=400,height=700"
                );
            }
            
            await db.from('actions_log').insert({
                vehicle_id: vehicleId,
                action: 'check_in',
                timestamp: nowIso,
                operator_id: operatorId
            });

            // If a prebooking was used, mark it as consumed so it no longer
            // appears in the expected loads dropdown on subsequent adds.
            const selectedPrebookId = document.getElementById('prebookSelect').value;
            if (selectedPrebookId) {
                await db.from('prebookings').update({ consumed: true }).eq('id', selectedPrebookId);
            }
            
            // Realtime will trigger, but refresh immediately
            await fetchVehicles();
            await fetchLogs();
            
            togglePanel();
            // Reset form fields to prepare for the next entry
            document.getElementById('regInput').value = '';
            document.getElementById('poInput').value = '';
            const hInp = document.getElementById('haulierInput');
            if (hInp) hInp.value = '';
            const mInp = document.getElementById('mobileInput');
            if (mInp) mInp.value = '';
            document.getElementById('notesInput').value = '';
            document.getElementById('quotedInput').value = '60';
            document.getElementById('addExport').checked = false;
            const pbSel = document.getElementById('prebookSelect');
            if (pbSel) pbSel.value = '';
            prebookExportFlag = false;
    } finally {
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        }
    }

    // ----------------------------------------------------------------------
    // PREBOOKING HELPERS
    // ----------------------------------------------------------------------
    // Load expected loads from the prebookings table. This populates the
    // dropdown with any unconsumed prebooked loads so operators can pick
    // them when adding a new lorry. Results are cached in prebookCache.
    async function loadPrebooks() {
        const sel = document.getElementById('prebookSelect');
        if (!sel) return;
        // Reset options to the default placeholder
        sel.innerHTML = `<option value="">-- Select Expected Load --</option>`;
        try {
            const { data } = await db
                .from('prebookings')
                .select('*')
                .eq('consumed', false)
                .order('expected_date', { ascending: true })
                .order('expected_time', { ascending: true });
            if (!data) return;
            prebookCache = data;
            data.forEach(p => {
                const label = `${p.po_ref || 'No PO'} - ${p.registration || 'No Reg'} - ${p.expected_date || ''} ${p.expected_time?.slice(0,5) || ''}${p.is_export ? ' - EXPORT' : ''}`;
                sel.innerHTML += `<option value="${p.id}">${label}</option>`;
            });
        } catch (err) {
            console.error('Failed to load prebooks', err);
        }
    }

    // Apply selected prebook values to the Add Lorry form. When a
    // prebooked load is chosen, copy its PO, registration, notes and haulier
    // into the corresponding input fields and set the export flag if needed.
    function applyPrebook() {
        const sel = document.getElementById('prebookSelect');
        if (!sel) return;
        const id = sel.value;
        if (!id) return;
        // convert to number for comparison; some IDs may be strings
        const pb = prebookCache.find(x => String(x.id) === String(id));
        if (!pb) return;
        const poInput = document.getElementById('poInput');
        const regInput = document.getElementById('regInput');
        const notesInput = document.getElementById('notesInput');
        const haulierInput = document.getElementById('haulierInput');
        if (poInput) poInput.value = pb.po_ref || '';
        if (regInput) regInput.value = pb.registration || '';
        if (notesInput) notesInput.value = pb.notes || '';
        if (haulierInput) haulierInput.value = pb.haulier || '';
        // remember if this prebooking is an export load and reflect that on
        // the checkbox. some prebookings may specify is_export on the row.
        prebookExportFlag = pb.is_export === true;
        const exportChk = document.getElementById('addExport');
        if (exportChk) exportChk.checked = prebookExportFlag;
    }

    // ============================================================
    // MANUAL REFRESH (fallback)
    // ============================================================
    function manualRefresh() {
        fetchVehicles();
        fetchOperators();
        fetchLogs();
    }

    // ============================================================
    // CLOCK
    // ============================================================
    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', minute: '2-digit', second: '2-digit' 
        });
        const clk = document.getElementById('clock');
        if (clk) clk.textContent = timeStr;
    }

    // ============================================================
    // AVATAR / LOGOUT
    // ============================================================
    function logoutUser() {
        localStorage.removeItem('operator_id');
        window.location.href = 'login.html';
    }

    document.addEventListener('click', (e) => {
        const btn = document.getElementById('avatarBtn');
        const menu = document.getElementById('avatarMenu');
        if (!btn || !menu) return;
        if (btn.contains(e.target)) {
            menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
        } else if (!menu.contains(e.target)) {
            menu.style.display = 'none';
        }
    });

    (async () => {
        const opId = localStorage.getItem('operator_id');
        if (!opId) return;
        try {
            const { data: op } = await db.from('operators').select('name').eq('id', opId).single();
            const opName = op?.name || 'Unknown';
            const menuName = document.getElementById('menuName');
            const avatarBtn = document.getElementById('avatarBtn');
            if (menuName) menuName.textContent = opName;
            if (avatarBtn) {
                const initials = opName.split(' ').map(x => (x[0] || '').toUpperCase()).join('').slice(0, 2);
                avatarBtn.textContent = initials || '??';
            }
        } catch (err) {
            console.error('Failed to load operator:', err);
        }
    })();

    // ============================================================
    // EDIT MODAL
    // ============================================================
    let currentEditId = null;
    
    function openEditModal(id) {
        const veh = vehicles.find(v => v.id === id);
        if (!veh) return;
        currentEditId = id;
        
        document.getElementById('editReg').value = veh.registration || '';
        document.getElementById('editPO').value = veh.po_ref || '';
        // Prefer mobile_number on the record; fallback to pager_number for older rows
        const editMobile = document.getElementById('editMobile');
        if (editMobile) editMobile.value = veh.mobile_number || veh.pager_number || '';
        document.getElementById('editNotes').value = veh.notes || '';
        document.getElementById('editModalOverlay').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModalOverlay').style.display = 'none';
        currentEditId = null;
    }

    async function saveEditModal() {
        if (!currentEditId) { closeEditModal(); return; }
        
        const regVal = document.getElementById('editReg').value.trim().toUpperCase();
        const poVal = document.getElementById('editPO').value.trim();
        const mobileVal = document.getElementById('editMobile').value.trim();
        const notesVal = document.getElementById('editNotes').value.trim();
        const operatorId = localStorage.getItem('operator_id') || null;
        
        const updates = {
            registration: regVal,
            po_ref: poVal || null,
            mobile_number: mobileVal === '' ? null : mobileVal,
            notes: notesVal || null,
            operator_id: operatorId
        };
        
        try {
            const { error } = await db.from('vehicles').update(updates).eq('id', currentEditId);
            if (error) {
                alert('Error updating record: ' + error.message);
                return;
            }
            
            const nowIso = new Date().toISOString();
            await db.from('actions_log').insert({
                vehicle_id: currentEditId,
                action: 'edit',
                timestamp: nowIso,
                operator_id: operatorId
            });
            
            await fetchVehicles();
            await fetchLogs();
            closeEditModal();
        } catch (err) {
            console.error('Edit save failed:', err);
            alert('Failed to save changes');
        }
    }

    // ============================================================
    // INITIALIZATION
    // ============================================================
    (async function init() {
        updateClock();
        setInterval(updateClock, 1000);
        
        // Initial data load
        await fetchOperators();
        await fetchVehicles();
        await fetchLogs();
        
        // Setup realtime (replaces setInterval polling)
        setupRealtime();
        
        // Fallback: light polling every 60s in case realtime disconnects
        setInterval(() => {
            fetchVehicles();
            fetchLogs();
        }, 60000);
    })();
    </script>

    <!-- Modal overlay for editing vehicles -->
    <div id="editModalOverlay">
        <div id="editModal">
            <h3 style="margin-top:0; margin-bottom:8px; font-size:20px; color: var(--accent);">Edit Vehicle</h3>
            <label for="editReg">Registration</label>
            <input type="text" id="editReg">
            <label for="editPO">PO / Reference</label>
            <input type="text" id="editPO">
            <label for="editMobile">Mobile Number</label>
            <input type="text" id="editMobile">
            <label for="editNotes">Notes</label>
            <textarea id="editNotes"></textarea>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveEditModal()">Save</button>
            </div>
        </div>
    </div>
</body>
</html>
FILE: supervisor.html (Supervisor Dashboard)
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supervisor Intervention Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    :root {
        --bg: #0a0e14;
        --card: #151a23;
        --text: #e6e8eb;
        --muted: #6b7280;
        --accent: #3b82f6;
        --border: #1f2937;

        --critical: #ef4444;
        --warning: #f59e0b;
        --ok: #10b981;
        --export: #8b5cf6;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        line-height: 1.5;
    }

    /* HEADER LAYOUT - MATCHING INDEX EXACTLY */
    .header {
        background: var(--card);
        padding: 16px 24px;
        border-bottom: 2px solid var(--border);
        display: flex;
        align-items: center;
        /* Removed justify-content: space-between to allow flex-1 centering */
    }

    /* Three-column layout for perfect centering */
    .header-left {
        flex: 1;
        display: flex;
        align-items: center;
        font-size: 20px;
        font-weight: 600;
        color: var(--text);
    }
    
    .header-clock {
        flex: 1;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        color: var(--text);
    }

    .header-right {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 16px;
        position: relative;
        font-size: 14px;
        color: var(--muted);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--ok);
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* AVATAR + MENU */
    #avatarBtn {
        width: 38px; height: 38px; border-radius: 50%;
        background: var(--bg);
        border: 1px solid var(--border);
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; color: var(--accent);
        cursor: pointer; user-select: none;
    }
    #avatarMenu {
        position: absolute; top: 48px; right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px; min-width: 150px;
        padding: 4px 0; display: none; z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #avatarMenu > div {
        padding: 8px 12px; cursor: pointer; font-size: 14px; color: var(--text);
    }
    #avatarMenu > div:hover { background: var(--accent); color: #fff; }


    /* MAIN LAYOUT */
    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 24px;
    }

    /* ZONE */
    .zone {
        background: var(--card);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 2px solid var(--border);
    }
    .zone-critical {
        border-color: var(--critical);
        background: linear-gradient(135deg, rgba(239,68,68,0.05), transparent);
    }
    .zone-warning {
        border-color: var(--warning);
        background: linear-gradient(135deg, rgba(245,158,11,0.05), transparent);
    }

    .zone-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }
    .zone-title {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .badge-critical {
        background: var(--critical);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
    }
    .badge-warning {
        background: var(--warning);
        color: #000;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
    }

    /* INTERVENTION CARDS */
    .intervention-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }
    .intervention-card:hover {
        background: rgba(255,255,255,0.05);
        transform: translateY(-2px);
    }

    .card-left {
        flex: 1;
    }
    .card-reg {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 4px;
    }
    .card-meta {
        font-size: 13px;
        color: var(--muted);
        display: flex;
        gap: 16px;
        margin-top: 8px;
    }
    .card-alert {
        font-size: 14px;
        color: var(--critical);
        font-weight: 500;
        margin-top: 6px;
    }

    .card-right {
        display: flex;
        gap: 8px;
    }
    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-view {
        background: var(--accent);
        color: white;
    }
    .btn-view:hover {
        background: #2563eb;
    }

    /* EXPORT BADGE */
    .export-badge {
        display: inline-block;
        background: var(--export);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        margin-left: 8px;
    }

    /* STATS GRID */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .stat-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 4px;
    }
    .stat-label {
        font-size: 13px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    /* MODAL OVERLAY */
    #modalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.75);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(4px);
    }
    #modalOverlay.active {
        display: flex;
    }

    #caseModal {
        background: var(--card);
        border: 2px solid var(--border);
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--card);
        z-index: 10;
    }
    .modal-title {
        font-size: 22px;
        font-weight: 700;
    }
    .modal-close {
        background: transparent;
        border: none;
        font-size: 28px;
        color: var(--muted);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-close:hover {
        color: var(--text);
    }

    .modal-body {
        padding: 24px;
    }

    .modal-section {
        margin-bottom: 28px;
    }
    .modal-section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 12px;
        font-size: 14px;
    }
    .info-label {
        color: var(--muted);
        font-weight: 500;
    }
    .info-value {
        color: var(--text);
    }

    .timeline-item {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        padding-left: 20px;
        border-left: 2px solid var(--border);
        padding-bottom: 12px;
    }
    .timeline-item:last-child {
        border-left-color: transparent;
    }
    .timeline-time {
        font-size: 13px;
        color: var(--muted);
        min-width: 60px;
    }
    .timeline-event {
        font-size: 14px;
        color: var(--text);
    }

    .supervisor-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }
    .action-btn {
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.05);
        color: var(--text);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .action-btn:hover {
        background: rgba(255,255,255,0.1);
        transform: translateY(-2px);
    }
    .action-btn-primary {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
    }
    .action-btn-primary:hover {
        background: #2563eb;
    }

    .note-input {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: rgba(255,255,255,0.05);
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
        margin-top: 8px;
    }
    .note-input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-parked { background: #fbbf24; color: #000; }
    .status-notified { background: #3b82f6; color: white; }
    .status-released { background: #10b981; color: white; }

    /* ============================================================
       COMMAND PALETTE (Ctrl+K) - Inline Integration
       ============================================================ */
    #cmdOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding-top: 100px;
        z-index: 20000;
        animation: cmdFadeIn 0.15s ease;
    }
    #cmdOverlay.active { display: flex; }
    @keyframes cmdFadeIn { from { opacity: 0; } to { opacity: 1; } }

    #cmdPalette {
        width: 600px;
        max-width: 90vw;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        overflow: hidden;
        animation: cmdSlideDown 0.2s ease;
    }
    @keyframes cmdSlideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    #cmdInput {
        width: 100%; padding: 20px; font-size: 18px;
        background: transparent; border: none;
        color: var(--text); outline: none;
        border-bottom: 1px solid var(--border);
    }
    #cmdInput::placeholder { color: var(--muted); }

    #cmdResults { max-height: 400px; overflow-y: auto; padding: 12px; }

    .cmd-result-item {
        padding: 14px 16px; margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px; border-left: 3px solid var(--accent);
        cursor: pointer; transition: all 0.2s;
    }
    .cmd-result-item:hover { background: rgba(255, 255, 255, 0.08); transform: translateX(2px); }
    .cmd-hint { padding: 20px; text-align: center; color: var(--muted); font-size: 14px; }
    .cmd-suggestions { padding: 16px; border-top: 1px solid var(--border); }
    .cmd-suggestions-title { font-size: 12px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
    .cmd-tag {
        display: inline-block; padding: 6px 12px; margin: 4px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border); border-radius: 6px;
        font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .cmd-tag:hover { background: rgba(59, 130, 246, 0.2); border-color: var(--accent); }

    .cmd-metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; padding: 16px; }
    .cmd-metric-card { background: rgba(255, 255, 255, 0.03); padding: 16px; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
    .cmd-metric-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .cmd-metric-value.cmd-danger { color: var(--critical); }
    .cmd-metric-value.cmd-warning { color: var(--warning); }
    .cmd-metric-value.cmd-success { color: var(--ok); }
    .cmd-metric-label { font-size: 12px; color: var(--muted); text-transform: uppercase; }

    .cmd-detail-list { padding: 16px; }
    .cmd-detail-item {
        padding: 12px; margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px; font-size: 14px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .cmd-detail-item strong { font-weight: 600; }
    .cmd-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .cmd-badge-critical { background: var(--critical); color: white; }
    .cmd-badge-warning { background: var(--warning); color: black; }
    .cmd-badge-normal { background: var(--ok); color: white; }

    /* Navigation bar */
    .main-nav {
        background: #1e3a5f; padding: 0;
        display: flex; align-items: center; justify-content: center;
        border-bottom: 1px solid #1f2937;
    }
    .main-nav a {
        color: #e6e8eb; text-decoration: none;
        padding: 14px 24px; font-size: 14px; font-weight: 600;
        letter-spacing: 0.5px; transition: all 0.2s;
    }
    .main-nav a:hover { background: rgba(255,255,255,0.1); }
    .main-nav a.active { background: rgba(255,255,255,0.15); color: #fff; }
    .nav-divider { color: #64748b; font-size: 18px; user-select: none; }

</style>
</head>

<body>

<div id="versionBanner" style="
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: white; padding: 4px 12px;
    border-radius: 4px; font-size: 12px; font-weight: 600; z-index: 9999;
">v3.1.5 - DEV BUILD</div>

<!-- HEADER (Now matching Index exactly) -->
<div class="header">
    <div class="header-left">
        <h1>&#9889; Supervisor Intervention Dashboard</h1>
    </div>
    
    <!-- Centered Clock -->
    <div id="clockTime" class="header-clock">--:--</div>
    
    <div class="header-right">
        <!-- Live Status -->
        <div style="display: flex; align-items: center; gap: 8px;">
            <div class="status-dot"></div>
            <span>Live</span>
        </div>
        
        <!-- Avatar + dropdown -->
        <div style="position: relative;">
            <div id="avatarBtn">??</div>
            <div id="avatarMenu">
                <div id="menuName">Loading...</div>
                <div onclick="logoutUser()">Logout</div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<nav class="main-nav">
    <a href="index.html">QUEUE</a>
    <span class="nav-divider">|</span>
    <a href="arrivals.html">ARRIVALS</a>
    <span class="nav-divider">|</span>
    <a href="supervisor.html" class="active">SUPERVISOR</a>
</nav>

<div class="container">

    <!-- SEARCH BAR -->
    <div style="margin-bottom: 24px;">
        <input
            id="superSearch"
            type="text"
            placeholder="Search by registration or PO..."
            style="
                width:100%; padding:14px; font-size:16px;
                border-radius:8px; border:1px solid var(--border);
                background:var(--card); color:var(--text);
            ">
    </div>

    <div id="superSearchResults" style="margin-bottom:24px;"></div>

    <!-- QUICK STATS -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="statInYard">0</div>
            <div class="stat-label">In Yard</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statNeedsAction">0</div>
            <div class="stat-label">Needs Action</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statAvgWait">0m</div>
            <div class="stat-label">Avg Wait</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statReleasedToday">0</div>
            <div class="stat-label">Released Today</div>
        </div>
    </div>

    <!-- CRITICAL ZONE -->
    <div class="zone zone-critical" id="criticalZone">
        <div class="zone-header">
            <div class="zone-title">
                &#128680; URGENT
                <span class="badge-critical" id="criticalCount">0 vehicles</span>
            </div>
            <span style="font-size: 13px; color: var(--muted);">Overdue >90 mins or critical issues</span>
        </div>
        <div id="criticalList"></div>
    </div>

    <!-- WATCH LIST -->
    <div class="zone zone-warning" id="watchZone">
        <div class="zone-header">
            <div class="zone-title">
                &#9888; WATCH LIST
                <span class="badge-warning" id="watchCount">0 vehicles</span>
            </div>
            <span style="font-size: 13px; color: var(--muted);">Approaching quoted time</span>
        </div>
        <div id="watchList"></div>
    </div>

</div>

<!-- MODAL -->
<div id="modalOverlay">
    <div id="caseModal">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Vehicle Details</div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            
            <!-- SUMMARY BAR - Quick glance status -->
            <div id="modalSummaryBar" style="
                display: flex; gap: 12px; margin-bottom: 24px; padding: 16px;
                background: rgba(255,255,255,0.03); border-radius: 8px;
                border: 1px solid var(--border);
            ">
                <div style="flex: 1; text-align: center; border-right: 1px solid var(--border);">
                    <div style="font-size: 28px; font-weight: 700;" id="modalTotalWait">-</div>
                    <div style="font-size: 12px; color: var(--muted); text-transform: uppercase;">Total Wait</div>
                </div>
                <div style="flex: 1; text-align: center; border-right: 1px solid var(--border);">
                    <div style="font-size: 28px; font-weight: 700;" id="modalQuoted">-</div>
                    <div style="font-size: 12px; color: var(--muted); text-transform: uppercase;">Quoted</div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700;" id="modalVariance">-</div>
                    <div style="font-size: 12px; color: var(--muted); text-transform: uppercase;">Variance</div>
                </div>
            </div>

            <!-- VEHICLE IDENTITY -->
            <div class="modal-section">
                <div class="modal-section-title">Vehicle Identity</div>
                <div class="info-grid">
                    <div class="info-label">Registration</div>
                    <div class="info-value" id="modalReg">-</div>
                    
                    <div class="info-label">Status</div>
                    <div class="info-value" id="modalStatus">-</div>
                    
                    <div class="info-label">PO / Reference</div>
                    <div class="info-value" id="modalPO">-</div>
                    
                    <div class="info-label">Mobile Number</div>
                    <div class="info-value" id="modalMobile">-</div>
                    
                    <div class="info-label">Classification</div>
                    <div class="info-value" id="modalClassification">-</div>
                </div>
            </div>

            <!-- TIME ANALYSIS -->
            <div class="modal-section">
                <div class="modal-section-title">Time Analysis</div>
                <div id="modalTimelineBar" style="display: flex; align-items: center; margin-bottom: 20px; padding: 12px 0;"></div>
                <div id="modalStageTable" style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;"></div>
            </div>

            <!-- ACTIVITY LOG -->
            <div class="modal-section">
                <div class="modal-section-title">Activity Log</div>
                <div id="modalActivityLog" style="
                    max-height: 200px; overflow-y: auto;
                    background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;
                "></div>
            </div>

            <!-- NOTES -->
            <div class="modal-section">
                <div class="modal-section-title">Notes</div>
                <div id="modalNotes" style="
                    padding: 12px; background: rgba(255,255,255,0.03); 
                    border-radius: 6px; font-size: 14px; color: var(--text);
                    white-space: pre-wrap; max-height: 150px; overflow-y: auto;
                ">-</div>
            </div>

            <!-- SUPERVISOR ACTIONS -->
            <div class="modal-section">
                <div class="modal-section-title">Supervisor Actions</div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 6px; color: var(--muted);">Change Status</label>
                    <select id="changeStatusSelect" style="
                        width: 100%; padding: 12px; margin-bottom: 8px;
                        background: #0a0e14; border: 1px solid var(--border);
                        border-radius: 6px; color: var(--text); font-size: 14px;"
                        onchange="changeStatus(this.value)">
                        <option value="parked">parked</option>
                        <option value="notified">notified</option>
                        <option value="released">released</option>
                    </select>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 6px; color: var(--muted);">Add Supervisor Note</label>
                    <textarea id="supervisorNote" class="note-input" placeholder="Enter note about this case..."></textarea>
                    <button class="action-btn action-btn-primary" style="margin-top: 8px; width: auto;" onclick="addSupervisorNote()">
                        &#128190; Save Note
                    </button>
                </div>

                <div class="supervisor-actions">
                    <button class="action-btn" onclick="markUnderReview()">&#128269;Mark Under Review</button>
                    <button class="action-btn" onclick="markSupervisorAware()">&#10003; Mark Supervisor Aware</button>
                    <button class="action-btn" onclick="sendDriverSMS()" title="Feature coming soon">&#128241; SMS Driver</button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- EDIT MODAL -->
<div id="superEditOverlay" style="
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.75); display:none;
    align-items: center; justify-content: center;
    z-index:10001; backdrop-filter: blur(4px);">
    <div id="superEditModal" style="
        background:var(--card); color:var(--text);
        width:90%; max-width:500px; padding:28px;
        border-radius:12px; border:2px solid var(--border);
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
    </div>
</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ==================== SUPABASE SETUP ====================
const db = supabase.createClient(
    "https://gtixdparpjdpyhhubsfz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
);

let currentVehicle = null;
let operators = [];

// ==================== AUTH CHECK & AVATAR POPULATION ====================
(async () => {
    const opId = localStorage.getItem("operator_id");
    if (!opId) {
        window.location.href = "login.html";
        return;
    }

    const { data: op } = await db
        .from("operators")
        .select("name, role")
        .eq("id", opId)
        .single();

    if (!op) {
        window.location.href = "login.html";
        return;
    }

    // Populate Avatar functionality
    const menuName = document.getElementById('menuName');
    const avatarBtn = document.getElementById('avatarBtn');
    
    if (menuName) menuName.textContent = op.name;
    if (avatarBtn) {
        const initials = op.name.split(' ').map(x => (x[0] || '').toUpperCase()).join('').slice(0, 2);
        avatarBtn.textContent = initials || '??';
    }

})();

// ==================== AVATAR MENU LOGIC ====================
function logoutUser() {
    localStorage.removeItem('operator_id');
    window.location.href = 'login.html';
}

document.addEventListener('click', (e) => {
    const btn = document.getElementById('avatarBtn');
    const menu = document.getElementById('avatarMenu');
    if (!btn || !menu) return;
    if (btn.contains(e.target)) {
        menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
    } else if (!menu.contains(e.target)) {
        menu.style.display = 'none';
    }
});

// ==================== LOAD OPERATORS ====================
async function loadOperators() {
    const { data } = await db
        .from("operators")
        .select("id, name");
    operators = data || [];
}

// ==================== LOAD DASHBOARD ====================
async function loadDashboard() {
    try {
        const { data: vehicles } = await db
            .from("vehicles")
            .select("*")
            .in("status", ["parked", "notified"])
            .order("check_in_time", { ascending: true });

        if (!vehicles) return;

        const now = Date.now();

        // Calculate stats
        const inYard = vehicles.length;
        const releasedTodayQuery = await db
            .from("vehicles")
            .select("id")
            .eq("status", "released")
            .gte("release_time", new Date().toISOString().slice(0, 10));
        const releasedToday = releasedTodayQuery.data?.length || 0;

        let totalWait = 0;
        vehicles.forEach(v => {
            const checkIn = new Date(v.check_in_time).getTime();
            totalWait += (now - checkIn);
        });
        const avgWait = vehicles.length > 0 ? Math.floor(totalWait / vehicles.length / 60000) : 0;

        const critical = [];
        const watchList = [];

        vehicles.forEach(v => {
            const dueTime = new Date(v.due_time).getTime();
            const overdueMinutes = Math.floor((now - dueTime) / 60000);

            if (overdueMinutes >= 90) {
                critical.push({ ...v, overdueMinutes });
            } else if (overdueMinutes >= 0 || overdueMinutes >= -30) {
                watchList.push({ ...v, overdueMinutes });
            }
        });

        document.getElementById("statInYard").textContent = inYard;
        document.getElementById("statNeedsAction").textContent = critical.length;
        document.getElementById("statAvgWait").textContent = avgWait + "m";
        document.getElementById("statReleasedToday").textContent = releasedToday;

        document.getElementById("criticalCount").textContent = critical.length + " vehicle" + (critical.length !== 1 ? "s" : "");
        document.getElementById("watchCount").textContent = watchList.length + " vehicle" + (watchList.length !== 1 ? "s" : "");

        renderCriticalList(critical);
        renderWatchList(watchList);

    } catch (error) {
        console.error("Error loading dashboard:", error);
    }
}

// ==================== RENDER LISTS ====================
function renderCriticalList(vehicles) {
    const container = document.getElementById("criticalList");
    if (vehicles.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#9989;</div><div style="font-size: 16px; font-weight: 600;">All Clear</div><div style="font-size: 14px;">No critical interventions needed</div></div>`;
        return;
    }
    container.innerHTML = vehicles.map(v => {
        const exportBadge = v.classification === "export" ? '<span class="export-badge">EXPORT</span>' : '';
        const mobile = v.mobile_number || v.pager_number || "No mobile";
        return `
            <div class="intervention-card">
                <div class="card-left">
                    <div class="card-reg">${v.registration} ${exportBadge}</div>
                    <div class="card-alert">&#128293; ${v.overdueMinutes} minutes overdue</div>
                    <div class="card-meta">
                        <span>&#128203; PO: ${v.po_ref || "-"}</span>
                        <span>&#128241; ${mobile}</span>
                        <span>&#10003; ${v.status === "parked" ? "Parked" : "Notified"}</span>
                    </div>
                </div>
                <div class="card-right">
                    <button class="btn btn-view" onclick="openCaseModal('${v.id}')">View Case</button>
                </div>
            </div>`;
    }).join("");
}

function renderWatchList(vehicles) {
    const container = document.getElementById("watchList");
    if (vehicles.length === 0) {
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--muted);">No vehicles approaching quoted time</div>`;
        return;
    }
    container.innerHTML = vehicles.map(v => {
        const exportBadge = v.classification === "export" ? '<span class="export-badge">EXPORT</span>' : '';
        const mobile = v.mobile_number || v.pager_number || "No mobile";
        const timeUntilDue = v.overdueMinutes < 0 ? Math.abs(v.overdueMinutes) + " mins until overdue" : v.overdueMinutes + " mins overdue";
        return `
            <div class="intervention-card">
                <div class="card-left">
                    <div class="card-reg">${v.registration} ${exportBadge}</div>
                    <div style="font-size: 14px; color: var(--warning);">&#9888; ${timeUntilDue}</div>
                    <div class="card-meta">
                        <span>&#128203; PO: ${v.po_ref || "-"}</span>
                        <span>&#128241; ${mobile}</span>
                        <span>&#10003; ${v.status === "parked" ? "Parked" : "Notified"}</span>
                    </div>
                </div>
                <div class="card-right">
                    <button class="btn btn-view" onclick="openCaseModal('${v.id}')">View Case</button>
                </div>
            </div>`;
    }).join("");
}

// ==================== OPEN CASE MODAL ====================
async function openCaseModal(vehicleId) {
    try {
        const { data: vehicle } = await db.from("vehicles").select("*").eq("id", vehicleId).single();
        if (!vehicle) return;
        currentVehicle = vehicle;

        const { data: logs } = await db.from("actions_log").select("*").eq("vehicle_id", vehicleId).order("timestamp", { ascending: true });

        const now = Date.now();
        const checkInTime = new Date(vehicle.check_in_time);
        const notifyTime = vehicle.notify_time ? new Date(vehicle.notify_time) : null;
        const releaseTime = vehicle.release_time ? new Date(vehicle.release_time) : null;
        const quoted = vehicle.quoted_minutes || 0;

        const endTime = releaseTime || now;
        const totalWaitMins = Math.floor((endTime - checkInTime.getTime()) / 60000);

        let checkInToNotify = null;
        let notifyToRelease = null;
        let notifyToNow = null;

        if (notifyTime) {
            checkInToNotify = Math.floor((notifyTime.getTime() - checkInTime.getTime()) / 60000);
            if (releaseTime) {
                notifyToRelease = Math.floor((releaseTime.getTime() - notifyTime.getTime()) / 60000);
            } else {
                notifyToNow = Math.floor((now - notifyTime.getTime()) / 60000);
            }
        }

        const variance = totalWaitMins - quoted;

        document.getElementById("modalTotalWait").textContent = totalWaitMins + "m";
        document.getElementById("modalTotalWait").style.color = variance > 0 ? "var(--critical)" : "var(--ok)";
        document.getElementById("modalQuoted").textContent = quoted + "m";
        const varianceEl = document.getElementById("modalVariance");
        if (variance > 0) {
            varianceEl.textContent = "+" + variance + "m";
            varianceEl.style.color = "var(--critical)";
        } else if (variance < 0) {
            varianceEl.textContent = variance + "m";
            varianceEl.style.color = "var(--ok)";
        } else {
            varianceEl.textContent = "0m";
            varianceEl.style.color = "var(--text)";
        }

        document.getElementById("modalTitle").textContent = vehicle.registration;
        document.getElementById("modalReg").textContent = vehicle.registration;
        const statusClass = `status-${vehicle.status}`;
        document.getElementById("modalStatus").innerHTML = `<span class="status-badge ${statusClass}">${vehicle.status}</span>`;
        document.getElementById("modalPO").textContent = vehicle.po_ref || "-";
        document.getElementById("modalMobile").textContent = vehicle.mobile_number || vehicle.pager_number || "-";
        document.getElementById("modalClassification").textContent = vehicle.classification === "export" ? " EXPORT" : "Normal";

        const statusSelect = document.getElementById("changeStatusSelect");
        if (statusSelect) statusSelect.value = vehicle.status;

        const timelineBarEl = document.getElementById("modalTimelineBar");
        let segments = [];
        if (vehicle.status === "released" && notifyTime && releaseTime) {
            const total = totalWaitMins || 1;
            const seg1Pct = Math.round((checkInToNotify / total) * 100);
            const seg2Pct = 100 - seg1Pct;
            segments = [
                { label: "Check-in  Notify", mins: checkInToNotify, pct: seg1Pct, color: "var(--warning)" },
                { label: "Notify  Release", mins: notifyToRelease, pct: seg2Pct, color: "var(--ok)" }
            ];
        } else if (notifyTime) {
            const total = totalWaitMins || 1;
            const seg1Pct = Math.round((checkInToNotify / total) * 100);
            const seg2Pct = 100 - seg1Pct;
            segments = [
                { label: "Check-in  Notify", mins: checkInToNotify, pct: seg1Pct, color: "var(--warning)" },
                { label: "Notify  Now", mins: notifyToNow, pct: seg2Pct, color: "var(--accent)", active: true }
            ];
        } else {
            segments = [
                { label: "Check-in  Now", mins: totalWaitMins, pct: 100, color: "var(--warning)", active: true }
            ];
        }

        timelineBarEl.innerHTML = `
            <div style="width: 100%; display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; height: 24px; border-radius: 4px; overflow: hidden;">
                    ${segments.map(s => `
                        <div style="width: ${s.pct}%; background: ${s.color}; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #000; ${s.active ? 'animation: pulse 2s infinite;' : ''}">${s.mins}m</div>
                    `).join('')}
                </div>
                <div style="display: flex; font-size: 11px; color: var(--muted);">
                    ${segments.map(s => `<div style="width: ${s.pct}%; text-align: center;">${s.label}</div>`).join('')}
                </div>
            </div>`;

        const stageTableEl = document.getElementById("modalStageTable");
        let checkInOp = "Unknown", notifyOp = "Unknown", releaseOp = "Unknown";
        logs?.forEach(log => {
            const op = operators.find(o => o.id === log.operator_id);
            const opName = op?.name || "Unknown";
            if (log.action === "check_in") checkInOp = opName;
            if (log.action === "notified" || log.action === "notify") notifyOp = opName;
            if (log.action === "released" || log.action === "completed") releaseOp = opName;
        });

        const formatTime = (d) => d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" });
        const formatDate = (d) => d.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit" });

        let stageRows = [];
        stageRows.push({ stage: "Check-in", time: formatTime(checkInTime), date: formatDate(checkInTime), duration: "-", operator: checkInOp, highlight: false });
        if (notifyTime) {
            const delayFlag = checkInToNotify > quoted ? ' ' : '';
            stageRows.push({ stage: "Notified", time: formatTime(notifyTime), date: formatDate(notifyTime), duration: `+${checkInToNotify}m${delayFlag}`, operator: notifyOp, highlight: checkInToNotify > quoted });
        }
        if (releaseTime) {
            stageRows.push({ stage: "Released", time: formatTime(releaseTime), date: formatDate(releaseTime), duration: notifyTime ? `+${notifyToRelease}m` : `+${totalWaitMins}m`, operator: releaseOp, highlight: false });
        }
        if (!releaseTime) {
            const currentDuration = notifyTime ? notifyToNow : totalWaitMins;
            const overdueFlag = variance > 0 ? ' ' : '';
            stageRows.push({ stage: vehicle.status === "notified" ? "Waiting (notified)" : "Waiting (parked)", time: "NOW", date: "-", duration: `+${currentDuration}m${overdueFlag}`, operator: "-", highlight: variance > 0, active: true });
        }

        const totalColor = variance > 0 ? "var(--critical)" : (variance < 0 ? "var(--ok)" : "var(--text)");
        const varianceText = variance > 0 ? `+${variance}m over` : (variance < 0 ? `${Math.abs(variance)}m under` : "on time");

        stageTableEl.innerHTML = `
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.05);">
                        <th style="padding: 10px 12px; text-align: left; color: var(--muted); font-weight: 500;">Stage</th>
                        <th style="padding: 10px 12px; text-align: left; color: var(--muted); font-weight: 500;">Time</th>
                        <th style="padding: 10px 12px; text-align: left; color: var(--muted); font-weight: 500;">Duration</th>
                        <th style="padding: 10px 12px; text-align: left; color: var(--muted); font-weight: 500;">Operator</th>
                    </tr>
                </thead>
                <tbody>
                    ${stageRows.map(row => `
                        <tr style="${row.highlight ? 'background: rgba(239,68,68,0.1);' : ''} ${row.active ? 'background: rgba(59,130,246,0.1);' : ''}">
                            <td style="padding: 10px 12px; border-top: 1px solid var(--border);">${row.stage}</td>
                            <td style="padding: 10px 12px; border-top: 1px solid var(--border);">${row.time} <span style="font-size: 11px; color: var(--muted); margin-left: 4px;">${row.date !== '-' ? row.date : ''}</span></td>
                            <td style="padding: 10px 12px; border-top: 1px solid var(--border); ${row.highlight ? 'color: var(--critical); font-weight: 600;' : ''}">${row.duration}</td>
                            <td style="padding: 10px 12px; border-top: 1px solid var(--border);">${row.operator}</td>
                        </tr>
                    `).join('')}
                    <tr style="background: rgba(255,255,255,0.03); font-weight: 600;">
                        <td style="padding: 12px; border-top: 2px solid var(--border);">TOTAL</td>
                        <td style="padding: 12px; border-top: 2px solid var(--border);">${formatTime(checkInTime)}  ${releaseTime ? formatTime(releaseTime) : 'NOW'}</td>
                        <td style="padding: 12px; border-top: 2px solid var(--border); color: ${totalColor};">${totalWaitMins}m <span style="font-size: 12px; opacity: 0.8;">(${varianceText})</span></td>
                        <td style="padding: 12px; border-top: 2px solid var(--border);">-</td>
                    </tr>
                </tbody>
            </table>`;

        const activityLogEl = document.getElementById("modalActivityLog");
        if (!logs || logs.length === 0) {
            activityLogEl.innerHTML = `<div style="color: var(--muted); font-size: 14px;">No activity logged</div>`;
        } else {
            activityLogEl.innerHTML = logs.map(log => {
                const logTime = new Date(log.timestamp);
                const logOp = operators.find(o => o.id === log.operator_id);
                let actionLabel = log.action;
                switch(log.action) {
                    case 'check_in': actionLabel = 'Checked in'; break;
                    case 'notified': actionLabel = 'Notified driver'; break;
                    case 'notify': actionLabel = 'Notified driver'; break;
                    case 'released': actionLabel = 'Released'; break;
                    case 'completed': actionLabel = 'Completed'; break;
                    case 'undo': actionLabel = 'Status reverted'; break;
                    case 'edit': actionLabel = 'Record edited'; break;
                    case 'modal_edit': actionLabel = 'Record edited'; break;
                    case 'supervisor_edit': actionLabel = 'Supervisor edit'; break;
                    case 'supervisor_note': actionLabel = 'Supervisor note added'; break;
                    case 'under_review': actionLabel = 'Marked under review'; break;
                    case 'supervisor_aware': actionLabel = 'Supervisor aware'; break;
                    case 'notes_edit': actionLabel = 'Notes updated'; break;
                }
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <div><span style="font-weight: 500;">${actionLabel}</span><span style="color: var(--muted); margin-left: 8px;">by ${logOp?.name || "Unknown"}</span></div>
                        <div style="font-size: 12px; color: var(--muted);">${logTime.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" })} <span style="margin-left: 4px;">${logTime.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit" })}</span></div>
                    </div>`;
            }).join('');
        }

        document.getElementById("modalNotes").textContent = vehicle.notes || "No notes";
        document.getElementById("supervisorNote").value = "";
        document.getElementById("modalOverlay").classList.add("active");

    } catch (error) {
        console.error("Error opening case modal:", error);
        alert("Error loading vehicle details");
    }
}

function closeModal() {
    document.getElementById("modalOverlay").classList.remove("active");
    currentVehicle = null;
}
document.getElementById("modalOverlay").addEventListener("click", (e) => {
    if (e.target.id === "modalOverlay") closeModal();
});

// ==================== SUPERVISOR ACTIONS ====================
async function addSupervisorNote() {
    if (!currentVehicle) return;
    const note = document.getElementById("supervisorNote").value.trim();
    if (!note) { alert("Please enter a note"); return; }
    const opId = localStorage.getItem("operator_id");
    const now = new Date().toISOString();
    try {
        const existingNotes = currentVehicle.notes || "";
        const newNotes = existingNotes + "\n\n[SUPERVISOR " + now.slice(0, 16) + "]\n" + note;
        await db.from("vehicles").update({ notes: newNotes }).eq("id", currentVehicle.id);
        await db.from("actions_log").insert({ vehicle_id: currentVehicle.id, operator_id: opId, action: "supervisor_note", timestamp: now });
        alert("&#10003; Note added successfully");
        document.getElementById("supervisorNote").value = "";
        openCaseModal(currentVehicle.id);
    } catch (error) { console.error("Error adding note:", error); alert("Error adding note"); }
}

async function markUnderReview() {
    if (!currentVehicle) return;
    const opId = localStorage.getItem("operator_id");
    const now = new Date().toISOString();
    try {
        const existingNotes = currentVehicle.notes || "";
        const newNotes = existingNotes + "\n\n[SUPERVISOR] Marked UNDER REVIEW at " + now.slice(0, 16);
        await db.from("vehicles").update({ notes: newNotes }).eq("id", currentVehicle.id);
        await db.from("actions_log").insert({ vehicle_id: currentVehicle.id, operator_id: opId, action: "under_review", timestamp: now });
        alert("&#10003; Marked as Under Review");
        openCaseModal(currentVehicle.id);
    } catch (error) { console.error("Error:", error); alert("Error updating status"); }
}

async function markSupervisorAware() {
    if (!currentVehicle) return;
    const opId = localStorage.getItem("operator_id");
    const now = new Date().toISOString();
    try {
        const existingNotes = currentVehicle.notes || "";
        const newNotes = existingNotes + "\n\n[SUPERVISOR] Supervisor aware of this case at " + now.slice(0, 16);
        await db.from("vehicles").update({ notes: newNotes }).eq("id", currentVehicle.id);
        await db.from("actions_log").insert({ vehicle_id: currentVehicle.id, operator_id: opId, action: "supervisor_aware", timestamp: now });
        alert("&#10003; Marked as Supervisor Aware");
        openCaseModal(currentVehicle.id);
    } catch (error) { console.error("Error:", error); alert("Error updating status"); }
}

function sendDriverSMS() {
    if (!currentVehicle) return;
    alert("&#128241; SMS Feature\n\nThis feature is coming soon.\n\nWill send SMS to: " + (currentVehicle.mobile_number || currentVehicle.pager_number || "No mobile"));
}

async function changeStatus(newStatus) {
    if (!currentVehicle) return;
    const opId = localStorage.getItem("operator_id");
    const now = new Date().toISOString();
    const updateFields = { status: newStatus, operator_id: opId };
    if (newStatus === "notified") { updateFields.notify_time = now; updateFields.release_time = null; }
    else if (newStatus === "released") { updateFields.release_time = now; }
    else { updateFields.notify_time = null; updateFields.release_time = null; }
    try {
        await db.from("vehicles").update(updateFields).eq("id", currentVehicle.id);
        await db.from("actions_log").insert({ vehicle_id: currentVehicle.id, operator_id: opId, action: newStatus, timestamp: now });
        openCaseModal(currentVehicle.id);
    } catch (error) { console.error("Error updating status:", error); alert("Error updating status"); }
}

// ==================== CLOCK ====================
function updateClock() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    document.getElementById("clockTime").textContent = timeStr;
}

// ==================== SEARCH FUNCTIONALITY ====================
document.getElementById("superSearch").addEventListener("input", async (e) => {
    const q = e.target.value.trim().toUpperCase();
    const box = document.getElementById("superSearchResults");
    if (q.length < 2) { box.innerHTML = ""; return; }
    let { data: results } = await db.from("vehicles").select("*").ilike("registration", `%${q}%`);
    if (!results.length) { const { data: byPO } = await db.from("vehicles").select("*").ilike("po_ref", `%${q}%`); results = byPO; }
    if (!results.length) { box.innerHTML = `<div style="color:var(--muted); padding:12px;">No matches</div>`; return; }
    box.innerHTML = results.map(v => `
        <div onclick="openCaseModal('${v.id}')" style="padding:14px; margin-bottom:10px; background:var(--card); border:1px solid var(--border); border-radius:8px; cursor:pointer; transition: all 0.2s;">
            <strong style="font-size:16px;">${v.registration}</strong> <span class="status-badge status-${v.status}" style="margin-left:8px;">${v.status}</span><br>
            <span style="font-size:13px; color:var(--muted);">PO: ${v.po_ref || "-"} | Mobile: ${v.mobile_number || v.pager_number || "-"}</span>
        </div>`).join("");
});

// ==================== INIT ====================
(async () => {
    await loadOperators();
    await loadDashboard();
    updateClock();
    initCommandPalette();
    setInterval(loadDashboard, 30000);
    setInterval(updateClock, 1000);
})();

// ==================== COMMAND PALETTE (Ctrl+K) ====================
let cmdOverlay, cmdInput, cmdResults;
function initCommandPalette() {
    cmdOverlay = document.getElementById('cmdOverlay');
    cmdInput = document.getElementById('cmdInput');
    cmdResults = document.getElementById('cmdResults');
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); toggleCmdPalette(); }
        if (e.key === 'Escape' && cmdOverlay && cmdOverlay.classList.contains('active')) closeCmdPalette();
    });
    cmdOverlay.addEventListener('click', (e) => { if (e.target === cmdOverlay) closeCmdPalette(); });
    cmdInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim().toLowerCase();
        if (!query) { showCmdSuggestions(); return; }
        if (query.startsWith('/')) { await executeCmdCommand(query); } else { await cmdSearchVehicles(query); }
    });
    cmdInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { const query = cmdInput.value.trim().toLowerCase(); if (query.startsWith('/')) executeCmdCommand(query); }
    });
}

function toggleCmdPalette() {
    cmdOverlay.classList.toggle('active');
    if (cmdOverlay.classList.contains('active')) { cmdInput.value = ''; cmdInput.focus(); showCmdSuggestions(); }
}
function closeCmdPalette() { cmdOverlay.classList.remove('active'); }

async function executeCmdCommand(cmd) {
    cmd = cmd.toLowerCase();
    switch(cmd) {
        case '/status': await cmdShowStatus(); break;
        case '/overdue': await cmdShowOverdue(); break;
        case '/critical': await cmdShowCritical(); break;
        case '/longest': await cmdShowLongest(); break;
        case '/waiting': await cmdShowWaiting(); break;
        case '/export': await cmdShowExports(); break;
        case '/notified': await cmdShowNotified(); break;
        case '/today': await cmdShowToday(); break;
        default: cmdResults.innerHTML = `<div class="cmd-hint">Unknown command: <code>${cmd}</code><br>Try /status, /overdue, /critical, /longest, /waiting, /export, /notified, or /today</div>`;
    }
}

async function cmdShowStatus() {
    const now = Date.now();
    const { data: vehicles } = await db.from('vehicles').select('*').in('status', ['parked', 'notified']);
    const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
    const { count: releasedCount } = await db.from('vehicles').select('*', { count: 'exact', head: true }).eq('status', 'released').gte('release_time', todayStart.toISOString());
    const inYard = vehicles?.length || 0;
    const overdue = vehicles?.filter(v => { const due = new Date(v.due_time).getTime(); return now > due + (30 * 60000); }).length || 0;
    const critical = vehicles?.filter(v => { const due = new Date(v.due_time).getTime(); return now > due + (90 * 60000); }).length || 0;
    const avgWait = vehicles?.length > 0 ? Math.round(vehicles.reduce((sum, v) => sum + (now - new Date(v.check_in_time).getTime()), 0) / vehicles.length / 60000) : 0;
    cmdResults.innerHTML = `<div class="cmd-metrics-grid"><div class="cmd-metric-card"><div class="cmd-metric-value">${inYard}</div><div class="cmd-metric-label">In Yard</div></div><div class="cmd-metric-card"><div class="cmd-metric-value ${critical > 0 ? 'cmd-danger' : ''}">${critical}</div><div class="cmd-metric-label">Critical</div></div><div class="cmd-metric-card"><div class="cmd-metric-value ${overdue > 0 ? 'cmd-warning' : ''}">${overdue}</div><div class="cmd-metric-label">Overdue</div></div><div class="cmd-metric-card"><div class="cmd-metric-value cmd-success">${releasedCount}</div><div class="cmd-metric-label">Released Today</div></div><div class="cmd-metric-card"><div class="cmd-metric-value">${avgWait}m</div><div class="cmd-metric-label">Avg Wait</div></div></div>`;
}

async function cmdShowOverdue() {
    const now = Date.now();
    const { data: vehicles } = await db.from('vehicles').select('*').in('status', ['parked', 'notified']);
    const overdue = vehicles?.filter(v => { const due = new Date(v.due_time).getTime(); return now > due + (30 * 60000); }).map(v => { const due = new Date(v.due_time).getTime(); const minsOverdue = Math.floor((now - due) / 60000); return { ...v, minsOverdue }; }).sort((a, b) => b.minsOverdue - a.minsOverdue) || [];
    if (overdue.length === 0) { cmdResults.innerHTML = `<div class="cmd-hint">No overdue vehicles</div>`; return; }
    cmdResults.innerHTML = `<div class="cmd-detail-list">${overdue.map(v => `<div class="cmd-detail-item" onclick="openCaseModal('${v.id}'); closeCmdPalette();" style="cursor:pointer;"><div><strong>${v.registration}</strong><div style="font-size: 12px; color: var(--muted); margin-top: 4px;">PO: ${v.po_ref || '-'} | ${v.status}</div></div><span class="cmd-badge ${v.minsOverdue > 90 ? 'cmd-badge-critical' : 'cmd-badge-warning'}">+${v.minsOverdue}m</span></div>`).join('')}</div>`;
}

async function cmdShowCritical() {
    const now = Date.now();
    const { data: vehicles } = await db.from('vehicles').select('*').in('status', ['parked', 'notified']);
    const critical = vehicles?.filter(v => { const due = new Date(v.due_time).getTime(); return now > due + (90 * 60000); }).map(v => { const due = new Date(v.due_time).getTime(); const minsOverdue = Math.floor((now - due) / 60000); return { ...v, minsOverdue }; }).sort((a, b) => b.minsOverdue - a.minsOverdue) || [];
    if (critical.length === 0) { cmdResults.innerHTML = `<div class="cmd-hint">No critical alerts</div>`; return; }
    cmdResults.innerHTML = `<div class="cmd-detail-list">${critical.map(v => `<div class="cmd-detail-item" onclick="openCaseModal('${v.id}'); closeCmdPalette();" style="cursor:pointer;"><div><strong>${v.registration}</strong><div style="font-size: 12px; color: var(--muted); margin-top: 4px;">PO: ${v.po_ref || '-'} | ${v.status}</div></div><span class="cmd-badge cmd-badge-critical">+${v.minsOverdue}m</span></div>`).join('')}</div>`;
}

async function cmdShowLongest() {
    const now = Date.now();
    const { data: vehicles } = await db.from('vehicles').select('*').in('status', ['parked', 'notified']).order('check_in_time', { ascending: true }).limit(10);
    if (!vehicles || vehicles.length === 0) { cmdResults.innerHTML = `<div class="cmd-hint">No vehicles in yard</div>`; return; }
    cmdResults.innerHTML = `<div class="cmd-detail-list">${vehicles.map(v => { const checkIn = new Date(v.check_in_time).getTime(); const waitMins = Math.floor((now - checkIn) / 60000); const due = new Date(v.due_time).getTime(); const overdue = now > due; return `<div class="cmd-detail-item" onclick="openCaseModal('${v.id}'); closeCmdPalette();" style="cursor:pointer;"><div><strong>${v.registration}</strong><div style="font-size: 12px; color: var(--muted); margin-top: 4px;">PO: ${v.po_ref || '-'} | ${v.status}</div></div><span class="cmd-badge ${overdue ? 'cmd-badge-critical' : 'cmd-badge-normal'}">${waitMins}m</span></div>`; }).join('')}</div>`;
}

async function cmdShowWaiting() {
    const { count } = await db.from('vehicles').select('*', { count: 'exact', head: true }).in('status', ['parked', 'notified']);
    cmdResults.innerHTML = `<div class="cmd-metrics-grid"><div class="cmd-metric-card"><div class="cmd-metric-value">${count || 0}</div><div class="cmd-metric-label">Waiting Vehicles</div></div></div>`;
}

async function cmdShowExports() {
    const { data: exports } = await db.from('vehicles').select('*').eq('classification', 'export').in('status', ['parked', 'notified']);
    if (!exports || exports.length === 0) { cmdResults.innerHTML = `<div class="cmd-hint">No export loads in yard</div>`; return; }
    cmdResults.innerHTML = `<div class="cmd-detail-list">${exports.map(v => `<div class="cmd-detail-item" onclick="openCaseModal('${v.id}'); closeCmdPalette();" style="cursor:pointer;"><div><strong>${v.registration}</strong> <span style="color: var(--export); font-size: 11px; margin-left: 8px;">EXPORT</span><div style="font-size: 12px; color: var(--muted); margin-top: 4px;">PO: ${v.po_ref || '-'} | ${v.status}</div></div></div>`).join('')}</div>`;
}

async function cmdShowNotified() {
    const { data: notified } = await db.from('vehicles').select('*').eq('status', 'notified').order('notify_time', { ascending: true });
    if (!notified || notified.length === 0) { cmdResults.innerHTML = `<div class="cmd-hint">No notified vehicles</div>`; return; }
    const now = Date.now();
    cmdResults.innerHTML = `<div class="cmd-detail-list">${notified.map(v => { const notifyTime = new Date(v.notify_time).getTime(); const minsSinceNotify = Math.floor((now - notifyTime) / 60000); return `<div class="cmd-detail-item" onclick="openCaseModal('${v.id}'); closeCmdPalette();" style="cursor:pointer;"><div><strong>${v.registration}</strong><div style="font-size: 12px; color: var(--muted); margin-top: 4px;">PO: ${v.po_ref || '-'} | Notified ${minsSinceNotify}m ago</div></div><span class="cmd-badge ${minsSinceNotify > 30 ? 'cmd-badge-warning' : 'cmd-badge-normal'}">${minsSinceNotify}m</span></div>`; }).join('')}</div>`;
}

async function cmdShowToday() {
    const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
    const { count: checkedInCount } = await db.from('vehicles').select('*', { count: 'exact', head: true }).gte('check_in_time', todayStart.toISOString());
    const { data: released } = await db.from('vehicles').select('*').eq('status', 'released').gte('release_time', todayStart.toISOString());
    const releasedCount = released?.length || 0;
    let avgTurnaround = 0;
    if (released && released.length > 0) {
        const totalMins = released.reduce((sum, v) => sum + (new Date(v.release_time).getTime() - new Date(v.check_in_time).getTime()) / 60000, 0);
        avgTurnaround = Math.round(totalMins / released.length);
    }
    const { count: inYard } = await db.from('vehicles').select('*', { count: 'exact', head: true }).in('status', ['parked', 'notified']);
    cmdResults.innerHTML = `<div class="cmd-metrics-grid"><div class="cmd-metric-card"><div class="cmd-metric-value">${checkedInCount || 0}</div><div class="cmd-metric-label">Checked In Today</div></div><div class="cmd-metric-card"><div class="cmd-metric-value cmd-success">${releasedCount}</div><div class="cmd-metric-label">Released Today</div></div><div class="cmd-metric-card"><div class="cmd-metric-value">${inYard || 0}</div><div class="cmd-metric-label">Currently In Yard</div></div><div class="cmd-metric-card"><div class="cmd-metric-value">${avgTurnaround}m</div><div class="cmd-metric-label">Avg Turnaround</div></div></div>`;
}

async function cmdSearchVehicles(query) {
    query = query.toUpperCase();
    const { data: vehicles } = await db.from('vehicles').select('*').ilike('registration', `%${query}%`).limit(10);
    if (!vehicles || vehicles.length === 0) { cmdResults.innerHTML = `<div class="cmd-hint">No vehicles found matching "${query}"</div>`; return; }
    cmdResults.innerHTML = `<div class="cmd-detail-list">${vehicles.map(v => `<div class="cmd-detail-item" onclick="openCaseModal('${v.id}'); closeCmdPalette();" style="cursor:pointer;"><div><strong>${v.registration}</strong><div style="font-size: 12px; color: var(--muted); margin-top: 4px;">PO: ${v.po_ref || '-'} | Status: ${v.status}</div></div><span class="cmd-badge ${v.status === 'released' ? 'cmd-badge-normal' : v.status === 'notified' ? 'cmd-badge-warning' : 'cmd-badge-critical'}">${v.status}</span></div>`).join('')}</div>`;
}

function showCmdSuggestions() {
    cmdResults.innerHTML = `<div class="cmd-suggestions"><div class="cmd-suggestions-title">Quick Commands</div><div><span class="cmd-tag" onclick="cmdInput.value='/status'; executeCmdCommand('/status');">/status</span><span class="cmd-tag" onclick="cmdInput.value='/overdue'; executeCmdCommand('/overdue');">/overdue</span><span class="cmd-tag" onclick="cmdInput.value='/critical'; executeCmdCommand('/critical');">/critical</span><span class="cmd-tag" onclick="cmdInput.value='/longest'; executeCmdCommand('/longest');">/longest</span><span class="cmd-tag" onclick="cmdInput.value='/waiting'; executeCmdCommand('/waiting');">/waiting</span><span class="cmd-tag" onclick="cmdInput.value='/export'; executeCmdCommand('/export');">/export</span><span class="cmd-tag" onclick="cmdInput.value='/notified'; executeCmdCommand('/notified');">/notified</span><span class="cmd-tag" onclick="cmdInput.value='/today'; executeCmdCommand('/today');">/today</span></div></div><div class="cmd-hint">Type <code>/</code> to see commands or start typing to search vehicles</div>`;
}
</script>

<div id="cmdOverlay">
    <div id="cmdPalette">
        <input type="text" id="cmdInput" placeholder="Type a command... (e.g. /status, /overdue)" autocomplete="off" spellcheck="false">
        <div id="cmdResults"></div>
    </div>
</div>

</body>
</html>
FILE: arrivals.html (Booking Integration)
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gatehouse - Expected Arrivals</title>

<style>
    :root {
        --bg: #0e1420;
        --card: #1f2937;
        --accent: #0ea5e9;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --success: #22c55e;
        --warn: #fbbf24;
        --danger: #ef4444;
        --purple: #8b5cf6;
        --border: #334155;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
    }

    /* HEADER LAYOUT (Standardized) */
    header {
        background: var(--card);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #1e293b;
    }

    .header-left {
        flex: 1;
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .header-clock {
        flex: 1;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        color: var(--text);
    }

    .header-right {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    .live-dot {
        width: 10px; height: 10px; background: var(--success);
        border-radius: 50%; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Avatar + menu */
    #avatarBtn {
        width: 38px; height: 38px; border-radius: 50%;
        background: var(--bg);
        border: 1px solid #334155;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; color: var(--accent);
        cursor: pointer; user-select: none;
    }
    #avatarMenu {
        position: absolute; top: 48px; right: 0;
        background: var(--card);
        border: 1px solid #334155;
        border-radius: 6px; min-width: 150px;
        padding: 4px 0; display: none; z-index: 10000;
    }
    #avatarMenu > div {
        padding: 8px 12px; cursor: pointer; font-size: 14px; color: var(--text);
    }
    #avatarMenu > div:hover { background: var(--accent); color: #000; }

    /* Navigation bar */
    .main-nav {
        background: #1e3a5f;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid var(--border);
    }
    .main-nav a {
        color: var(--text);
        text-decoration: none;
        padding: 14px 24px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.2s;
    }
    .main-nav a:hover { background: rgba(255,255,255,0.1); }
    .main-nav a.active { background: rgba(255,255,255,0.15); color: #fff; }
    .nav-divider { color: #64748b; font-size: 18px; user-select: none; }

    /* Stats bar */
    .stats-bar {
        display: flex; gap: 16px; padding: 20px 24px;
        background: var(--card); margin: 20px 24px;
        border-radius: 12px; border: 1px solid var(--border);
    }
    .stat-item { flex: 1; text-align: center; padding: 12px; border-right: 1px solid var(--border); }
    .stat-item:last-child { border-right: none; }
    .stat-value { font-size: 36px; font-weight: 700; color: var(--accent); }
    .stat-value.warn { color: var(--warn); }
    .stat-value.danger { color: var(--danger); }
    .stat-value.success { color: var(--success); }
    .stat-label { font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

    /* Main layout */
    .main-grid {
        display: grid; grid-template-columns: 1fr 420px;
        gap: 20px; padding: 0 24px 24px;
    }

    /* Arrivals timeline */
    .arrivals-panel {
        background: var(--card); border-radius: 12px;
        border: 1px solid var(--border); overflow: hidden;
    }
    .panel-header {
        padding: 16px 20px; border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .panel-title { font-size: 18px; font-weight: 600; color: var(--accent); }
    .time-filter { display: flex; gap: 8px; }
    .filter-btn {
        padding: 6px 12px; background: transparent;
        border: 1px solid var(--border); color: var(--muted);
        border-radius: 4px; font-size: 12px; cursor: pointer;
    }
    .filter-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
    .arrivals-list { max-height: 600px; overflow-y: auto; }
    .time-slot { border-bottom: 1px solid var(--border); }
    .time-slot:last-child { border-bottom: none; }
    .slot-header {
        padding: 10px 20px; background: rgba(255,255,255,0.02);
        font-size: 13px; font-weight: 600; color: var(--muted);
        display: flex; justify-content: space-between;
    }
    .slot-header.now { background: rgba(14, 165, 233, 0.1); color: var(--accent); }

    /* Booking card */
    .booking-card {
        padding: 16px 20px; border-bottom: 1px solid var(--border);
        display: flex; align-items: center; gap: 16px;
        cursor: pointer; transition: all 0.2s;
    }
    .booking-card:hover { background: rgba(255,255,255,0.03); }
    .booking-card:last-child { border-bottom: none; }
    .booking-status { width: 8px; height: 60px; border-radius: 4px; flex-shrink: 0; }
    .booking-status.booked { background: var(--accent); }
    .booking-status.arrived { background: var(--purple); }
    .booking-status.complete { background: var(--success); }
    .booking-status.late { background: var(--danger); animation: pulse 1s infinite; }
    .booking-main { flex: 1; }
    .booking-ref { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .booking-ref span { font-weight: 400; color: var(--muted); font-size: 14px; margin-left: 8px; }
    .booking-details { font-size: 13px; color: var(--muted); display: flex; gap: 16px; flex-wrap: wrap; }
    .booking-orders {
        font-size: 12px; color: var(--text); margin-top: 6px;
        font-family: monospace; background: rgba(0,0,0,0.2);
        padding: 4px 8px; border-radius: 4px; display: inline-block;
    }
    .booking-meta { text-align: right; flex-shrink: 0; }
    .booking-pallets { font-size: 24px; font-weight: 700; color: var(--text); }
    .booking-pallets small { font-size: 12px; font-weight: 400; color: var(--muted); }
    .badge {
        display: inline-block; padding: 3px 8px; border-radius: 4px;
        font-size: 10px; font-weight: 700; text-transform: uppercase; margin-left: 8px;
    }
    .badge-meds { background: var(--danger); color: white; }

    /* Check-in panel */
    .checkin-panel {
        background: var(--card); border-radius: 12px;
        border: 1px solid var(--border); padding: 20px;
        height: fit-content;
    }
    .checkin-panel h2 { font-size: 18px; font-weight: 600; color: var(--accent); margin-bottom: 16px; }
    
    .search-box { position: relative; margin-bottom: 20px; }
    .search-box input {
        width: 100%; padding: 14px 16px; background: var(--bg);
        border: 1px solid var(--border); border-radius: 8px;
        color: var(--text); font-size: 16px;
    }
    .search-box input:focus { outline: none; border-color: var(--accent); }
    
    .search-results {
        background: var(--bg); border: 1px solid var(--border);
        border-radius: 8px; margin-bottom: 20px;
        max-height: 300px; overflow-y: auto;
    }
    .search-result-item {
        padding: 14px 16px; border-bottom: 1px solid var(--border);
        cursor: pointer; transition: all 0.2s;
    }
    .search-result-item:hover { background: rgba(14, 165, 233, 0.1); }
    
    /* Selected booking for check-in */
    .selected-booking {
        background: rgba(14, 165, 233, 0.1); border: 2px solid var(--accent);
        border-radius: 8px; padding: 16px; margin-bottom: 20px;
    }
    .selected-booking h3 { font-size: 20px; margin-bottom: 12px; }
    .selected-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
    .selected-info span { color: var(--muted); }

    /* Form Styles matching Index */
    .form-row { margin-bottom: 12px; }
    .checkin-form label {
        display: block; font-size: 13px; color: var(--muted);
        margin-bottom: 6px;
    }
    .checkin-form input, .checkin-form select, .checkin-form textarea {
        width: 100%; padding: 10px; background: var(--bg);
        border: 1px solid var(--border); border-radius: 6px;
        color: var(--text); font-size: 14px;
    }
    .checkin-form textarea { resize: vertical; height: 80px; }
    .checkin-form input:focus, .checkin-form select:focus, .checkin-form textarea:focus {
        outline: none; border-color: var(--accent);
    }
    
    .checkin-btn {
        width: 100%; padding: 14px; background: var(--success);
        color: white; border: none; border-radius: 8px;
        font-size: 16px; font-weight: 700; cursor: pointer;
        margin-top: 12px; transition: all 0.2s;
    }
    .checkin-btn:hover { background: #16a34a; }

    /* Version banner */
    .version-banner {
        position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
        background: var(--purple); color: white; padding: 4px 12px;
        border-radius: 4px; font-size: 11px; font-weight: 600; z-index: 9999;
    }
</style>
</head>
<body>

<div class="version-banner">BOOKING INTEGRATION - LIVE</div>

<header>
    <div class="header-left">
        <div class="live-dot"></div>
        <h1>Gatehouse - Arrivals</h1>
    </div>
    <div class="header-clock" id="clock">--:--</div>
    <div class="header-right">
        <!-- Avatar + dropdown -->
        <div style="position: relative;">
            <div id="avatarBtn">??</div>
            <div id="avatarMenu">
                <div id="menuName">Loading...</div>
                <div onclick="logoutUser()">Logout</div>
            </div>
        </div>
    </div>
</header>

<!-- Navigation -->
<nav class="main-nav">
    <a href="index.html">QUEUE</a>
    <span class="nav-divider">|</span>
    <a href="arrivals.html" class="active">ARRIVALS</a>
    <span class="nav-divider">|</span>
    <a href="supervisor.html">SUPERVISOR</a>
</nav>

<!-- Stats bar -->
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-value" id="statExpected">0</div>
        <div class="stat-label">Expected Today</div>
    </div>
    <div class="stat-item">
        <div class="stat-value success" id="statArrived">0</div>
        <div class="stat-label">Arrived</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statRemaining">0</div>
        <div class="stat-label">Remaining</div>
    </div>
    <div class="stat-item">
        <div class="stat-value warn" id="statLate">0</div>
        <div class="stat-label">Late / No Show</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="statPallets">0</div>
        <div class="stat-label">Total Pallets</div>
    </div>
</div>

<!-- Main grid -->
<div class="main-grid">

    <!-- Arrivals timeline -->
    <div class="arrivals-panel">
        <div class="panel-header">
            <div class="panel-title">Expected Arrivals</div>
            <div class="time-filter">
                <button class="filter-btn active">All</button>
                <button class="filter-btn">Pending</button>
                <button class="filter-btn">Arrived</button>
            </div>
        </div>

        <div class="arrivals-list" id="arrivalsList">
            <div style="text-align: center; padding: 40px; color: var(--muted);">
                Loading bookings...
            </div>
        </div>
    </div>

    <!-- Check-in panel -->
    <div class="checkin-panel">
        <h2>Booking Check-In</h2>

        <!-- Search / Booking Selection -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search booking ref or order number..." oninput="searchBookings(this.value)">
        </div>

        <div class="search-results" id="searchResults" style="display: none;"></div>

        <!-- Selected Booking Summary -->
        <div class="selected-booking" id="selectedBooking" style="display: none;">
            <h3 id="selectedRef">#------</h3>
            <div class="selected-info">
                <div><span>Customer:</span> <span id="selectedCustomer">-</span></div>
                <div><span>Account:</span> <span id="selectedAccount">-</span></div>
                <div><span>Orders:</span> <span id="selectedOrders">-</span></div>
                <div><span>Pallets:</span> <span id="selectedPallets">-</span></div>
            </div>
        </div>

        <!-- Entry Form (Matching Index + Pre-population) -->
        <div class="checkin-form">
            <div class="form-row">
                <label>Registration *</label>
                <input type="text" id="regInput" placeholder="e.g. AB12 CDE" oninput="this.value = this.value.toUpperCase().replace(/\s+/g, '')">
            </div>

            <div class="form-row">
                <label>Haulier / Lorry Company</label>
                <input type="text" id="haulierInput" placeholder="Company Name">
            </div>

            <div class="form-row">
                <label>PO / Reference</label>
                <input type="text" id="poInput" placeholder="Auto-populated from booking">
            </div>

            <div class="form-row">
                <label>Driver Mobile</label>
                <input type="text" id="mobileInput" placeholder="e.g. 07700 900123">
            </div>

            <div class="form-row" style="display:flex; gap:12px;">
                <div style="flex:1;">
                    <label>Quoted Wait</label>
                    <select id="quotedInput">
                        <option value="30">30 mins</option>
                        <option value="45">45 mins</option>
                        <option value="60" selected>60 mins</option>
                        <option value="90">90 mins</option>
                        <option value="120">120 mins</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <label>Notes</label>
                <textarea id="notesInput" placeholder="Additional notes..."></textarea>
            </div>

            <div class="form-row">
                <label style="color:#ccc; display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="addExport" style="margin-right:8px; width:auto;">
                    Export Load
                </label>
            </div>

            <button class="checkin-btn" id="submitBtn" onclick="checkInDriver()">Check In Driver</button>
        </div>
    </div>

</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ============================================================
// SUPABASE CONNECTION
// ============================================================
const db = supabase.createClient(
    "https://gtixdparpjdpyhhubsfz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
);

// ============================================================
// AUTH & AVATAR
// ============================================================
function logoutUser() {
    localStorage.removeItem('operator_id');
    window.location.href = 'login.html';
}

// Avatar Menu Toggle
document.addEventListener('click', (e) => {
    const btn = document.getElementById('avatarBtn');
    const menu = document.getElementById('avatarMenu');
    if (!btn || !menu) return;
    if (btn.contains(e.target)) {
        menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
    } else if (!menu.contains(e.target)) {
        menu.style.display = 'none';
    }
});

// Load Operator Info
(async function checkOperator() {
    const opId = localStorage.getItem('operator_id');
    if (!opId) {
        window.location.href = 'login.html';
        return;
    }

    try {
        const { data: op } = await db.from('operators').select('name').eq('id', opId).single();
        if (!op) { window.location.href = 'login.html'; return; }
        
        const menuName = document.getElementById('menuName');
        const avatarBtn = document.getElementById('avatarBtn');
        if (menuName) menuName.textContent = op.name;
        if (avatarBtn) {
            const initials = op.name.split(' ').map(x => (x[0] || '').toUpperCase()).join('').slice(0, 2);
            avatarBtn.textContent = initials || '??';
        }
    } catch (err) {
        console.error('Operator check failed:', err);
    }
})();

// ============================================================
// CLOCK
// ============================================================
function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent = 
        now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
updateClock();
setInterval(updateClock, 1000);

// ============================================================
// BOOKINGS DATA HANDLING
// ============================================================
let bookingsData = [];
let selectedBookingData = null;

// Load bookings from mock JSON
async function loadBookings() {
    try {
        const response = await fetch('mock_bookings.json');
        const data = await response.json();
        bookingsData = data.bookings || [];
        renderBookings();
        updateStats();
    } catch (err) {
        console.error('Failed to load bookings:', err);
        document.getElementById('arrivalsList').innerHTML = 
            '<div style="text-align:center;padding:40px;color:var(--danger);">Failed to load bookings (mock_bookings.json)</div>';
    }
}

// Group/Render helpers
function groupByHour(bookings) {
    const groups = {};
    bookings.forEach(b => {
        const hour = b.slot_start.slice(0, 2) + ':00';
        if (!groups[hour]) groups[hour] = [];
        groups[hour].push(b);
    });
    return groups;
}

function renderBookings() {
    const container = document.getElementById('arrivalsList');
    if (!bookingsData.length) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">No bookings for today</div>';
        return;
    }

    const groups = groupByHour(bookingsData);
    const sortedHours = Object.keys(groups).sort();
    let html = '';
    
    sortedHours.forEach(hour => {
        const bookings = groups[hour];
        const totalPallets = bookings.reduce((sum, b) => sum + (b.pallets || 0), 0);
        const nowHour = String(new Date().getHours()).padStart(2,'0') + ':00';
        const isCurrent = hour === nowHour;
        
        html += '<div class="time-slot">';
        html += `<div class="slot-header${isCurrent ? ' now' : ''}">`;
        html += `<span>${hour} - ${String(parseInt(hour)+1).padStart(2,'0')}:00${isCurrent ? ' (NOW)' : ''}</span>`;
        html += `<span>${bookings.length} booking(s) - ${totalPallets} plts</span>`;
        html += '</div>';
        
        bookings.forEach(b => {
            const statusClass = (b.status === 'arrived' || b.status === 'complete') ? 'complete' : (b.status === 'late' ? 'late' : 'booked');
            const orders = Array.isArray(b.orders) ? b.orders.join(' | ') : b.orders;
            
            html += `<div class="booking-card" onclick="selectBooking(this)" 
                     data-ref="${b.ref}" data-customer="${b.customer || ''}" 
                     data-account="${b.account || ''}" data-orders="${orders}" 
                     data-pallets="${b.pallets || 0}" data-meds="${b.contains_meds || false}">`;
            
            html += `<div class="booking-status ${statusClass}"></div>`;
            html += `<div class="booking-main">
                        <div class="booking-ref">#${b.ref} <span>${b.customer || ''}</span>
                        ${b.contains_meds ? '<span class="badge badge-meds">MEDS</span>' : ''}</div>
                        <div class="booking-details">
                            <span>${b.account || ''}</span>
                            <span>Slot: ${b.slot_start}-${b.slot_end}</span>
                        </div>
                        <div class="booking-orders">${orders}</div>
                     </div>`;
            html += `<div class="booking-meta"><div class="booking-pallets">${b.pallets || 0} <small>plts</small></div></div>`;
            html += `</div>`;
        });
        html += '</div>';
    });
    container.innerHTML = html;
}

function updateStats() {
    const total = bookingsData.length;
    // In a real system, we'd query Supabase to see if these refs are already checked in
    const arrived = 0; // Keeping simple for mock
    const remaining = total - arrived;
    const pallets = bookingsData.reduce((sum, b) => sum + (b.pallets || 0), 0);
    
    document.getElementById('statExpected').textContent = total;
    document.getElementById('statArrived').textContent = arrived;
    document.getElementById('statRemaining').textContent = remaining;
    document.getElementById('statPallets').textContent = pallets;
}

// ============================================================
// INTERACTION: SELECT & SEARCH
// ============================================================
function selectBooking(card) {
    const data = {
        ref: card.dataset.ref,
        customer: card.dataset.customer,
        account: card.dataset.account,
        orders: card.dataset.orders,
        pallets: card.dataset.pallets,
        meds: card.dataset.meds === 'true'
    };
    populateForm(data);
}

function selectFromSearch(ref, customer, account, orders, pallets) {
    const data = { ref, customer, account, orders, pallets, meds: false };
    populateForm(data);
}

function populateForm(data) {
    selectedBookingData = data;

    // Show visual summary
    document.getElementById('selectedRef').textContent = '#' + data.ref;
    document.getElementById('selectedCustomer').textContent = data.customer;
    document.getElementById('selectedAccount').textContent = data.account;
    document.getElementById('selectedOrders').textContent = data.orders;
    document.getElementById('selectedPallets').textContent = data.pallets;
    document.getElementById('selectedBooking').style.display = 'block';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchInput').value = '';

    // PRE-POPULATE FORM FIELDS
    document.getElementById('poInput').value = data.ref; // Map Ref to PO
    document.getElementById('haulierInput').value = data.customer; // Map Customer to Haulier
    
    // Create rich notes from booking data
    let autoNotes = `Booking: #${data.ref}\nAccount: ${data.account}\nPallets: ${data.pallets}\nOrders: ${data.orders}`;
    if (data.meds) autoNotes += "\n*** CONTAINS MEDS ***";
    
    document.getElementById('notesInput').value = autoNotes;

    // Focus Reg input for quick entry
    document.getElementById('regInput').focus();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function searchBookings(query) {
    const results = document.getElementById('searchResults');
    if (query.length < 2) { results.style.display = 'none'; return; }
    query = query.toUpperCase();

    const matches = bookingsData.filter(b => {
        const ordersStr = Array.isArray(b.orders) ? b.orders.join(' ') : (b.orders || '');
        return b.ref.toUpperCase().includes(query) || 
               ordersStr.toUpperCase().includes(query) ||
               (b.customer || '').toUpperCase().includes(query);
    });

    if (matches.length === 0) {
        results.innerHTML = '<div class="search-result-item"><span style="color: var(--muted);">No matching bookings</span></div>';
    } else {
        results.innerHTML = matches.map(m => {
            const orders = Array.isArray(m.orders) ? m.orders.join(' | ') : m.orders;
            return `<div class="search-result-item" onclick="selectFromSearch('${m.ref}', '${m.customer||''}', '${m.account||''}', '${orders}', ${m.pallets||0})">
                <div class="result-ref">#${m.ref}</div>
                <div class="result-detail">${m.customer||''} - ${orders}</div>
            </div>`;
        }).join('');
    }
    results.style.display = 'block';
}

// ============================================================
// CHECK-IN SUBMISSION (Matches Index Page Logic)
// ============================================================
async function checkInDriver() {
    const btn = document.getElementById('submitBtn');
    btn.style.opacity = '0.6'; btn.style.pointerEvents = 'none';

    try {
        // 1. Get Values
        const reg = document.getElementById('regInput').value.trim().toUpperCase().replace(/\s+/g, '');
        const haulier = document.getElementById('haulierInput').value.trim();
        const po = document.getElementById('poInput').value.trim();
        const mobileRaw = document.getElementById('mobileInput').value.trim();
        const mobile = mobileRaw === '' ? null : mobileRaw;
        const quoted = parseInt(document.getElementById('quotedInput').value, 10);
        const notes = document.getElementById('notesInput').value.trim();
        const isExport = document.getElementById('addExport').checked;

        // 2. Validate
        if (!reg) { alert('Registration is required'); throw new Error('Validation failed'); }

        const operatorId = localStorage.getItem('operator_id');
        const nowIso = new Date().toISOString();
        const dueIso = new Date(Date.now() + quoted * 60000).toISOString();

        // 3. Supabase Insert
        const { data, error } = await db.from('vehicles').insert({
            registration: reg,
            po_ref: po || null,
            haulier: haulier || null,
            mobile_number: mobile,
            notes: notes || null,
            quoted_minutes: quoted,
            check_in_time: nowIso,
            due_time: dueIso,
            status: 'parked',
            operator_id: operatorId,
            classification: isExport ? 'export' : 'normal'
        }).select();

        if (error) throw error;

        const vehicleId = data[0].id;

        // 4. Log Action
        await db.from('actions_log').insert({
            vehicle_id: vehicleId,
            action: 'check_in',
            timestamp: nowIso,
            operator_id: operatorId
        });

        // 5. Open Windows (QR & SMS)
        window.open(`qr-screen.html?uid=${vehicleId}`, "_blank");
        
        if (mobile) {
            window.open(`sms_simulator.html?type=check_in&phone=${encodeURIComponent(mobile)}&po=${encodeURIComponent(po || 'N/A')}&quoted=${quoted}`, 
            "_blank", "width=400,height=700");
        }

        // 6. Reset Form
        document.getElementById('regInput').value = '';
        document.getElementById('mobileInput').value = '';
        document.getElementById('notesInput').value = '';
        document.getElementById('selectedBooking').style.display = 'none';
        
        alert(`Checked in ${reg} successfully!`);

    } catch (err) {
        if(err.message !== 'Validation failed') alert('Error: ' + err.message);
    } finally {
        btn.style.opacity = '1'; btn.style.pointerEvents = 'auto';
    }
}

// Initial Load
loadBookings();

</script>

</body>
</html>
FILE: mock_bookings.json (Data Structure)
code
JSON
{ "bookings": [ { "ref": "819810", "time": "14:00", "pallets": 22, "customer": "DCS Internal", "status": "booked" } ] }
5. Task
We are continuing development. Please acknowledge you have loaded the context, the style rules, and the database schema. Await my next instruction.



UPDATE 01/12/2025

Colour switcher

SYSTEM PROMPT / CONTEXT RESTORATION
You are acting as the Lead Developer for the Gatehouse Dashboard Project. We are building a warehouse vehicle management system using Vanilla HTML/JS/CSS (no build tools) and Supabase v2 (via CDN).

1. Global Design System (DO NOT DEVIATE)
All pages must use CSS Variables for theming to support Light/Dark mode switching.

Theme Tokens & CSS:
```css
/* 1. SHARED TOKENS */
:root {
  --accent: #0ea5e9; --success: #22c55e; --warn: #fbbf24; 
  --danger: #ef4444; --purple: #8b5cf6;
}

/* 2. LIGHT MODE */
[data-theme="light"] {
  --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; 
  --muted: #64748b; --border: #cbd5e1;
}

/* 3. DARK MODE (Default) */
[data-theme="dark"] {
  --bg: #0e1420; --card: #1f2937; --text: #e2e8f0; 
  --muted: #94a3b8; --border: #334155;
}

/* 4. ANIMATION */
body, .tile, .queue, .details, .arrivals-panel, header, input, select, textarea {
  transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
}
Header Structure (Critical for Alignment):
The header must use a 3-column Flex layout.
code
Html
<header>
    <div class="header-left"><h1>Page Title</h1></div>
    <div class="header-clock" id="clock">--:--</div>
    <div class="header-right">
        <!-- Avatar + Dropdown with Theme Switcher -->
    </div>
</header>
Database Schema (Supabase)
Assume this schema exists for all SQL generation:
vehicles: id (uuid), registration, po_ref, haulier, mobile_number, notes, quoted_minutes (int), check_in_time (iso), due_time (iso), status ('parked'|'notified'|'released'), classification ('normal'|'export'), operator_id, pallet_count (int).
actions_log: id, vehicle_id, action, timestamp, operator_id, details (json).
operators: id, name, role, active (bool).
prebookings: used for arrivals.html matching.
Current Functionality Rules
Architecture: arrivals.html acts as a Launcher. Clicking a booking redirects to index.html via URL params to auto-fill the form.
Realtime: Use supabase.channel for live updates on all screens.
Theming: Relies on localStorage.getItem('theme') and setting document.documentElement.setAttribute('data-theme', ...).
Navigation: All pages have a sub-nav: ARRIVALS | QUEUE | SUPERVISOR.
Current File State
Ingest this code to restore the project state (v3.8.0 - Themed & Optimized).
FILE: index.html (Queue)
<!-- START INDEX -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gatehouse Dashboard</title>
<div id="versionBanner"></div>
<script>document.getElementById("versionBanner").innerText = "v3.8.0 - THEMED";</script>
<style>
:root { --accent: #0ea5e9; --success: #22c55e; --warn: #fbbf24; --danger: #ef4444; --purple: #8b5cf6; }
[data-theme="light"] { --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #64748b; --border: #cbd5e1; }
[data-theme="dark"] { --bg: #0e1420; --card: #1f2937; --text: #e2e8f0; --muted: #94a3b8; --border: #334155; }
body, .tile, .queue, .details, header, input, select, textarea { transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
code
Code
body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
header { background: var(--card); padding: 16px 24px; display: flex; align-items: center; border-bottom: 1px solid var(--border); }
.header-left, .header-clock, .header-right { flex: 1; }
.header-clock { text-align: center; font-size: 32px; font-weight: bold; }
.header-right { display: flex; justify-content: flex-end; gap: 12px; position: relative; }

#avatarBtn { width: 38px; height: 38px; border-radius: 50%; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--accent); cursor: pointer; }
#avatarMenu { position: absolute; top: 48px; right: 0; background: var(--card); border: 1px solid var(--border); border-radius: 6px; min-width: 150px; padding: 4px 0; display: none; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
#avatarMenu > div { padding: 8px 12px; cursor: pointer; font-size: 14px; }
#avatarMenu > div:hover { background: var(--accent); color: #000; }

.main-nav { background: #1e3a5f; display: flex; justify-content: center; border-bottom: 1px solid var(--border); }
.main-nav a { color: #e2e8f0; padding: 14px 24px; text-decoration: none; font-weight: 600; }
.main-nav a.active { background: rgba(255,255,255,0.15); color: #fff; }
.nav-divider { color: #64748b; font-size: 18px; padding: 14px 0; }

.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; padding: 24px; }
.tile { background: var(--card); padding: 16px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
.tile .value { font-size: 32px; font-weight: bold; color: var(--accent); }

.grid { display: flex; gap: 24px; padding: 0 24px 24px; }
.queue, .details { flex: 1; background: var(--card); border-radius: 8px; border: 1px solid var(--border); padding: 16px; min-height: 420px; overflow-y: auto; }
.entry { background: rgba(14,165,233,0.05); border-left: 22px solid var(--success); padding: 24px; margin-bottom: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); border-left-width: 22px; }
.entry.overdue { border-left-color: var(--warn); }
.entry.critical { border-left-color: var(--danger); }

/* Panel & Modal Styles Omitted for brevity - Standardized */
.slide-panel { position: fixed; top: 0; left: 0; right: 0; background: var(--card); padding: 20px; transform: translateY(-100%); transition: 0.4s; z-index: 1000; border-bottom: 1px solid var(--border); }
.panel-visible { transform: translateY(0); }
input, select, textarea { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 10px; border-radius: 6px; width: 100%; margin-bottom: 10px; }
</style>
</head>
<body>
<!-- ADD PANEL -->
<div id="addPanel" class="slide-panel">
<h3>Add New Lorry</h3>
<input type="text" id="haulierInput" placeholder="Haulier">
<select id="prebookSelect" onchange="applyPrebook()"><option>-- Select Expected --</option></select>
<input type="text" id="regInput" placeholder="Registration">
<input type="text" id="poInput" placeholder="PO Ref">
<input type="text" id="mobileInput" placeholder="Mobile">
<select id="quotedInput"><option value="60">60 mins</option></select>
<textarea id="notesInput" placeholder="Notes"></textarea>
<label><input type="checkbox" id="addExport"> Export</label>
<button onclick="submitVehicle()" style="width:100%; padding:10px; background:var(--accent); color:#fff; border:none; border-radius:4px; cursor:pointer;">Submit</button>
</div>
code
Code
<!-- HEADER -->
<header>
    <div class="header-left">Gatehouse Dashboard</div>
    <div id="clock" class="header-clock">--:--</div>
    <div class="header-right">
        <button onclick="togglePanel()" style="padding:8px 16px; background:var(--accent); color:#fff; border:none; border-radius:4px; margin-right:10px;">Add Lorry</button>
        <div id="avatarBtn">??</div>
        <div id="avatarMenu">
            <div id="menuName" style="border-bottom:1px solid var(--border); margin-bottom:5px;">Loading</div>
            <div style="font-size:12px; color:var(--muted); padding: 4px 12px;">Appearance</div>
            <div onclick="setTheme('light')" style="display:flex; justify-content:space-between;"><span>&#9728; Light</span><span id="check-light" style="display:none;">&#10003;</span></div>
            <div onclick="setTheme('dark')" style="display:flex; justify-content:space-between;"><span>&#9790; Dark</span><span id="check-dark" style="display:none;">&#10003;</span></div>
            <hr style="border:0; border-top:1px solid var(--border); margin:4px 0;">
            <div onclick="logoutUser()">Logout</div>
        </div>
    </div>
</header>

<nav class="main-nav">
    <a href="arrivals.html">ARRIVALS</a><span class="nav-divider">|</span>
    <a href="index.html" class="active">QUEUE</a><span class="nav-divider">|</span>
    <a href="supervisor.html">SUPERVISOR</a>
</nav>

<!-- KPIS -->
<div class="stats">
    <div class="tile"><div class="value" id="kpiTotalIn">0</div>Checked In</div>
    <div class="tile"><div class="value" id="kpiTotalOut">0</div>Released</div>
    <div class="tile"><div class="value" id="kpiAvgWait">0</div>Avg Wait</div>
    <div class="tile"><div class="value" id="kpiOverdue">0</div>Overdue</div>
</div>

<div class="grid">
    <div class="queue"><h2>Active Queue</h2><div id="queueList"></div></div>
    <div class="details"><h2>Activity</h2><div id="activityList"></div></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient("https://gtixdparpjdpyhhubsfz.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0");
let vehicles=[], operators=[], prebookCache=[];

// THEME LOGIC
function setTheme(t) {
document.documentElement.setAttribute('data-theme', t);
localStorage.setItem('theme', t);
document.getElementById('check-light').style.display = t==='light'?'block':'none';
document.getElementById('check-dark').style.display = t==='dark'?'block':'none';
}
(function(){ setTheme(localStorage.getItem('theme')||'dark'); })();

// LAUNCHER LOGIC
function checkIncomingBooking() {
const p = new URLSearchParams(window.location.search);
if(p.has('ref')) {
document.getElementById('addPanel').classList.add('panel-visible');
document.getElementById('poInput').value = p.get('ref');
document.getElementById('haulierInput').value = p.get('customer')||'';
document.getElementById('notesInput').value = `Booking #${p.get('ref')}\nOrders: ${p.get('orders')||''}`;
window.history.replaceState({}, document.title, "index.html");
}
}

// MAIN FETCH
async function refresh() {
const { data } = await db.from('vehicles').select('*').in('status', ['parked', 'notified']).order('check_in_time');
vehicles = data || [];
renderQueue();
// (Stats fetching logic omitted for brevity, assume similar to previous)
}

// RENDER
function renderQueue() {
const c = document.getElementById('queueList'); c.innerHTML='';
vehicles.forEach(v => {
const el = document.createElement('div');
el.className = 'entry';
el.innerHTML = `<strong>${v.registration}</strong> - ${v.status} <br> ${v.po_ref}`;
c.appendChild(el);
});
}

// INIT
(async function(){
setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
await refresh();
checkIncomingBooking();
// Setup Realtime...
})();
// (Helper functions: logoutUser, togglePanel, etc. assumed present)
</script>
</body>
</html>
FILE: arrivals.html (Schedule & Launcher)
<!-- START ARRIVALS -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arrivals</title>
<style>
/* ... Same CSS Variables as Index ... */
:root { --accent: #0ea5e9; --success: #22c55e; --warn: #fbbf24; --danger: #ef4444; --purple: #8b5cf6; }
[data-theme="light"] { --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #64748b; --border: #cbd5e1; }
[data-theme="dark"] { --bg: #0e1420; --card: #1f2937; --text: #e2e8f0; --muted: #94a3b8; --border: #334155; }
body, .booking-card, header { transition: background-color 0.3s ease; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin:0; }
/* ... Header & Nav CSS ... */
.booking-card { padding: 16px; border-bottom: 1px solid var(--border); display: flex; gap: 16px; cursor: pointer; }
.booking-card:hover { background: rgba(125,125,125,0.05); }
.status-booked { background: var(--accent); width:6px; }
.status-waiting { background: var(--purple); width:6px; }
.status-complete { background: var(--success); width:6px; }
.main-grid { max-width: 1200px; margin: 0 auto; padding: 24px; }
</style>
</head>
<body>
<header>
<div class="header-left">Gatehouse Arrivals</div>
<div id="clock" class="header-clock">--:--</div>
<div class="header-right">
<div id="avatarBtn">??</div>
<div id="avatarMenu">
<!-- Theme Switcher HTML same as Index -->
<div onclick="setTheme('light')">Light</div><div onclick="setTheme('dark')">Dark</div>
</div>
</div>
</header>
<nav class="main-nav">
<a href="arrivals.html" class="active">ARRIVALS</a><span class="nav-divider">|</span>
<a href="index.html">QUEUE</a><span class="nav-divider">|</span>
<a href="supervisor.html">SUPERVISOR</a>
</nav>
code
Code
<div class="main-grid">
    <div id="arrivalsList">Loading...</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient("https://gtixdparpjdpyhhubsfz.supabase.co", "...");
let bookings=[], liveVehicles=[], mergedData=[];

// THEME LOGIC
function setTheme(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
(function(){ setTheme(localStorage.getItem('theme')||'dark'); })();

// 1. Load Data
async function init() {
// Mock Bookings
try { const r = await fetch('mock_bookings.json'); const d = await r.json(); bookings = d.bookings || []; }
catch(e) { bookings = [{ref:"819999", customer:"Waitrose", pallets:29, time:"15:00"}]; }

// Live Vehicles
const today = new Date().toISOString().split('T')[0];
const { data } = await db.from('vehicles').select('po_ref, status, registration, pallet_count').gte('check_in_time', today);
liveVehicles = data || [];

syncData();
}

// 2. Sync Logic
function syncData() {
mergedData = bookings.map(b => {
const match = liveVehicles.find(v => v.po_ref === b.ref);
let item = { ...b, syncStatus: 'booked', liveReg: null };
if(match) {
item.liveReg = match.registration;
if(match.status === 'released') item.syncStatus = 'complete';
else item.syncStatus = 'waiting';
}
return item;
});
render();
}

// 3. Render
function render() {
const c = document.getElementById('arrivalsList'); c.innerHTML = '';
mergedData.forEach(b => {
const div = document.createElement('div');
div.className = 'booking-card';
div.onclick = () => launchIndex(b);
div.innerHTML = `<div class="status-${b.syncStatus}"></div> <div><strong>#${b.ref}</strong> ${b.liveReg || ''} <br> ${b.customer}</div>`;
c.appendChild(div);
});
}

// 4. Launcher
function launchIndex(b) {
if(b.syncStatus !== 'booked') return alert("Already Checked In");
const p = new URLSearchParams({ ref: b.ref, customer: b.customer, pallets: b.pallets });
window.location.href = `index.html?${p.toString()}`;
}

init();
</script>
</body>
</html>
FILE: supervisor.html (Management)
<!-- START SUPERVISOR -->
<!DOCTYPE html>
<html lang="en">
<head>
<title>Supervisor</title>
<style>
/* ... Same CSS Variables ... */
:root { --accent: #0ea5e9; --danger: #ef4444; }
[data-theme="light"] { --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --border: #cbd5e1; }
[data-theme="dark"] { --bg: #0e1420; --card: #1f2937; --text: #e2e8f0; --border: #334155; }
body { background: var(--bg); color: var(--text); font-family: sans-serif; margin:0; }
header { background: var(--card); padding: 16px; display: flex; align-items: center; border-bottom: 1px solid var(--border); }
/* ... Layout CSS ... */
</style>
</head>
<body>
<header>
<div class="header-left">Supervisor</div>
<div id="clock" class="header-clock">--:--</div>
<div class="header-right">
<div id="avatarBtn">??</div>
<div id="avatarMenu">
<div onclick="setTheme('light')">Light</div><div onclick="setTheme('dark')">Dark</div>
</div>
</div>
</header>
<nav class="main-nav">
<a href="arrivals.html">ARRIVALS</a> | <a href="index.html">QUEUE</a> | <a href="supervisor.html" class="active">SUPERVISOR</a>
</nav>
<div class="container">
<!-- Dashboard Logic Omitted for brevity - Matches previous state -->
</div>
<script>
// Theme Logic
function setTheme(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
(function(){ setTheme(localStorage.getItem('theme')||'dark'); })();
// ... Supervisor Logic ...
</script>
</body>
</html>
```
114.6s
Use Arrow Up and Arrow Down to select a turn, Enter to jump to it, and Escape to return to the chat.

