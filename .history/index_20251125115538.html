<!-- START A1 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gatehouse Dashboard</title>
<div id="versionBanner"></div>

<script>
document.getElementById("versionBanner").innerText = "v3.1.2 — DEV BUILD";
</script>


<!--
  Warehouse gatehouse dashboard.
  This page adopts the polished dark theme and KPI layout from the new
  demonstration dashboard while retaining your Supabase back‑end integration.
  Features:
    • Real‑time queue with colour‑coded entries for parked/notified/released.
    • KPI tiles summarising current throughput and dwell times.
    • Live activity feed based on the actions_log table.
    • Chart of check‑ins by hour.
    • Action buttons to notify, release or undo a vehicle. Actions write back
      to Supabase and log to actions_log with the current operator ID.
  To add new lorries, use your existing prebooking page; this dashboard
  concentrates on monitoring and control.
-->
<style>
    :root {
        --bg: #0e1420;
        --card: #1f2937;
        --accent: #0ea5e9;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --success: #22c55e;
        --warn: #fbbf24;
        --danger: #ef4444;
    }

    /* Export load styling */
    .queue-export {
        background: linear-gradient(
            90deg,
            rgba(14,165,233,0.25),
            rgba(14,165,233,0.08)
        ) !important;
        box-shadow: 0 0 16px rgba(14,165,233,0.5);
        animation: exportPulse 2.4s infinite ease-in-out;
    }

    @keyframes exportPulse {
        0%, 100% { box-shadow: 0 0 16px rgba(14,165,233,0.5); }
        50% { box-shadow: 0 0 24px rgba(14,165,233,0.8); }
    }
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans‑serif;
        background: var(--bg);
        color: var(--text);
    }
    header {
        /* restructure header to accommodate title, clock and avatar */
        background: var(--card);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #1e293b;
    }

    /* header sections for left title, centre clock and right actions */
    .header-left {
        flex: 1;
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
    }
    .header-clock {
        flex: 1;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        color: var(--text);
    }
    .header-right {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    /* avatar button and dropdown menu */
    #avatarBtn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: var(--bg);
        border: 1px solid #334155;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--accent);
        cursor: pointer;
        user-select: none;
    }
    #avatarMenu {
        position: absolute;
        top: 48px;
        right: 0;
        background: var(--card);
        border: 1px solid #334155;
        border-radius: 6px;
        min-width: 150px;
        padding: 4px 0;
        display: none;
        z-index: 10000;
    }
    #avatarMenu > div {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
    }
    #avatarMenu > div:hover {
        background: var(--accent);
        color: #000;
    }

    /* make queue cards clickable */
    .entry {
        cursor: pointer;
    }

    /* modal overlay for editing vehicles */
    #editModalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        z-index: 10000;
    }
    #editModal {
        background: var(--card);
        color: var(--text);
        width: 420px;
        margin: 80px auto;
        padding: 24px;
        border-radius: 8px;
        border: 1px solid #334155;
    }
    #editModal label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-size: 14px;
    }
    #editModal input,
    #editModal textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #334155;
        border-radius: 6px;
        background: var(--bg);
        color: var(--text);
        font-size: 14px;
    }
    #editModal textarea {
        resize: vertical;
        height: 80px;
    }
    #editModal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 16px;
    }
    #editModal .modal-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
    }
    #editModal .modal-actions .cancel-btn {
        background: #475569;
        color: #fff;
    }
    #editModal .modal-actions .save-btn {
        background: var(--accent);
        color: #000;
    }
    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        padding: 24px;
    }
    .tile {
        background: var(--card);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #334155;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    .tile .value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 4px;
        color: var(--accent);
    }
    .grid {
        display: flex;
        flex-direction: row;
        gap: 24px;
        padding: 0 24px 24px;
    }
    .queue, .details {
        flex: 1;
        background: var(--card);
        border-radius: 8px;
        border: 1px solid #334155;
        padding: 16px;
        min-height: 420px;
        overflow-y: auto;
    }
    .queue h2, .details h2 {
        margin-top: 0;
        color: var(--accent);
        font-size: 20px;
    }
    .entry {
        background: #1f2937;
        border-left: 22px solid var(--success);
        padding: 24px;
        margin-bottom: 12px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .entry.overdue {
        border-left-color: var(--warn);
    }
    .entry.critical {
        border-left-color: var(--danger);
    }
    .entry .info {
        flex: 1;
    }
    .entry .actions button {
        margin-left: 6px;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .entry .actions .notify { background: var(--warn); color: #000; }
    .entry .actions .release { background: var(--success); color: #000; }
    .entry .actions .undo { background: var(--danger); color: #fff; }
    .activity-item {
        margin-bottom: 8px;
        border-bottom: 1px solid #334155;
        padding-bottom: 4px;
        font-size: 14px;
    }
    /* Add Lorry Button & Panel Styles */
    .add-btn {
        background: var(--accent);
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        margin-right: 8px;
    }
    .slide-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        min-height: 320px;
        background: var(--card);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        padding: 20px 24px;
        transform: translateY(calc(-100% - 40px));
        transition: transform 0.4s ease;
        z-index: 1000;
        color: var(--text);
    }
    .panel-visible {
        transform: translateY(0);
    }
    .panel-title {
        font-size: 20px;
        color: var(--accent);
        font-weight: bold;
        margin-bottom: 10px;
    }
    .form-row {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }
    .slide-panel input,
    .slide-panel textarea,
    .slide-panel select {
        padding: 10px;
        flex: 1;
        border: 1px solid #334155;
        border-radius: 6px;
        font-size: 14px;
        background: var(--bg);
        color: var(--text);
    }
    .submit-btn {
        padding: 10px 16px;
        background: var(--accent);
        color: #fff;
        border-radius: 6px;
        margin-top: 12px;
        cursor: pointer;
        text-align: center;
        font-weight: bold;
    }
</style>
<!-- END A1 -->
 
</head>
<body>
    <!-- START A2 -->
    <!-- Hidden Add Lorry Panel -->
    <div id="addPanel" class="slide-panel">
        <div class="panel-title">Add New Lorry</div>

        <!-- Haulier/Lorry field -->
        <div class="form-row">
            <input type="text" id="haulierInput" placeholder="Haulier / Lorry Company" style="width:100%;">
        </div>

        <!-- Expected Loads Dropdown -->
        <div class="form-row">
            <select id="prebookSelect" onchange="applyPrebook()" style="width:100%;">
                <option value="">-- Select Expected Load --</option>
            </select>
        </div>

        <div class="form-row">
            <input type="text" id="regInput" placeholder="Registration">
            <input type="text" id="poInput" placeholder="PO / Reference">
        </div>
        <div class="form-row">
            <input type="text" id="pagerInput" placeholder="Mobile Number">
            <select id="quotedInput">
                <option value="30">30 mins</option>
                <option value="45">45 mins</option>
                <option value="60" selected>60 mins</option>
                <option value="90">90 mins</option>
                <option value="120">120 mins</option>
            </select>
        </div>
        <div class="form-row">
            <textarea id="notesInput" placeholder="Notes" style="width:100%;height:80px;"></textarea>
        </div>
        <div class="form-row">
            <label style="color:#ccc;">
                <input type="checkbox" id="addExport" style="margin-right:6px;">
                Export Load
            </label>
        </div>
        <div class="submit-btn" onclick="submitVehicle()">Submit</div>
    </div>
    <header>
        <div class="header-left">Gatehouse Dashboard</div>
        <div id="clock" class="header-clock">--:--</div>
        <div class="header-right">
            <!-- Add lorry button -->
            <button class="add-btn" onclick="togglePanel()">Add Lorry</button>
            <button id="refreshBtn" style="padding:8px 16px;font-size:14px;background:var(--accent);color:#fff;border:none;border-radius:4px;" onclick="manualRefresh()">Refresh</button>
            <!-- Avatar and dropdown -->
            <div style="position: relative;">
                <div id="avatarBtn">??</div>
                <div id="avatarMenu">
                    <div id="menuName">Loading...</div>
                    <div onclick="logoutUser()">Logout</div>
                </div>
            </div>
        </div>
    </header>
    <!-- END A2 -->
    <!-- KPI Tiles -->
    <!-- START A3 -->
    <div class="stats">
        <div class="tile">
            <div class="value" id="kpiTotalIn">0</div>
            Checked In
        </div>
        <div class="tile">
            <div class="value" id="kpiTotalOut">0</div>
            Released
        </div>
        <div class="tile">
            <div class="value" id="kpiAvgWait">0</div>
            Avg Wait (m)
        </div>
        <div class="tile">
            <div class="value" id="kpiOverdue">0</div>
            Overdue >30m
        </div>
    </div>
    <!-- END A3 -->
    <!-- START A4 -->
    <div class="grid">
        <!-- Queue Section -->
        <div class="queue">
            <h2>Active Queue</h2>
            <div id="queueList">Loading…</div>
        </div>
        <!-- Details / Timeline Section -->
        <div class="details">
            <h2>Recent Activity</h2>
            <div id="activityList">Loading…</div>
        </div>
    </div>
    <!-- END A4 -->
    <!-- START A5 -->
    <canvas id="chartTrend" style="max-width:600px;height:240px;max-height:240px;margin:0 auto 24px;display:block;"></canvas>
    <!-- END A5 -->

    <!-- Supabase & Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // START A6
    // Initialise Supabase client
    const db = supabase.createClient(
        "https://gtixdparpjdpyhhubsfz.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
    );
    // END A6

    let vehicles = [];
    let operators = [];
    let logs = [];
    let chart;
    let prebookCache = [];
    let prebookExportFlag = false;
    // START A7
    // Fetch operators from Supabase (names for activity feed)
    async function fetchOperators() {
        const { data, error } = await db
            .from('operators')
            .select('id, name');
        if (error) { console.error(error); return; }
        operators = data || [];
    }
    // END A7

    // START A8 — Load ALL vehicles so Recents works
async function fetchVehicles() {
    const { data, error } = await db
        .from('vehicles')
        .select('*')
        .order('check_in_time', { ascending: true });

    if (error) { console.error(error); return; }

    vehicles = data || [];

    renderQueue();
    loadKPIs();
    loadChart();
}
// END A8

// START A9
/* Fetch recent actions (last 24 hours, newest first) */
async function fetchLogs() {
    try {
        // Load 40 latest raw actions from DB
        const { data, error } = await db
            .from('actions_log')
            .select('*')
            .order('timestamp', { ascending: false })
            .limit(16);

        if (error) {
            console.error("Error loading logs:", error);
            return;
        }

        const all = data || [];

        // Cutoff = last 24 hours
        const cutoff = Date.now() - (24 * 60 * 60 * 1000);

        logs = all
            .filter(l => new Date(l.timestamp).getTime() >= cutoff)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        renderActivity();
    } catch (err) {
        console.error("fetchLogs fatal:", err);
    }
}
// END A9



    // START A10
    // KPI calculations
    function loadKPIs() {
        const totalIn = vehicles.filter(v => v.status !== 'released').length;
        const totalOut = vehicles.filter(v => v.status === 'released').length;
        const waits = vehicles.filter(v => v.status === 'parked' || v.status === 'notified').map(v => {
            return Math.floor((Date.now() - new Date(v.check_in_time)) / 60000);
        });
        const avgWait = waits.length ? (waits.reduce((a,b)=>a+b,0)/waits.length).toFixed(0) : 0;
        const overdue = vehicles.filter(v => {
            const due = new Date(v.due_time || v.check_in_time).getTime() + 30*60000;
            return Date.now() > due && v.status !== 'released';
        }).length;
        document.getElementById('kpiTotalIn').textContent = totalIn;
        document.getElementById('kpiTotalOut').textContent = totalOut;
        document.getElementById('kpiAvgWait').textContent = avgWait;
        document.getElementById('kpiOverdue').textContent = overdue;
    }
    // END A10

    // Render queue list
    function renderQueue() {
        const container = document.getElementById('queueList');
        container.innerHTML = '';
        vehicles.filter(v => v.status !== "released").forEach(v => {
            const li = document.createElement('div');
            // Determine overdue/critical status based on due time
            const now = Date.now();
            const dueTime = new Date(v.due_time).getTime();
            const minsLate = Math.floor((now - dueTime)/60000);
            let cls = '';
            if (minsLate > 0 && v.status !== 'released') cls = minsLate > 90 ? 'critical' : 'overdue';
            // Check if this is an export load
            const isExport = v.classification === 'export';
            li.className = `entry ${cls} ${isExport ? 'queue-export' : ''}`;
            // When clicking anywhere on the card (except buttons) open edit modal
            li.onclick = () => openEditModal(v.id);
            li.innerHTML = `
                <div class="info">
                    <strong>${v.registration || '–'}</strong> — ${v.status}<br>
                    PO: ${v.po_ref || '-'} | Mobile: ${v.mobile_number || v.pager_number || '-'}<br>
                    In: ${new Date(v.check_in_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})} | Due: ${v.due_time ? new Date(v.due_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : '-' }
                </div>
                <div class="actions">
                    <button class="notify" onclick="event.stopPropagation(); notify('${v.id}')">Notify</button>
                    <button class="release" onclick="event.stopPropagation(); release('${v.id}')">Release</button>
                    <button class="undo" onclick="event.stopPropagation(); undo('${v.id}')">Undo</button>
                </div>
            `;
            container.appendChild(li);
        });
    }

    // Render recent activity
    function renderActivity() {
        const container = document.getElementById('activityList');
        container.innerHTML = '';
        logs.forEach(l => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            // find registration and PO from vehicles array
            const veh = vehicles.find(v => v.id === l.vehicle_id) || {};
            const reg = veh.registration || '';
            const po = veh.po_ref || '';
            // find operator name
            const op = operators.find(o => o.id === l.operator_id) || {};
            const name = op.name || 'Unknown';
            // humanise action
            let actionVerb = '';
            switch(l.action) {
                case 'check_in': actionVerb = 'checked in'; break;
                case 'notified': actionVerb = 'notified'; break;
                case 'released': actionVerb = 'completed'; break;
                case 'undo': actionVerb = 'reverted'; break;
                default: actionVerb = l.action; break;
            }
            const dt = new Date(l.timestamp);
            const timeStr = dt.toLocaleString('en-GB', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
            item.textContent = `${reg || l.vehicle_id} ${po} ${actionVerb} by ${name} — ${timeStr}`.trim();
            container.appendChild(item);
        });
    }

  //  <!-- START A11 -->
<script>
function loadChart() {
    const ctx = document.getElementById('chartTrend').getContext('2d');

    // Reset buckets
    let bucketOnTime = 0;       // 0–30m (green)
    let bucket30 = 0;           // 30–60m (amber)
    let bucket60 = 0;           // 60–120m (red)
    let bucket120 = 0;          // 120+ (deep red)

    const now = Date.now();

    // Only active vehicles count (parked/notified)
    const active = vehicles.filter(v => v.status !== "released");

    active.forEach(v => {
        const due = new Date(v.due_time || v.check_in_time).getTime();
        const late = Math.floor((now - due) / 60000); // lateness in minutes

        if (late <= 0) {
            bucketOnTime++;
        } else if (late > 0 && late <= 30) {
            bucketOnTime++; // still 'on time' under 30m late
        } else if (late > 30 && late <= 60) {
            bucket30++;
        } else if (late > 60 && late <= 120) {
            bucket60++;
        } else if (late > 120) {
            bucket120++;
        }
    });

    // Destroy previous chart if exists
    if (chart) chart.destroy();

    const css = getComputedStyle(document.documentElement);
    const green   = css.getPropertyValue('--success').trim();
    const amber   = css.getPropertyValue('--warn').trim();
    const red     = css.getPropertyValue('--danger').trim();
    const deepRed = '#7f1d1d';  // manually define deep red

    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [
                "0–30m",
                "30–60m",
                "60–120m",
                "120+m"
            ],
            datasets: [{
                label: "Overdue Buckets",
                data: [bucketOnTime, bucket30, bucket60, bucket120],
                backgroundColor: [
                    green,
                    amber,
                    red,
                    deepRed
                ],
                borderColor: "#000",
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}
</script>
//<!-- END A11 -->


    // START A12
    // Action handlers
    async function notify(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        const { error } = await db.from('vehicles').update({ status: 'notified', notify_time: now }).eq('id', id);
        if (!error) {
            await db.from('actions_log').insert({ vehicle_id: id, action: 'notified', timestamp: now, operator_id: operator });
            await fetchVehicles();
            await fetchLogs();
        }
    }
    async function release(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        const { error } = await db.from('vehicles').update({ status: 'released', release_time: now }).eq('id', id);
        if (!error) {
            await db.from('actions_log').insert({ vehicle_id: id, action: 'released', timestamp: now, operator_id: operator });
            await fetchVehicles();
            await fetchLogs();
        }
    }
    async function undo(id) {
        const operator = localStorage.getItem('operator_id') || null;
        const now = new Date().toISOString();
        const { data: v } = await db.from('vehicles').select('status').eq('id', id).single();
        // revert statuses: notified -> parked, released -> notified? For simplicity, set to parked
        const newStatus = 'parked';
        const { error } = await db.from('vehicles').update({ status: newStatus }).eq('id', id);
        if (!error) {
            await db.from('actions_log').insert({ vehicle_id: id, action: 'undo', timestamp: now, operator_id: operator });
            await fetchVehicles();
            await fetchLogs();
        }
    }

    // Toggle the visibility of the add panel
    function togglePanel() {
        const panel = document.getElementById('addPanel');
        if (panel) {
            panel.classList.toggle('panel-visible');
            // Load prebookings when panel opens
            if (panel.classList.contains('panel-visible')) {
                loadPrebooks();
            }
        }
    }

    // Load expected loads from prebookings table
    async function loadPrebooks() {
        const sel = document.getElementById('prebookSelect');
        sel.innerHTML = `<option value="">-- Select Expected Load --</option>`;

        const { data } = await db
            .from('prebookings')
            .select('*')
            .eq('consumed', false)
            .order('expected_date', { ascending: true })
            .order('expected_time', { ascending: true });

        if (!data) return;
        prebookCache = data;

        data.forEach(p => {
            const label = `${p.po_ref || 'No PO'} — ${p.registration || 'No Reg'} — ${p.expected_date || ''} ${p.expected_time?.slice(0,5) || ''}${p.is_export ? ' — EXPORT' : ''}`;
            sel.innerHTML += `<option value="${p.id}">${label}</option>`;
        });
    }

    // Apply selected prebooking to form fields
    function applyPrebook() {
        const id = document.getElementById('prebookSelect').value;
        if (!id) return;

        const pb = prebookCache.find(x => x.id === id);
        if (!pb) return;

        document.getElementById('poInput').value = pb.po_ref || '';
        document.getElementById('regInput').value = pb.registration || '';
        document.getElementById('notesInput').value = pb.notes || '';
        document.getElementById('haulierInput').value = pb.haulier || '';

        prebookExportFlag = pb.is_export === true;
        document.getElementById('addExport').checked = prebookExportFlag;
    }

    // Submit a new lorry to the database
    async function submitVehicle() {
        const btn = document.querySelector('#addPanel .submit-btn');
        if (!btn) return;
        // disable button to avoid double submissions
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.6';

        // Gather form values
        let reg = document.getElementById('regInput').value.trim().replace(/\s+/g, '').toUpperCase();
        let po = document.getElementById('poInput').value.trim();
        let haulier = document.getElementById('haulierInput').value.trim();
        // If pager input is blank, store null so Supabase won't attempt to parse an empty string as an integer
        let pagerInput = document.getElementById('pagerInput').value.trim();
        let pager = pagerInput === '' ? null : pagerInput;
        let notes = document.getElementById('notesInput').value.trim();
        let quoted = parseInt(document.getElementById('quotedInput').value, 10);

        if (!reg) {
            alert('Registration required');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            return;
        }

        const operatorId = localStorage.getItem('operator_id') || null;
        const nowIso = new Date().toISOString();
        const dueIso = new Date(Date.now() + quoted * 60000).toISOString();

        // Get export checkbox value
        const isExport = document.getElementById('addExport').checked;

        try {
            // Insert into vehicles table
            const { data, error } = await db.from('vehicles').insert({
                registration: reg,
                po_ref: po || null,
                haulier: haulier || null,
                // pager_number is nullable; pass null if empty to avoid invalid integer parsing
                pager_number: pager,
                notes: notes || null,
                quoted_minutes: quoted,
                check_in_time: nowIso,
                due_time: dueIso,
                status: 'parked',
                operator_id: operatorId,
                classification: isExport ? 'export' : 'normal'
            }).select();
            if (error) {
                alert('Error: ' + error.message);
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                return;
            }
            const vehicleId = data && data[0] && data[0].id;
            // Open QR screen in new window
            window.open(`qr-screen.html?uid=${vehicleId}`, "_blank");
            // Log check in action
            await db.from('actions_log').insert({
                vehicle_id: vehicleId,
                action: 'check_in',
                timestamp: nowIso,
                operator_id: operatorId
            });

            // Mark prebooking as consumed if one was selected
            const selectedPrebookId = document.getElementById('prebookSelect').value;
            if (selectedPrebookId) {
                await db.from('prebookings').update({ consumed: true }).eq('id', selectedPrebookId);
            }

            // Refresh lists
            await fetchVehicles();
            await fetchLogs();
            await fetchOperators();
            // Close panel and reset form
            togglePanel();
            document.getElementById('regInput').value = '';
            document.getElementById('poInput').value = '';
            document.getElementById('haulierInput').value = '';
            document.getElementById('pagerInput').value = '';
            document.getElementById('notesInput').value = '';
            document.getElementById('quotedInput').value = '60';
            document.getElementById('addExport').checked = false;
            document.getElementById('prebookSelect').value = '';
            prebookExportFlag = false;
        } finally {
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        }
    }
    // END A12

    // START A13
    function manualRefresh() {
        fetchVehicles();
        fetchOperators();
        fetchLogs();
    }

    // Initial load and periodic refresh
    fetchVehicles();
    fetchOperators();
    fetchLogs();
    setInterval(() => {
        fetchVehicles();
        fetchOperators();
        fetchLogs();
    }, 15000);
    // END A13

    // BEGIN - added clock update and avatar/menu logic and edit modal

    // Live clock update
    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const clk = document.getElementById('clock');
        if (clk) clk.textContent = timeStr;
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Logout handler
    function logoutUser() {
        localStorage.removeItem('operator_id');
        window.location.href = 'login.html';
    }

    // Avatar dropdown toggle
    document.addEventListener('click', (e) => {
        const btn = document.getElementById('avatarBtn');
        const menu = document.getElementById('avatarMenu');
        if (!btn || !menu) return;
        if (btn.contains(e.target)) {
            menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
        } else if (!menu.contains(e.target)) {
            menu.style.display = 'none';
        }
    });

    // Populate avatar with operator initials/name
    (async () => {
        const opId = localStorage.getItem('operator_id');
        if (!opId) return;
        try {
            const { data: op } = await db.from('operators').select('name').eq('id', opId).single();
            const opName = op?.name || 'Unknown';
            const menuName = document.getElementById('menuName');
            const avatarBtn = document.getElementById('avatarBtn');
            if (menuName) menuName.textContent = opName;
            if (avatarBtn) {
                const initials = opName.split(' ').map(x => (x[0] || '').toUpperCase()).join('').slice(0, 2);
                avatarBtn.textContent = initials || '??';
            }
        } catch (err) {
            console.error('Failed to load operator:', err);
        }
    })();

    // Show edit modal with fields prefilled
    let currentEditId = null;
    function openEditModal(id) {
        const veh = vehicles.find(v => v.id === id);
        if (!veh) return;
        currentEditId = id;
        const reg = document.getElementById('editReg');
        const po = document.getElementById('editPO');
        const pager = document.getElementById('editPager');
        const notes = document.getElementById('editNotes');
        if (reg) reg.value = veh.registration || '';
        if (po) po.value = veh.po_ref || '';
        if (pager) pager.value = veh.pager_number || '';
        if (notes) notes.value = veh.notes || '';
        const overlay = document.getElementById('editModalOverlay');
        if (overlay) overlay.style.display = 'block';
    }

    // Hide edit modal
    function closeEditModal() {
        const overlay = document.getElementById('editModalOverlay');
        if (overlay) overlay.style.display = 'none';
        currentEditId = null;
    }

    // Save edits back to Supabase
    async function saveEditModal() {
        if (!currentEditId) { closeEditModal(); return; }
        const regVal = document.getElementById('editReg').value.trim().toUpperCase();
        const poVal = document.getElementById('editPO').value.trim();
        const pagerVal = document.getElementById('editPager').value.trim();
        const notesVal = document.getElementById('editNotes').value.trim();
        const operatorId = localStorage.getItem('operator_id') || null;
        const updates = {
            registration: regVal,
            po_ref: poVal || null,
            pager_number: pagerVal === '' ? null : pagerVal,
            notes: notesVal || null,
            operator_id: operatorId
        };
        try {
            const { error } = await db.from('vehicles').update(updates).eq('id', currentEditId);
            if (error) {
                alert('Error updating record: ' + error.message);
                return;
            }
            // Log edit action
            const nowIso = new Date().toISOString();
            await db.from('actions_log').insert({
                vehicle_id: currentEditId,
                action: 'edit',
                timestamp: nowIso,
                operator_id: operatorId
            });
            await fetchVehicles();
            await fetchLogs();
            closeEditModal();
        } catch (err) {
            console.error('Edit save failed:', err);
            alert('Failed to save changes');
        }
    }

    // END - added clock update and avatar/menu logic and edit modal
    </script>

    <!-- Modal overlay for editing vehicles -->
    <div id="editModalOverlay">
        <div id="editModal">
            <h3 style="margin-top:0; margin-bottom:8px; font-size:20px; color: var(--accent);">Edit Vehicle</h3>
            <label for="editReg">Registration</label>
            <input type="text" id="editReg">
            <label for="editPO">PO / Reference</label>
            <input type="text" id="editPO">
            <label for="editPager">Mobile Number</label>
            <input type="text" id="editPager">
            <label for="editNotes">Notes</label>
            <textarea id="editNotes"></textarea>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveEditModal()">Save</button>
            </div>
        </div>
    </div>
</body>
</html>