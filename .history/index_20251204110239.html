<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gatehouse Dashboard</title>
<div id="versionBanner"></div>

<script>
document.getElementById("versionBanner").innerText = "v5.0.3 - MULTI-USER FIX";
</script>

<style>
    /* 1. SHARED TOKENS (Colors that work on both modes) */
    :root {
        --accent: #0ea5e9;
        --success: #22c55e;
        --warn: #fbbf24;
        --danger: #ef4444;
        --purple: #8b5cf6;
    }

    /* 2. LIGHT MODE CONFIG */
    [data-theme="light"] {
        --bg: #f1f5f9;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #cbd5e1;
    }

    /* 3. DARK MODE CONFIG */
    [data-theme="dark"] {
        --bg: #0e1420;
        --card: #1f2937;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --border: #334155;
    }

    /* 4. ANIMATIONS */
    body, .tile, .queue, .details, header, input, select, textarea, .slide-panel, #editModal {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    /* Export load styling */
    .queue-export {
        background: linear-gradient(
            90deg,
            rgba(14,165,233,0.25),
            rgba(14,165,233,0.08)
        ) !important;
        box-shadow: 0 0 16px rgba(14,165,233,0.5);
        animation: exportPulse 2.4s infinite ease-in-out;
    }

    @keyframes exportPulse {
        0%, 100% { box-shadow: 0 0 16px rgba(14,165,233,0.5); }
        50% { box-shadow: 0 0 24px rgba(14,165,233,0.8); }
    }
    
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
    }
    
    header {
        background: var(--card);
        padding: 16px 24px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--border);
    }

    .header-left {
        flex: 1;
        font-size: 24px;
        font-weight: bold;
        color: var(--accent);
    }
    
    .header-clock {
        flex: 1;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        color: var(--text);
    }
    
    .header-right {
        flex: 1;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    #avatarBtn {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: var(--bg);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--accent);
        cursor: pointer;
        user-select: none;
    }
    
    #avatarMenu {
        position: absolute;
        top: 48px;
        right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        min-width: 150px;
        padding: 4px 0;
        display: none;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    #avatarMenu > div {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
    }
    
    #avatarMenu > div:hover {
        background: var(--accent);
        color: #000;
    }

    .entry {
        cursor: pointer;
    }

    /* Modal Styling */
    #editModalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        z-index: 10000;
    }
    
    #editModal {
        background: var(--card);
        color: var(--text);
        width: 420px;
        margin: 80px auto;
        padding: 24px;
        border-radius: 8px;
        border: 1px solid var(--border);
    }
    
    #editModal label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-size: 14px;
    }
    
    #editModal input,
    #editModal textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg);
        color: var(--text);
        font-size: 14px;
    }
    
    #editModal textarea {
        resize: vertical;
        height: 80px;
    }
    
    #editModal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 16px;
    }
    
    #editModal .modal-actions button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
    }
    
    #editModal .modal-actions .cancel-btn {
        background: #475569;
        color: #fff;
    }
    
    #editModal .modal-actions .save-btn {
        background: var(--accent);
        color: #000;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        padding: 24px;
    }
    
    .tile {
        background: var(--card);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    
    .tile .value {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 4px;
        color: var(--accent);
    }
    
    .grid {
        display: flex;
        flex-direction: row;
        gap: 24px;
        padding: 0 24px 24px;
    }
    
    .queue, .details {
        flex: 1;
        background: var(--card);
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 16px;
        min-height: 420px;
        overflow-y: auto;
    }
    
    .queue h2, .details h2 {
        margin-top: 0;
        color: var(--accent);
        font-size: 20px;
    }
    
    .entry {
        background: rgba(14,165,233,0.05);
        border: 1px solid var(--border);
        border-left: 22px solid var(--success);
        padding: 24px;
        margin-bottom: 12px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .entry.overdue {
        border-left-color: var(--warn);
    }
    
    .entry.critical {
        border-left-color: var(--danger);
    }
    
    .entry .info {
        flex: 1;
    }
    
    .entry .actions button {
        margin-left: 6px;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .entry .actions .notify { background: var(--warn); color: #000; }
    .entry .actions .release { background: var(--success); color: #000; }
    .entry .actions .undo { background: var(--danger); color: #fff; }
    
    .activity-item {
        margin-bottom: 8px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 4px;
        font-size: 14px;
    }
    
    .add-btn {
        background: var(--accent);
        color: #fff;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        margin-right: 8px;
    }

    /* QR Search Modal Overlay */
    .qr-search-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding-top: 120px;
        z-index: 2000;
    }
    
    .qr-search-overlay.active {
        display: flex;
    }
    
    .qr-search-modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }
    
    .qr-search-input {
        width: 100%;
        padding: 18px 20px;
        font-size: 18px;
        border: none;
        border-bottom: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        outline: none;
        border-radius: 12px 12px 0 0;
    }
    
    .qr-search-results {
        max-height: 400px;
        overflow-y: auto;
        padding: 12px;
    }
    
    .qr-search-result-item {
        padding: 14px 16px;
        margin-bottom: 8px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .qr-search-result-item:hover {
        background: var(--accent);
        color: #fff;
        transform: translateY(-2px);
    }
    
    .qr-search-result-reg {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 4px;
    }
    
    .qr-search-result-details {
        font-size: 13px;
        opacity: 0.8;
    }
    
    .qr-search-hint {
        padding: 20px;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
    }

    /* Slide Panel CSS */
    .slide-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        min-height: 320px;
        background: var(--card);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        padding: 20px 24px;
        transform: translateY(calc(-100% - 40px));
        transition: transform 0.4s ease;
        z-index: 1000;
        color: var(--text);
        border-bottom: 1px solid var(--border);
    }
    
    .panel-visible {
        transform: translateY(0);
    }
    
    .panel-title {
        font-size: 20px;
        color: var(--accent);
        font-weight: bold;
    }
    
    .form-row {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }
    
    .slide-panel input,
    .slide-panel textarea,
    .slide-panel select {
        padding: 10px;
        flex: 1;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        background: var(--bg);
        color: var(--text);
    }
    
    .submit-btn {
        padding: 10px 16px;
        background: var(--accent);
        color: #fff;
        border-radius: 6px;
        margin-top: 12px;
        cursor: pointer;
        text-align: center;
        font-weight: bold;
    }
    
    .connection-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        margin-right: 8px;
    }
    
    .connection-status.disconnected {
        background: var(--danger);
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Navigation */
    .main-nav {
        background: #1e3a5f;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid var(--border);
    }
    
    .main-nav a {
        color: #e2e8f0;
        text-decoration: none;
        padding: 14px 24px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.2s;
    }
    
    .main-nav a:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .main-nav a.active {
        background: rgba(255,255,255,0.15);
        color: #fff;
    }
    
    .nav-divider {
        color: #64748b;
        font-size: 18px;
        user-select: none;
    }
</style>
</head>

<body>
    <!-- ADD PANEL -->
    <div id="addPanel" class="slide-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div class="panel-title">Add New Lorry</div>
            <button onclick="togglePanel()" style="background: none; border: none; color: var(--text); font-size: 28px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>
        
        <div class="form-row">
            <input type="text" id="regInput" placeholder="Registration *">
            <input type="text" id="poInput" placeholder="PO / Reference">
        </div>
        
        <div class="form-row">
            <input type="text" id="haulierInput" placeholder="Haulier / Account" style="width:100%;">
        </div>
        
        <div class="form-row">
            <input type="text" id="mobileInput" placeholder="Mobile Number">
            <select id="quotedInput">
                <option value="30">30 mins</option>
                <option value="45">45 mins</option>
                <option value="60" selected>60 mins</option>
                <option value="90">90 mins</option>
                <option value="120">120 mins</option>
            </select>
        </div>
        <div class="form-row">
            <textarea id="notesInput" placeholder="Notes" style="width:100%;height:80px;"></textarea>
        </div>
        <div class="form-row">
            <label style="color:var(--text);">
                <input type="checkbox" id="addExport" style="margin-right:6px;">
                Export Load
            </label>
        </div>
        <div class="submit-btn" onclick="submitVehicle()">Submit</div>
    </div>
    
    <!-- QR Search Modal -->
    <div id="qrSearchOverlay" class="qr-search-overlay">
        <div class="qr-search-modal">
            <input 
                type="text" 
                id="qrSearchInput" 
                class="qr-search-input" 
                placeholder="Search by registration or PO..." 
                autofocus
            />
            <div id="qrSearchResults" class="qr-search-results"></div>
        </div>
    </div>

    <header>
        <div class="header-left">
            <span class="connection-status" id="connectionStatus" title="Realtime connection"></span>
            Gatehouse Dashboard
        </div>
        <div id="clock" class="header-clock">--:--</div>
        <div class="header-right">
            <button class="add-btn" onclick="togglePanel()">Add Lorry</button>
            <button id="qrBtn" style="padding:8px 16px;font-size:14px;background:var(--purple);color:#fff;border:none;border-radius:4px;" onclick="revealQR()">&#9635; Reveal QR</button>
            <div style="position: relative;">
                <div id="avatarBtn">??</div>
                
                <!-- THEME SWITCHER MENU -->
                <div id="avatarMenu">
                    <div id="menuName" style="border-bottom:1px solid var(--border); margin-bottom:5px;">Loading</div>
                    
                    <div style="font-size:12px; color:var(--muted); padding: 4px 12px;">Appearance</div>
                    <div onclick="setTheme('light')" style="display:flex; justify-content:space-between;">
                        <span>&#9728; Light</span>
                        <span id="check-light" style="display:none;">&#10003;</span>
                    </div>
                    <div onclick="setTheme('dark')" style="display:flex; justify-content:space-between;">
                        <span>&#9790; Dark</span>
                        <span id="check-dark" style="display:none;">&#10003;</span>
                    </div>
                    <hr style="border:0; border-top:1px solid var(--border); margin:4px 0;">
                    
                    <div onclick="logoutUser()">Logout</div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- INDEX.HTML NAV (QUEUE is active) -->
    <nav class="main-nav">
        <a href="arrivals.html">ARRIVALS</a>
        <span class="nav-divider">|</span>
        <a href="index.html" class="active">QUEUE</a>
        <span class="nav-divider">|</span>
        <a href="supervisor.html">SUPERVISOR</a>
        <span class="nav-divider">|</span>
        <a href="report.html">REPORTS</a>
    </nav>
    
    <div class="stats">
        <div class="tile">
            <div class="value" id="kpiTotalIn">0</div>
            Checked In
        </div>
        <div class="tile">
            <div class="value" id="kpiTotalOut">0</div>
            Released Today
        </div>
        <div class="tile">
            <div class="value" id="kpiAvgWait">0</div>
            Avg Wait (m)
        </div>
        <div class="tile">
            <div class="value" id="kpiOverdue">0</div>
            Overdue >30m
        </div>
    </div>
    
    <div class="grid">
        <div class="queue">
            <h2>Active Queue</h2>
            <div id="queueList">Loading...</div>
        </div>
        <div class="details">
            <h2>Recent Activity</h2>
            <div id="activityList">Loading...</div>
        </div>
    </div>
    
    <canvas id="chartTrend" style="max-width:600px;height:240px;max-height:240px;margin:0 auto 24px;display:block;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // ============================================
    // SESSION CHECK - Redirect if not logged in
    // ============================================
    (function checkSession() {
        const token = localStorage.getItem('session_token');
        if (!token) {
            window.location.href = 'login.html';
        }
    })();

    // Helper to get session token
    function getToken() {
        return localStorage.getItem('session_token');
    }

    const db = supabase.createClient(
        "https://gtixdparpjdpyhhubsfz.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aXhkcGFycGpkcHloaHVic2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MDUxNDksImV4cCI6MjA3ODk4MTE0OX0.jQdd18hGPESpDi7IvXWBZK0_bDy4-DKoSGHtZZpxAP0"
    );

    let vehicles = [];
    let operators = [];
    let logs = [];
    let chart;
    let refreshTimeout = null;
    let vehicleCache = {};

    (function loadCachedOperators() {
        try {
            const cached = localStorage.getItem('operators_cache');
            if (cached) operators = JSON.parse(cached);
        } catch (e) {}
    })();

    // PARALLEL FETCH - ALL DATA LOADS SIMULTANEOUSLY
    async function fetchAllData() {
        const token = getToken();
        
        // Execute all fetches in parallel using Promise.all
        const [statsResult, vehiclesResult, logsResult, operatorsResult] = await Promise.all([
            // 1. SECURE RPC for stats
            db.rpc('get_dashboard_stats_secure', { session_token: token }),
            
            // 2. SECURE RPC for vehicles
            db.rpc('get_vehicles_secure', { session_token: token }),
            
            // 3. Recent logs (48hr)
            db.from('actions_log')
                .select('*')
                .gte('timestamp', new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString())
                .order('timestamp', { ascending: false })
                .limit(20),
            
            // 4. Operators - ALWAYS fetch fresh (multi-user fix)
            db.from('operators').select('id, name').eq('active', true)
        ]);

        // Handle stats result
        if (statsResult.data && statsResult.data.success) {
            updateKPIsFromRPC(statsResult.data);
        } else if (statsResult.error) {
            console.error('Stats error:', statsResult.error);
            if (statsResult.data && statsResult.data.error === 'Invalid session') {
                logoutUser();
                return;
            }
        }

        // Handle vehicles result
        if (vehiclesResult.data && vehiclesResult.data.success) {
            vehicles = vehiclesResult.data.data || [];
            renderQueue();
            loadChart();
        } else if (vehiclesResult.error) {
            console.error('Vehicles error:', vehiclesResult.error);
        }

        if (logsResult.data) {
            logs = logsResult.data;
            
            // Prefetch missing vehicle details
            const missingIds = logs
                .map(l => l.vehicle_id)
                .filter(id => id && !vehicles.find(v => v.id === id) && !vehicleCache[id]);
            
            if (missingIds.length > 0) {
                const { data: missingVehicles } = await db
                    .from('vehicles')
                    .select('id, registration, po_ref')
                    .in('id', [...new Set(missingIds)]);
                
                if (missingVehicles) {
                    missingVehicles.forEach(v => {
                        vehicleCache[v.id] = v;
                    });
                }
            }
            
            renderActivity();
        }

        // Always refresh operators (multi-user fix)
        if (operatorsResult.data) {
            operators = operatorsResult.data;
            try {
                localStorage.setItem('operators_cache', JSON.stringify(operators));
            } catch (e) {}
        }
    }

    // Update KPIs from RPC response
    function updateKPIsFromRPC(stats) {
        document.getElementById('kpiTotalIn').textContent = stats.in_yard || 0;
        document.getElementById('kpiTotalOut').textContent = stats.released_today || 0;
        document.getElementById('kpiAvgWait').textContent = stats.avg_wait_mins || 0;
        document.getElementById('kpiOverdue').textContent = stats.overdue_count || 0;
    }

    function setupRealtime() {
        const statusEl = document.getElementById('connectionStatus');
        
        db.channel('vehicles-changes')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'vehicles' },
                (payload) => {
                    console.log('Vehicle change:', payload.eventType);
                    debouncedRefresh();
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    statusEl.classList.remove('disconnected');
                    statusEl.title = 'Connected - Live updates';
                } else {
                    statusEl.classList.add('disconnected');
                    statusEl.title = 'Disconnected - Reconnecting';
                }
            });

        db.channel('logs-changes')
            .on('postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'actions_log' },
                (payload) => {
                    console.log('New log entry');
                    debouncedRefresh();
                }
            )
            .subscribe();
    }

    function debouncedRefresh() {
        if (refreshTimeout) clearTimeout(refreshTimeout);
        refreshTimeout = setTimeout(() => {
            fetchAllData();
        }, 500);
    }

    function renderQueue() {
        const container = document.getElementById('queueList');
        container.innerHTML = '';
        
        if (!vehicles || vehicles.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px;">No vehicles in queue</div>';
            return;
        }
        
        vehicles.forEach(v => {
            const li = document.createElement('div');
            const now = Date.now();
            const dueTime = new Date(v.due_time).getTime();
            const minsLate = Math.floor((now - dueTime) / 60000);
            
            let cls = '';
            if (minsLate > 0) cls = minsLate > 90 ? 'critical' : 'overdue';
            
            const isExport = v.classification === 'export';
            li.className = `entry ${cls} ${isExport ? 'queue-export' : ''}`;
            li.onclick = () => openEditModal(v.id);
            
            li.innerHTML = `
                <div class="info">
                    <strong>${v.registration || '-'}</strong> - ${v.status}<br>
                    PO: ${v.po_ref || '-'} | Mobile: ${v.mobile_number || v.pager_number || '-'}<br>
                    In: ${new Date(v.check_in_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})} | Due: ${v.due_time ? new Date(v.due_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : '-'}
                </div>
                <div class="actions">
                    <button class="notify" onclick="event.stopPropagation(); notify('${v.id}')">Notify</button>
                    <button class="release" onclick="event.stopPropagation(); release('${v.id}')">Release</button>
                    <button class="undo" onclick="event.stopPropagation(); undo('${v.id}')">Undo</button>
                </div>
            `;
            container.appendChild(li);
        });
    }

    function renderActivity() {
        const container = document.getElementById('activityList');
        container.innerHTML = '';
        
        if (logs.length === 0) {
            container.innerHTML = '<div style="color:var(--muted);">No recent activity</div>';
            return;
        }
        
        logs.forEach(l => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            
            const veh = vehicles.find(v => v.id === l.vehicle_id) || vehicleCache[l.vehicle_id] || {};
            const reg = veh.registration || '';
            const po = veh.po_ref || '';
            
            const op = operators.find(o => o.id === l.operator_id) || {};
            const name = op.name || 'Unknown';
            
            let actionVerb = '';
            switch(l.action) {
                case 'check_in': actionVerb = 'checked in'; break;
                case 'notified': actionVerb = 'notified'; break;
                case 'released': actionVerb = 'completed'; break;
                case 'undo': actionVerb = 'reverted'; break;
                case 'edit': actionVerb = 'edited'; break;
                default: actionVerb = l.action; break;
            }
            
            const dt = new Date(l.timestamp);
            const timeStr = dt.toLocaleString('en-GB', { 
                day:'2-digit', month:'2-digit', 
                hour:'2-digit', minute:'2-digit', second:'2-digit' 
            });
            
            item.textContent = `${reg} ${po} ${actionVerb} by ${name} - ${timeStr}`.trim();
            container.appendChild(item);
        });
    }

    function loadChart() {
        const ctx = document.getElementById('chartTrend').getContext('2d');
        const hours = [];
        const counts = [];
        const now = new Date();
        
        for (let i = 0; i < 12; i++) {
            const h = new Date(now.getTime() - (11 - i) * 60 * 60 * 1000);
            const label = h.getHours().toString().padStart(2, '0') + ':00';
            hours.push(label);
            
            const count = vehicles.filter(v => {
                const ci = new Date(v.check_in_time);
                return ci.getHours() === h.getHours() && 
                       ci.toDateString() === h.toDateString();
            }).length;
            counts.push(count);
        }
        
        if (chart) chart.destroy();
        
        const computedStyles = getComputedStyle(document.documentElement);
        const accent = computedStyles.getPropertyValue('--accent').trim() || '#0ea5e9';
        
        chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: hours, 
                datasets: [{ 
                    label: 'Active vehicles by check-in hour', 
                    data: counts, 
                    borderColor: accent, 
                    backgroundColor: accent + '33', 
                    borderWidth: 2, 
                    tension: 0.3 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { y: { beginAtZero: true } } 
            }
        });
    }

    // SECURE NOTIFY using RPC
    async function notify(id) {
        const token = getToken();
        
        // Get vehicle data first for SMS (from local cache)
        const vehicle = vehicles.find(v => v.id === id);
        const phone = vehicle?.mobile_number || 'N/A';
        const po = vehicle?.po_ref || 'N/A';
        
        // Use secure RPC
        const { data, error } = await db.rpc('update_vehicle_status', {
            session_token: token,
            p_vehicle_id: id,
            p_new_status: 'notified'
        });
        
        if (error) {
            console.error('Notify error:', error);
            alert('Failed to notify: ' + error.message);
            return;
        }
        
        if (data && !data.success) {
            alert('Failed to notify: ' + data.error);
            if (data.error === 'Invalid session') logoutUser();
            return;
        }

        // Open SMS simulator if phone number exists
        if (phone && phone !== 'N/A') {
            window.open(`sms_simulator.html?type=notified&phone=${encodeURIComponent(phone)}&po=${encodeURIComponent(po)}`,
                "_blank",
                "width=400,height=700");
        }

        fetchAllData();
    }

    // SECURE RELEASE using RPC
    async function release(id) {
        const token = getToken();
        
        // Get vehicle data first for SMS (from local cache)
        const vehicle = vehicles.find(v => v.id === id);
        const phone = vehicle?.mobile_number || 'N/A';
        const po = vehicle?.po_ref || 'N/A';
        const checkIn = vehicle ? new Date(vehicle.check_in_time) : new Date();
        const duration = Math.floor((Date.now() - checkIn) / 60000);
        
        // Use secure RPC
        const { data, error } = await db.rpc('update_vehicle_status', {
            session_token: token,
            p_vehicle_id: id,
            p_new_status: 'released'
        });
        
        if (error) {
            console.error('Release error:', error);
            alert('Failed to release: ' + error.message);
            return;
        }
        
        if (data && !data.success) {
            alert('Failed to release: ' + data.error);
            if (data.error === 'Invalid session') logoutUser();
            return;
        }

        // Open SMS simulator if phone number exists
        if (phone && phone !== 'N/A') {
            window.open(`sms_simulator.html?type=released&phone=${encodeURIComponent(phone)}&po=${encodeURIComponent(po)}&duration=${duration} mins`,
                "_blank",
                "width=400,height=700");
        }

        fetchAllData();
    }

    // SECURE UNDO using RPC
    async function undo(id) {
        const token = getToken();
        
        // Use secure RPC
        const { data, error } = await db.rpc('update_vehicle_status', {
            session_token: token,
            p_vehicle_id: id,
            p_new_status: 'parked'
        });
        
        if (error) {
            console.error('Undo error:', error);
            alert('Failed to undo: ' + error.message);
            return;
        }
        
        if (data && !data.success) {
            alert('Failed to undo: ' + data.error);
            if (data.error === 'Invalid session') logoutUser();
            return;
        }

        fetchAllData();
    }

    function togglePanel() {
        const panel = document.getElementById('addPanel');
        if (!panel) return;
        panel.classList.toggle('panel-visible');
    }

    // SECURE CHECK-IN using RPC
    async function submitVehicle() {
        const btn = document.querySelector('#addPanel .submit-btn');
        if (!btn) return;
        
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.6';

        let reg = document.getElementById('regInput').value.trim().replace(/\s+/g, '').toUpperCase();
        let po = document.getElementById('poInput').value.trim();
        let haulier = document.getElementById('haulierInput').value.trim();
        let mobileInput = document.getElementById('mobileInput').value.trim();
        let mobile = mobileInput === '' ? null : mobileInput;
        let notes = document.getElementById('notesInput').value.trim();
        let quoted = parseInt(document.getElementById('quotedInput').value, 10);

        if (!reg) {
            alert('Registration required');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            return;
        }

        const isExport = document.getElementById('addExport').checked;
        const token = getToken();

        try {
            // Use secure RPC for check-in
            const { data, error } = await db.rpc('checkin_vehicle', {
                session_token: token,
                p_registration: reg,
                p_po_ref: po || null,
                p_haulier: haulier || null,
                p_mobile: mobile,
                p_notes: notes || null,
                p_quoted_minutes: quoted,
                p_classification: isExport ? 'export' : 'normal'
            });
            
            if (error) {
                alert('Error: ' + error.message);
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                return;
            }
            
            if (data && !data.success) {
                alert('Error: ' + data.error);
                if (data.error === 'Invalid session') logoutUser();
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                return;
            }
            
            const vehicleId = data.vehicle_id;
            window.open(`qr-screen.html?uid=${vehicleId}`, "_blank");
            
            if (mobile) {
                window.open(
                    `sms_simulator.html?type=check_in&phone=${encodeURIComponent(mobile)}&po=${encodeURIComponent(po || 'N/A')}&quoted=${quoted}`,
                    "_blank",
                    "width=400,height=700"
                );
            }
            
            await fetchAllData();
            
            togglePanel();
            document.getElementById('regInput').value = '';
            document.getElementById('poInput').value = '';
            const hInp = document.getElementById('haulierInput');
            if (hInp) hInp.value = '';
            const mInp = document.getElementById('mobileInput');
            if (mInp) mInp.value = '';
            document.getElementById('notesInput').value = '';
            document.getElementById('quotedInput').value = '60';
            document.getElementById('addExport').checked = false;
        } finally {
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        }
    }

    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', minute: '2-digit', second: '2-digit' 
        });
        const clk = document.getElementById('clock');
        if (clk) clk.textContent = timeStr;
    }

    function logoutUser() {
        localStorage.removeItem('session_token');
        localStorage.removeItem('operator_id');
        localStorage.removeItem('operator_name');
        localStorage.removeItem('operator_role');
        window.location.href = 'login.html';
    }

    // ============================================
    // QR SEARCH FUNCTIONS
    // ============================================
    function revealQR() {
        const overlay = document.getElementById('qrSearchOverlay');
        const input = document.getElementById('qrSearchInput');
        const results = document.getElementById('qrSearchResults');
        
        overlay.classList.add('active');
        input.value = '';
        input.focus();
        results.innerHTML = '<div class="qr-search-hint">Type at least 2 characters to search...</div>';
    }
    
    function closeQRSearch() {
        const overlay = document.getElementById('qrSearchOverlay');
        overlay.classList.remove('active');
    }
    
    function openQRForVehicle(vehicleId) {
        window.open(`qr-screen.html?uid=${vehicleId}`, "_blank");
        closeQRSearch();
    }
    
    // QR Search input handler
    async function handleQRSearch(query) {
        const results = document.getElementById('qrSearchResults');
        
        if (query.length < 2) {
            results.innerHTML = '<div class="qr-search-hint">Type at least 2 characters to search...</div>';
            return;
        }
        
        const q = query.toUpperCase();
        
        // Search by registration first
        let { data: matches } = await db.from('vehicles')
            .select('*')
            .ilike('registration', `%${q}%`)
            .order('check_in_time', { ascending: false });
        
        // If no results, try PO search
        if (!matches || matches.length === 0) {
            const { data: poMatches } = await db.from('vehicles')
                .select('*')
                .ilike('po_ref', `%${q}%`)
                .order('check_in_time', { ascending: false });
            matches = poMatches;
        }
        
        if (!matches || matches.length === 0) {
            results.innerHTML = '<div class="qr-search-hint">No vehicles found matching "' + query + '"</div>';
            return;
        }
        
        // Render results
        let html = '';
        matches.forEach(v => {
            const statusBadge = getStatusBadge(v.status);
            html += `
                <div class="qr-search-result-item" onclick="openQRForVehicle('${v.id}')">
                    <div class="qr-search-result-reg">${v.registration} ${statusBadge}</div>
                    <div class="qr-search-result-details">
                        PO: ${v.po_ref || '-'} | Mobile: ${v.mobile_number || v.pager_number || '-'}
                    </div>
                </div>
            `;
        });
        results.innerHTML = html;
    }
    
    function getStatusBadge(status) {
        const badges = {
            'parked': '<span style="background:var(--success);color:#000;padding:2px 8px;border-radius:4px;font-size:11px;">PARKED</span>',
            'notified': '<span style="background:var(--warn);color:#000;padding:2px 8px;border-radius:4px;font-size:11px;">NOTIFIED</span>',
            'released': '<span style="background:var(--muted);color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">RELEASED</span>'
        };
        return badges[status] || '';
    }

    document.addEventListener('click', (e) => {
        const btn = document.getElementById('avatarBtn');
        const menu = document.getElementById('avatarMenu');
        if (!btn || !menu) return;
        if (btn.contains(e.target)) {
            menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
        } else if (!menu.contains(e.target)) {
            menu.style.display = 'none';
        }
    });

    // QR Search Event Listeners
    document.getElementById('qrSearchInput').addEventListener('input', (e) => {
        handleQRSearch(e.target.value.trim());
    });
    
    // Close QR search on ESC key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const overlay = document.getElementById('qrSearchOverlay');
            if (overlay && overlay.classList.contains('active')) {
                closeQRSearch();
            }
        }
    });
    
    // Close QR search on click outside
    document.getElementById('qrSearchOverlay').addEventListener('click', (e) => {
        if (e.target.id === 'qrSearchOverlay') {
            closeQRSearch();
        }
    });

    // Load operator name from localStorage (set during login)
    (function loadOperatorDisplay() {
        const opName = localStorage.getItem('operator_name') || 'Unknown';
        const menuName = document.getElementById('menuName');
        const avatarBtn = document.getElementById('avatarBtn');
        
        if (menuName) menuName.textContent = opName;
        if (avatarBtn) {
            const initials = opName.split(' ').map(x => (x[0] || '').toUpperCase()).join('').slice(0, 2);
            avatarBtn.textContent = initials || '??';
        }
    })();

    let currentEditId = null;
    
    function openEditModal(id) {
        const veh = vehicles.find(v => v.id === id);
        if (!veh) return;
        currentEditId = id;
        
        document.getElementById('editReg').value = veh.registration || '';
        document.getElementById('editPO').value = veh.po_ref || '';
        const editMobile = document.getElementById('editMobile');
        if (editMobile) editMobile.value = veh.mobile_number || veh.pager_number || '';
        document.getElementById('editNotes').value = veh.notes || '';
        document.getElementById('editModalOverlay').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModalOverlay').style.display = 'none';
        currentEditId = null;
    }

    // NOTE: Edit still uses direct query - will need secure RPC later
    async function saveEditModal() {
        if (!currentEditId) { closeEditModal(); return; }
        
        const regVal = document.getElementById('editReg').value.trim().toUpperCase();
        const poVal = document.getElementById('editPO').value.trim();
        const mobileVal = document.getElementById('editMobile').value.trim();
        const notesVal = document.getElementById('editNotes').value.trim();
        const operatorId = localStorage.getItem('operator_id') || null;
        
        const updates = {
            registration: regVal,
            po_ref: poVal || null,
            mobile_number: mobileVal === '' ? null : mobileVal,
            notes: notesVal || null,
            operator_id: operatorId
        };
        
        try {
            // TODO: Replace with secure RPC once created
            const { error } = await db.from('vehicles').update(updates).eq('id', currentEditId);
            if (error) {
                alert('Error updating record: ' + error.message);
                return;
            }
            
            const nowIso = new Date().toISOString();
            await db.from('actions_log').insert({
                vehicle_id: currentEditId,
                action: 'edit',
                timestamp: nowIso,
                operator_id: operatorId
            });
            
            await fetchAllData();
            closeEditModal();
        } catch (err) {
            console.error('Edit save failed:', err);
            alert('Failed to save changes');
        }
    }
    
    // ============================================
    // INCOMING BOOKING (FROM ARRIVALS)
    // ============================================
    function checkIncomingBooking() {
        const params = new URLSearchParams(window.location.search);
        
        if (params.has('ref')) {
            const panel = document.getElementById('addPanel');
            panel.classList.add('panel-visible');
            
            // Map Incoming Params
            document.getElementById('poInput').value = params.get('ref');
            
            const haulierBox = document.getElementById('haulierInput');
            if (haulierBox) haulierBox.value = params.get('customer') || '';
            
            // Build rich notes from params
            let notes = `Booking: #${params.get('ref')}`;
            if (params.get('orders')) notes += `\nOrders: ${params.get('orders')}`;
            if (params.get('pallets')) notes += `\nExpected Pallets: ${params.get('pallets')}`;
            if (params.get('meds') === 'true') notes += `\n*** CONTAINS MEDS ***`;
            
            document.getElementById('notesInput').value = notes;
            
            // Auto-focus on registration
            setTimeout(() => {
                document.getElementById('regInput').focus();
            }, 500);
            
            // Clear URL so refreshing doesn't re-open
            window.history.replaceState({}, document.title, "index.html");
        }
    }

    // ============================================
    // THEME SWITCHER LOGIC
    // ============================================
    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('theme', themeName);
        
        const lightCheck = document.getElementById('check-light');
        const darkCheck = document.getElementById('check-dark');
        
        if(lightCheck) lightCheck.style.display = (themeName === 'light') ? 'block' : 'none';
        if(darkCheck) darkCheck.style.display = (themeName === 'dark') ? 'block' : 'none';
    }

    (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
    })();

    (async function init() {
        updateClock();
        setInterval(updateClock, 1000);
        
        await fetchAllData();
        checkIncomingBooking();
        setupRealtime();
        
        setInterval(() => {
            fetchAllData();
        }, 60000);
    })();
    </script>

    <div id="editModalOverlay">
        <div id="editModal">
            <h3 style="margin-top:0; margin-bottom:8px; font-size:20px; color: var(--accent);">Edit Vehicle</h3>
            <div style="margin-bottom: 20px;">
                <label for="editReg">Registration</label>
                <input type="text" id="editReg">
                <label for="editPO">PO / Reference</label>
                <input type="text" id="editPO">
                <label for="editMobile">Mobile Number</label>
                <input type="text" id="editMobile">
                <label for="editNotes">Notes</label>
                <textarea id="editNotes"></textarea>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveEditModal()">Save</button>
            </div>
        </div>
    </div>
</body>
</html>